<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yuanwanli1995.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="等不是办法，干才有出路">
<meta property="og:type" content="website">
<meta property="og:title" content="brisk">
<meta property="og:url" content="http://yuanwanli1995.github.io/index.html">
<meta property="og:site_name" content="brisk">
<meta property="og:description" content="等不是办法，干才有出路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yuanwanli">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yuanwanli1995.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>brisk</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">brisk</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yuanwanli</p>
  <div class="site-description" itemprop="description">等不是办法，干才有出路</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/10/12/2021-10-12-k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2helm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/12/2021-10-12-k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2helm/" class="post-title-link" itemprop="url">k8s集群部署helm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-10-12 00:00:00 / 修改时间：18:23:40" itemprop="dateCreated datePublished" datetime="2021-10-12T00:00:00+08:00">2021-10-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>安装helm </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf helm-v2.16.6-linux-amd64.tar.gz</span><br><span class="line"> mv linux-amd64/helm /usr/local/bin/</span><br><span class="line">helm version #查看helm client版本</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; rbac-config.yaml &lt;&lt; EOF </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: tiller</span><br><span class="line">    namespace: kube-system</span><br><span class="line">EOF </span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rbac-config.yaml</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 阿里源</span><br><span class="line">helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.6 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/10/11/2021-10-11-RKE%E9%83%A8%E7%BD%B2K8S/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/11/2021-10-11-RKE%E9%83%A8%E7%BD%B2K8S/" class="post-title-link" itemprop="url">RKE部署K8S</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-11 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-11T00:00:00+08:00">2021-10-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-10-12 18:22:23" itemprop="dateModified" datetime="2021-10-12T18:22:23+08:00">2021-10-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1  准备工作"></a>1  准备工作</h2><h3 id="1-1-集群配置"><a href="#1-1-集群配置" class="headerlink" title="1.1 集群配置"></a>1.1 集群配置</h3><p>三台服务器, 两台master主机， 一台worker的高可用集群。</p>
<table>
<thead>
<tr>
<th>主机IP</th>
<th>主机名</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>1.117.61.155</td>
<td>k8s-node01</td>
<td>controlplane,etcd</td>
</tr>
<tr>
<td>81.68.101.212</td>
<td>k8s-node02</td>
<td>controlplane,etcd,worker</td>
</tr>
<tr>
<td>81.68.229.215</td>
<td>k8s-node03</td>
<td>controlplane,etcd,worker</td>
</tr>
</tbody></table>
<blockquote>
<p> 分开买的腾讯云服务器，所以ip地址不连续</p>
</blockquote>
<h3 id="1-2-修改主机名-所有节点操作"><a href="#1-2-修改主机名-所有节点操作" class="headerlink" title="1.2 修改主机名  ( 所有节点操作 )"></a>1.2 修改主机名  ( 所有节点操作 )</h3><p>master:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-node01</span><br></pre></td></tr></table></figure>

<p>node1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-node02</span><br></pre></td></tr></table></figure>

<p>node2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-node03</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果命令失败， 直接修改 /etc/hostname, 重启后生效  </p>
<p>hostname # 可查看是否修改成功</p>
</blockquote>
<h3 id="1-3-安装一些常用工具"><a href="#1-3-安装一些常用工具" class="headerlink" title="1.3 安装一些常用工具"></a>1.3 安装一些常用工具</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install lrzsz vim gcc glibc openssl openssl-devel net-tools wget curl</span><br></pre></td></tr></table></figure>

<h3 id="1-4-关闭防火强-所有节点操作"><a href="#1-4-关闭防火强-所有节点操作" class="headerlink" title="1.4 关闭防火强 ( 所有节点操作 )"></a>1.4 关闭防火强 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有节点相同操作可使用同时发送到所有会话</p>
</blockquote>
<h3 id="1-5-关闭selinux-所有节点操作"><a href="#1-5-关闭selinux-所有节点操作" class="headerlink" title="1.5 关闭selinux ( 所有节点操作 )"></a>1.5 关闭selinux ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 # 临时关闭</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config # 永久关闭</span><br></pre></td></tr></table></figure>

<h3 id="1-6-关闭swap-所有节点操作"><a href="#1-6-关闭swap-所有节点操作" class="headerlink" title="1.6 关闭swap ( 所有节点操作 )"></a>1.6 关闭swap ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a # 临时关闭；关闭swap主要是为了性能考虑</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>

<blockquote>
<p>free # 可以通过这个命令查看swap是否关闭了 </p>
</blockquote>
<h3 id="1-7-同步时间-所有节点操作"><a href="#1-7-同步时间-所有节点操作" class="headerlink" title="1.7 同步时间 ( 所有节点操作 )"></a>1.7 同步时间 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h3 id="1-8-将桥接的IPv4流量传递到iptables的链-所有节点操作"><a href="#1-8-将桥接的IPv4流量传递到iptables的链-所有节点操作" class="headerlink" title="1.8 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )"></a>1.8 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 加载配置文件</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="1-9-添加主机名与IP对应的关系-所有节点操作"><a href="#1-9-添加主机名与IP对应的关系-所有节点操作" class="headerlink" title="1.9 添加主机名与IP对应的关系( 所有节点操作 )"></a>1.9 添加主机名与IP对应的关系( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF </span><br><span class="line">1.117.61.155  node01</span><br><span class="line">81.68.101.212 node02</span><br><span class="line">81.68.229.215 node2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="2-安装docker-所有节点操作"><a href="#2-安装docker-所有节点操作" class="headerlink" title="2 安装docker(所有节点操作)"></a>2 安装docker(所有节点操作)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 1 安装依赖工具</span><br><span class="line">  yum install -y yum-utils</span><br><span class="line"> </span><br><span class="line"># 2 配置docker仓库</span><br><span class="line"> sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">   </span><br><span class="line"># 国外的仓库很慢，可以使用国内的镜像快一点 </span><br><span class="line"> sudo yum-config-manager \</span><br><span class="line">	--add-repo \</span><br><span class="line">	http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 3 安装docker</span><br><span class="line"># sudo yum install docker-ce docker-ce-cli containerd.io</span><br><span class="line"># 3 指定版本docekr 例如 19.03.13 # 这里不能用最新版本的，经过测试，最新版本和rek2不兼容。</span><br><span class="line"> #yum install docker-ce-19.03.13  docker-ce-cli-19.03.13 </span><br><span class="line"># 4 配置腾讯云镜像 </span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;EOF</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [</span><br><span class="line">     &quot;https://mirror.ccs.tencentyun.com&quot;</span><br><span class="line">    ]</span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br><span class="line"># 5 重启启动 </span><br><span class="line">systemctl restart docker </span><br></pre></td></tr></table></figure>



<h2 id="3-rke部署集群"><a href="#3-rke部署集群" class="headerlink" title="3 rke部署集群"></a>3 rke部署集群</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 1 添加用户，rke不能用root操作(三个节点)，创建普通用户rke</span><br><span class="line">useradd rke -G docker</span><br><span class="line">echo &quot;123456&quot; | passwd --stdin rke</span><br><span class="line"></span><br><span class="line"># 2 下载 rke_linux-amd64并放到添加权限，移动到命令文件中(node1操作)</span><br><span class="line"># 下载地址 https://github.com/rancher/rke/releases/tag/v1.0.11</span><br><span class="line">chmod +x rke_linux-amd64</span><br><span class="line">mv rke_linux-amd64 /usr/local/bin/rke</span><br><span class="line"></span><br><span class="line"># 3 节点之间免密登录(node1操作)</span><br><span class="line">su - rke</span><br><span class="line">ssh-keygen # (三次enter)</span><br><span class="line">ssh-copy-id rke@1.117.61.155 # yes, 输入密码</span><br><span class="line">ssh-copy-id rke@81.68.101.212</span><br><span class="line">ssh-copy-id rke@81.68.229.215</span><br><span class="line"></span><br><span class="line"># 4 生成集群配置yml文件</span><br><span class="line">cat &gt; cluster.yml &lt;&lt; EOF</span><br><span class="line">nodes:</span><br><span class="line">    - address: 1.117.61.155</span><br><span class="line">      user: rke</span><br><span class="line">      role:</span><br><span class="line">        - controlplane</span><br><span class="line">        - etcd</span><br><span class="line">	  hostname_override: k8s-node1</span><br><span class="line">    - address: 81.68.101.212</span><br><span class="line">      user: rke</span><br><span class="line">      role:</span><br><span class="line">        - controlplane</span><br><span class="line">        - etcd</span><br><span class="line">	  hostname_override: k8s-node2</span><br><span class="line">    - address: 81.68.229.215</span><br><span class="line">      user: rke</span><br><span class="line">      role:</span><br><span class="line">        - worker</span><br><span class="line">      hostname_override: k8s-node3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 5 启动 </span><br><span class="line">rke up </span><br></pre></td></tr></table></figure>

<p>这一步可能会出现下面几个错误：</p>
<ol>
<li>​    <code>FATA[0000] Failed to parse cluster file: error unmarshalling: error converting YAML to JSON: yaml: line 6: did not find expected key </code></li>
</ol>
<p>这是因为yaml中 ： 和 - 后面必须空格， 或者要按照格式对其，按照提示的行数查看问题，然后修改就可以了 </p>
<p>(vi编辑器中 :set nu 可以显示行数)</p>
<ol start="2">
<li><code>FATA[0806] [[network] Host [81.68.101.212] is not able to connect to the following ports: [81.68.101.212:2380, 81.68.101.212:2379]. Please check network policies and firewall rules] </code></li>
</ol>
<p>这个我遇到最多的问题，按照描述是网络的问题，连接不上这两个端口，我在服务器的防火墙里开放这两个端口可以解决， 但是还会出现其他的端口无法连接，索性我添加了 开通 tcp所有端口 。就可以了 </p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/rancher3.png"></p>
<ol start="3">
<li><code> FATA[1952] Failed to get job complete status for job rke-network-plugin-deploy-job in namespace kube-system</code></li>
</ol>
<p>这个问题重新rke up 就可以解决，我也没有搞清楚是什么原因. </p>
<p>这是部署成功的提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rke up </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">INFO[0049] [addons] Saving ConfigMap for addon rke-ingress-controller to Kubernetes </span><br><span class="line">INFO[0049] [addons] Successfully saved ConfigMap for addon rke-ingress-controller to Kubernetes </span><br><span class="line">INFO[0049] [addons] Executing deploy job rke-ingress-controller </span><br><span class="line">INFO[0059] [ingress] ingress controller nginx deployed successfully </span><br><span class="line">INFO[0059] [addons] Setting up user addons              </span><br><span class="line">INFO[0059] [addons] no user addons defined              </span><br><span class="line">INFO[0059] Finished building Kubernetes cluster successfully </span><br></pre></td></tr></table></figure>

<h3 id="4-安装kubectl"><a href="#4-安装kubectl" class="headerlink" title="4  安装kubectl"></a>4  安装kubectl</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 1部署成功就可以看到集群配置的yml文件 </span><br><span class="line">[rke@node01 ~]$ ls</span><br><span class="line">cluster.rkestate  cluster.yml  kube_config_cluster.yml</span><br><span class="line"># 2 安装kubectl </span><br><span class="line">su root  </span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubectl</span><br><span class="line"></span><br><span class="line"># 3 复制kube_config_cluster.yml 到 /root/.kube/config </span><br><span class="line">mkdir -p /root/.kube/</span><br><span class="line">cp /home/rke/kube_config_cluster.yml /root/.kube/config</span><br><span class="line"></span><br><span class="line"># 4 查看集群状态 </span><br><span class="line">[root@node01 rke]# kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line">NAME          STATUS   ROLES               AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME</span><br><span class="line">k8s-master1   Ready    controlplane,etcd   10h   v1.17.9   10.0.4.6      &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.11.1.el7.x86_64   docker://19.3.13</span><br><span class="line">k8s-master2   Ready    controlplane,etcd   10h   v1.17.9   10.0.4.15     &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.11.1.el7.x86_64   docker://19.3.13</span><br><span class="line">k8s-node1     Ready    worker              10h   v1.17.9   10.0.4.16     &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.11.1.el7.x86_64   docker://19.3.13</span><br><span class="line"></span><br><span class="line"># 查看pods </span><br><span class="line">[root@node01 rke]# kubectl get pods -A</span><br><span class="line">NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">ingress-nginx   default-http-backend-67cf578fc4-pvktd     1/1     Running     0          5h37m</span><br><span class="line">ingress-nginx   nginx-ingress-controller-s7fcj            1/1     Running     0          5h37m</span><br><span class="line">kube-system     canal-4pc9k                               2/2     Running     0          10h</span><br><span class="line">kube-system     canal-nrpvx                               2/2     Running     0          10h</span><br><span class="line">kube-system     canal-vmqq9                               2/2     Running     0          10h</span><br><span class="line">kube-system     coredns-7c5566588d-j6xpw                  1/1     Running     0          5h37m</span><br><span class="line">kube-system     coredns-autoscaler-65bfc8d47d-2sg8d       1/1     Running     0          5h37m</span><br><span class="line">kube-system     metrics-server-6b55c64f86-g56ww           1/1     Running     0          5h37m</span><br><span class="line">kube-system     rke-coredns-addon-deploy-job-fss2d        0/1     Completed   0          5h37m</span><br><span class="line">kube-system     rke-ingress-controller-deploy-job-vnjcl   0/1     Completed   0          5h37m</span><br><span class="line">kube-system     rke-metrics-addon-deploy-job-8kj9x        0/1     Completed   0          5h37m</span><br><span class="line">kube-system     rke-network-plugin-deploy-job-bjnvh       0/1     Completed   0          10h</span><br></pre></td></tr></table></figure>



<h3 id="5-测试一下，起个nginx服务"><a href="#5-测试一下，起个nginx服务" class="headerlink" title="5 测试一下，起个nginx服务"></a>5 测试一下，起个nginx服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 1 YML文件</span><br><span class="line">cat &gt; nginx-dep.yml &lt;&lt; EOF </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:alpine</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"># 2 创建 </span><br><span class="line">kubectl apply -f nginx-dep.yml</span><br><span class="line"></span><br><span class="line"># 3 查看状态 </span><br><span class="line">kubectl get pods nginx -o wide</span><br><span class="line"># 4 启动svc,暴露端口</span><br><span class="line">cat &gt;  nginx-svc.yml &lt;&lt; EOF </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 30080</span><br><span class="line">  type: NodePort</span><br><span class="line">EOF </span><br></pre></td></tr></table></figure>

<p>访问81.68.229.215:30080</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/rancher4.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/10/11/2021-10-11-nginx%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/11/2021-10-11-nginx%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">nginx学习笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-10-11 00:00:00 / 修改时间：13:10:28" itemprop="dateCreated datePublished" datetime="2021-10-11T00:00:00+08:00">2021-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Nginx学习笔记"><a href="#Nginx学习笔记" class="headerlink" title="Nginx学习笔记"></a>Nginx学习笔记</h1><h2 id="1-什么是nginx"><a href="#1-什么是nginx" class="headerlink" title="1 什么是nginx"></a>1 什么是nginx</h2><p>Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。2011年6月1日，nginx 1.0.4发布。</p>
<p>其特点是占有内存少，并发能力强，事实上nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。在全球活跃的网站中有12.18%的使用比率，大约为2220万个网站。</p>
<p>Nginx 是一个安装非常的简单、配置文件非常简洁（还能够支持perl语法）、Bug非常少的服务。Nginx 启动特别容易，并且几乎可以做到7*24不间断运行，即使运行数个月也不需要重新启动。你还能够不间断服务的情况下进行软件版本的升级。</p>
<p>Nginx代码完全用C语言从头写成。官方数据测试表明能够支持高达 50,000 个并发连接数的响应。</p>
<h3 id="2-nginx的作用？"><a href="#2-nginx的作用？" class="headerlink" title="2 nginx的作用？"></a>2 nginx的作用？</h3><h4 id="2-1-反向代理"><a href="#2-1-反向代理" class="headerlink" title="2.1 反向代理"></a>2.1 反向代理</h4><blockquote>
<p>Http代理，反向代理：作为web服务器最常用的功能之一，尤其是反向代理。正向带来就是代理客户端，如vpn。 反向代理代理服务器端。</p>
</blockquote>
<ul>
<li>正向代理</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx1.png"></p>
<ul>
<li>反向代理</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx2.png"></p>
<h4 id="2-2-负载均衡"><a href="#2-2-负载均衡" class="headerlink" title="2.2 负载均衡"></a>2.2 负载均衡</h4><blockquote>
<p>Nginx提供的负载均衡策略有2种：内置策略和扩展策略。内置策略为轮询，加权轮询，Ip hash。扩展策略，就天马行空，只有你想不到的没有他做不到的。</p>
</blockquote>
<ul>
<li>轮询</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx3.png"></p>
<ul>
<li> 加权轮询 </li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx4.png"></p>
<ul>
<li>iphash </li>
</ul>
<p>iphash对客户端请求的ip进行hash操作，然后根据hash结果将同一个客户端ip的请求分发给同一台服务器进行处理，可以解决session不共享的问题。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx5.png"></p>
<h4 id="2-3-动静分离"><a href="#2-3-动静分离" class="headerlink" title="2.3 动静分离"></a>2.3 动静分离</h4><p>动静分离，在我们的软件开发中，有些请求是需要后台处理的，有些请求是不需要经过后台处理的（如：css、html、jpg、js等等文件），这些不需要经过后台处理的文件称为静态文件。让动态网站里的动态网页根据一定规则把不变的资源和经常变的资源区分开来，动静资源做好了拆分以后，我们就可以根据静态资源的特点将其做缓存操作。提高资源响应的速度。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx7.png"></p>
<h2 id="3-nginx安装"><a href="#3-nginx安装" class="headerlink" title="3 nginx安装"></a>3 nginx安装</h2><h4 id="3-1-windows-安装"><a href="#3-1-windows-安装" class="headerlink" title="3.1 windows 安装"></a>3.1 windows 安装</h4><ol>
<li>下载</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a> 下载稳定版本。<br>以nginx/Windows-1.16.1为例，直接下载 nginx-1.16.1.zip。<br>下载后解压，解压后如下：</p>
<ol start="2">
<li>启动nginx</li>
</ol>
<p>有很多种方法启动nginx</p>
<p>(1)直接双击nginx.exe，双击后一个黑色的弹窗一闪而过</p>
<p>(2)打开cmd命令窗口，切换到nginx解压目录下，输入命令 <code>nginx.exe</code> ，回车即可</p>
<ol start="3">
<li>检查nginx是否启动成功</li>
</ol>
<p>直接在浏览器地址栏输入网址 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost:80</a> 回车，出现以下页面说明启动成功！</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx8.png"></p>
<p>4、配置监听</p>
<p>nginx的配置文件是conf目录下的nginx.conf，默认配置的nginx监听的端口为80，如果80端口被占用可以修改为未被占用的端口即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/nginx9.png" alt="图片"></p>
<p>当我们修改了nginx的配置文件nginx.conf 时，不需要关闭nginx后重新启动nginx，只需要执行命令 <code>nginx -s reload</code> 即可让改动生效</p>
<ol start="5">
<li>关闭nginx</li>
</ol>
<p>如果使用cmd命令窗口启动nginx， 关闭cmd窗口是不能结束nginx进程的，可使用两种方法关闭nginx</p>
<p>(1)输入nginx命令 <code>nginx -s stop</code>(快速停止nginx) 或 <code>nginx -s quit</code>(完整有序的停止nginx)</p>
<p>(2)使用taskkill <code>taskkill /f /t /im nginx.exe</code></p>
<blockquote>
<ol>
<li><code>taskkill是用来终止进程的，</code></li>
<li><code>/f是强制终止 .</code></li>
<li><code>/t终止指定的进程和任何由此启动的子进程。</code></li>
<li><code>/im示指定的进程名称 .</code></li>
</ol>
</blockquote>
<h4 id="3-2-linux-安装"><a href="#3-2-linux-安装" class="headerlink" title="3.2 linux 安装"></a>3.2 linux 安装</h4><p><strong>1、安装gcc</strong></p>
<p>安装 nginx 需要先将官网下载的源码进行编译，编译依赖 gcc 环境，如果没有 gcc 环境，则需要安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc-c++</span><br></pre></td></tr></table></figure>

<p><strong>2、PCRE pcre-devel 安装</strong></p>
<p>PCRE(Perl Compatible Regular Expressions) 是一个Perl库，包括 perl 兼容的正则表达式库。nginx 的 http 模块使用 pcre 来解析正则表达式，所以需要在 linux 上安装 pcre 库，pcre-devel 是使用 pcre 开发的一个二次开发库。nginx也需要此库。命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre pcre-devel</span><br></pre></td></tr></table></figure>

<p><strong>3、zlib 安装</strong></p>
<p>zlib 库提供了很多种压缩和解压缩的方式， nginx 使用 zlib 对 http 包的内容进行 gzip ，所以需要在 Centos 上安装 zlib 库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zlib zlib-devel</span><br></pre></td></tr></table></figure>

<p><strong>4、OpenSSL 安装</strong><br>OpenSSL 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及 SSL 协议，并提供丰富的应用程序供测试或其它目的使用。<br>nginx 不仅支持 http 协议，还支持 https（即在ssl协议上传输http），所以需要在 Centos 安装 OpenSSL 库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p><strong>5、下载安装包</strong></p>
<p>手动下载.tar.gz安装包，地址：<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/GgEZetmcQNL1d9LWeKibdOWh9rKCtOIyiapbBdvkkLxbroTS7UJqVEGYMoykpNCJCd8s2J8gt5Kx1wTa20x4Fcew/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p>下载完毕上传到服务器上 /root</p>
<p><strong>6、解压</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.18.0.tar.gzcd nginx-1.18.0</span><br></pre></td></tr></table></figure>

<p><img src="https://mmbiz.qpic.cn/mmbiz_png/GgEZetmcQNL1d9LWeKibdOWh9rKCtOIyiav8kobxVCqCtT1fKwz5Sjp56Cyq2icoNOZv4D0qfBAfy6GenkzeiamZicw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<p><strong>7、配置</strong></p>
<p>使用默认配置，在nginx根目录下执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configuremakemake install</span><br></pre></td></tr></table></figure>

<p>查找安装路径： <code>whereis nginx</code></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/GgEZetmcQNL1d9LWeKibdOWh9rKCtOIyiaKiaWxd2xrGwMWWt6CETsZ7K0n23PWRZbgrmxa1qwq0075IM2IFKtHDg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片"></p>
<h3 id="4-Nginx常用命令"><a href="#4-Nginx常用命令" class="headerlink" title="4 Nginx常用命令"></a>4 Nginx常用命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin/</span><br><span class="line">./nginx  启动</span><br><span class="line">./nginx -s stop  停止</span><br><span class="line">./nginx -s quit  安全退出</span><br><span class="line">./nginx -s reload  重新加载配置文件</span><br><span class="line">ps aux|grep nginx  查看nginx进程</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：如何连接不上，检查阿里云安全组是否开放端口，或者服务器防火墙是否开放端口</p>
<p>相关命令：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 开启service firewalld start</span><br><span class="line"># 重启service firewalld restart</span><br><span class="line"># 关闭service firewalld stop</span><br><span class="line"># 查看防火墙规则firewall-cmd --list-all</span><br><span class="line"># 查询端口是否开放firewall-cmd --query-port=8080/tcp</span><br><span class="line"># 开放80端口firewall-cmd --permanent --add-port=80/tcp</span><br><span class="line"># 移除端口firewall-cmd --permanent --remove-port=8080/tcp</span><br><span class="line"># 重启防火墙(修改配置后要重启防火墙)firewall-cmd --reload</span><br><span class="line"># 参数解释1、firwall-cmd：是Linux提供的操作firewall的一个工具；2、--permanent：表示设置为持久；3、--add-port：标识添加的端口；</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/10/10/2021-10-10-%E3%80%8A%E7%BB%8F%E6%B5%8E%E5%AD%A6%E9%80%9A%E8%AF%86%E3%80%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/10/2021-10-10-%E3%80%8A%E7%BB%8F%E6%B5%8E%E5%AD%A6%E9%80%9A%E8%AF%86%E3%80%8B/" class="post-title-link" itemprop="url">《经济学通识》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-10-10 16:40:00 / 修改时间：17:03:18" itemprop="dateCreated datePublished" datetime="2021-10-10T16:40:00+08:00">2021-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="《经济学通识》"><a href="#《经济学通识》" class="headerlink" title="《经济学通识》"></a>《经济学通识》</h2><p>作者： 薛兆丰</p>
<p>摘录：</p>
<ul>
<li> 一项资产的价值，总是它未来收入的折线，而过去投入的成本是沉没成本，不论大小都不影响资产的现值。</li>
<li>以纯朴的眼光看，人类至少面临四项普遍约束：（1）东西不够；（2）生命有限；（3）互相依赖；和（4）需要协调。人类种种制度安排，一概是为了应付这些约束而衍生的。粗略地概括，这四项约束对应着四类经济理论：（1）需求定律；（2）利息理论；（3）制度理论；和（4）宏观理论。</li>
<li>读书“瘾”也是一样。没有人生来就喜欢读书。得先在“阅读理解力”上作投资。要识字、要懂文法、要自己写过、要学过天文地理，懂得人情世故，要读得多，享受才能油然而生。有些人酷爱读书，要读书才够过瘾，而有些人则只看杂志，有些人看报纸就满足了，有些人只能看懂漫画，有些人就只看电视。对“阅读理解力”的投资不同，追求享受的方式就不同。</li>
<li>科斯理论的这两个思想渊源，有三个重要的含义： 一，在解决生产资源分配时，要紧的永远是边际的数值，而不是平均或总计的数值； 二，在协调资源的争用时，要紧的是要存在私有产权； 三，只要存在私有产权，产权所有者的个数就并不重要，也就是说，不管生产要素由多少人拥有，只要他们能保持充分的理智，他们就会达致相同的生产资源分配方案。</li>
<li>增加合作，并不意味着減少竞争；要鼓励竞争，也未必要靠遏制合作来实现。我们深化对合作的理解，也就是深化了对竞争的理解。</li>
<li>第六，价格决定成本，而不是成本决定价格。价格是由对最终成品的供求决定的，决定了以后，再倒过来决定生产原料的价格。房价是完全由供求决定的，房价被供求决定后，才倒过来决定土地的拍卖价格和开发商的利润。这因果关系，是学习价格规律的难点和重点，要想个不停，才能明白。到此请重读第四点。    第七，需求旺，有原因。（1）农民进城，数以亿计，创人类纪录。（2）住房面积和质量提高，购房者的平均年龄提前。（3）人均寿命延长，退休年期增加，但养儿防老已不可能，而养老保障并不健全，购房便成了人们储蓄保值的常用手段。购房月供三千，一千实为租金，两千实为储蓄。在上述因素的推动下房价高涨实属正常，而并非个别人的阴谋。非得要说是阴谋，那么大可以清者自清，选择只租不买，自动退出购房大军。到此请重读第三点。    第八，价格规律与市场状态无关。不管中国的市场是否成熟、官商有没有勾结、政府是否廉洁、行业是否垄断</li>
<li>事实上，金融危机的症结，最重要的是银行受到了政府的操控。出于政治需要或裙带关系，银行冒险将借来的外汇转贷给经营不善的国内企业，然而到期后，这些落后的企业无法清偿借款。改变这种状况的药方，就是切断政府意志与银行贷款之间的联系，消灭政策贷款和裙带贷款，增强银行的独立性和风险意识。金融危机并不表明自由经济的机器失效了，恰恰相反，引发连串问题的症结，正在于那些违反自由经济原则的环节。 金融危机的另一个原因，是那些既有中央银行、又实施汇率管制的国家，在将借来的外汇转贷给国内企业时，以该国的本位币来记账。由于这些国家往往未能成功地抑制货币发行量，所以该国的货币一旦贬值，企业到期的还款，就无法折合成足够的外汇，进而引发债务危机。 第三个原因，是大型的私人金融机构的投资失误。如美国“长期资本管理（LTCM）”的亏蚀，致使相关的以高杠杆率放款的银行濒临破产。这些不顾风险的银行，是咎由自取的。 第四个原因，是某些地区的货币体制出现了漏洞，引致投机者兴风作浪。例如香港，在实施警花货币发行局的七项措施以前，只要大量沽出港元，就能大幅扯高港元利率。本来，忠实地执行1983年所设计的联系汇率制度，这种情况是不会发生的。国际投资者看准了这个漏洞，连番操纵香港的汇市和股市，从中获利。</li>
<li>哈耶克断言：如何协调千万人之间的行为，如何利用分散在千万人头脑中的信息，才是真正的经济学核心问题。 </li>
<li>知道此岸，也了解彼岸，改革的困难，都是过渡的困难……经济改革如果不定下“事前规则”，而靠“酌情处理”来推进，就必然阻力重重，越改越难，越改越慢。 其实，成功的经济制度，并不在于改造人们的思想，而在于激励人们的行动。 每个人的资源和时间有限，用来上产此，就不能生产彼。”顾此“的成本就是”失彼“，选择”失彼“最小的”顾此“，就是这个人的相对优势。由于这始终是自己跟自己比的结果，所以任何人都永远具有相对优势。 成本就是放弃了的最好机会。 与富人为伍，你的处境会改善。不是因为你可以仰仗他们的仁慈，而是因为你在某方面的成本必定比他们低，是因为你有颠扑不破的相对优势。他们处于自私，就会与你分工合作。 他们享受现代化成果的同时，呼吁别人选择落后。 革命的蓝图越宏伟，就越容易推延，就越是画饼充饥。</li>
<li>只要知识是增长的，那么必定有部分知识是我们明天才知道而今天不知道的，那既然社会是受我们的知识影响的，那么社会的发展就是不可预测的 </li>
<li>一个能在市场上靠其产品获利的卖家，不可能通过搭售其他产品，来获得超额利润。</li>
<li>现实有约束，愿望得取舍。这是经济学者理解世界的出发点。</li>
<li>供求”先决定最终产品的“价格”，而最终产品的“价格”再决定原材料的“成本”。 </li>
<li>但不要试图说服我，给你个基尼系数，你就有本事告诉我将会发生什么。</li>
<li>数据本身不足以说明问题，因为它至少同时支持两种对立的情况 </li>
<li>这是说，即使是同一个人，究竞是”风险爱好者”、”风险 厌恶者”还是”风险漠视者”，也与其所处的财富水平有关。 美国哲学家罗尔斯（J. Rawls) , 因”公平”而盛名远播。他 用了一个生动的比喻，来证明”公平”是先于一切”公约”的。 罗尔斯说，有人生于豪门，有人生于陋室，一切皆出偶然，只能 听天由命：但是，在投胎之前，若人们能聚首一堂，他们会达成 怎样的协议呢？罗尔斯推断，由于每个人都对自己将来的命运懷 然不知，为了规避风险，即使每个人都出于自私，他们也必定会 达成一个”公平公约”，即在出生后趋向于”均分”每个人与生 俱来的一切，因为这样能使每个人的平均幸福程度达到最大。 罗尔斯这个关于”无知之幕”(veil of ignorance) 的比喻远近 闻名。我的质疑是：即使有过那样的聚会，会上人们真会一致赞 成”公平公约”吗？答案是未必！ 因为只要他们当中有些是”风 险喜爱者”，那么后者就一定宁愿挺而走险，不会受”结果公 平”的方案。毕竞，即使在现实生活中，我们也没见过自愿买完 彩票后，又要求全部参与者平分奖金的人群。</li>
<li>按“价高者得”原则筛选出来的不是贫富，而是需求的大小</li>
<li>而人们从来就只有权衡和取舍，而没有绝对的刚需</li>
<li>人的欲望是无止境的，所以世界上的经济商品永远都是稀缺的。</li>
<li>如何协调千万人之间的行为，如何利用分散在千万人头脑中的信息，才是真正的经济学核心问题 </li>
<li>要解决问题，就必须通过市场，就必须由分立的个人并行处理他们独自拥有的信息，这样才能协调众人的行为和分散的信息</li>
<li>供求决定售价，售价决定成本</li>
<li>这个世界的任何商品，其价值都是因为有人争夺才产生的 </li>
<li>正是一国对异国资源的需求，决定了汇率</li>
<li>寻求知识是辛苦的，保持理性是吃力的 </li>
<li>“民主”是按多数原则，集体商议如何行使国家暴力，来干预人与人之间本来可以缔结的契约，本来可以进行的贸易以及本来可以保有的产业 </li>
<li>任何管制都只能改变人们竞争的方式，而无法消除竞争本身</li>
<li>经济学人应该看清一般人不容易看到的一面</li>
<li>事物的价值完全依赖于每个个人的主观判断</li>
<li>只要有人群，就存在对事物的不同估值，就会出现交易；只要有选择，就必然有机会成本；只要存在时间，就存在耐用品，就会刺激投资 </li>
<li>市场从不失灵。那并不是市场失灵，而是解释失灵。 “外部性”恰恰不是因为市场失灵，而是因为缺乏市场。不是产权失灵，而是产权缺席。 天真的发问，有时可以重塑对世情的理解。 逻辑上可能出现的“市场失灵”，恰恰就是被市场的出现而修复的。 产品的价格不是事前根据成本决定的，而是事后根据市场钞票投票的结果决定的。定价由供求决定，与成本无关。 出价太低的卖家或出价过高的买家，其谈判力强；出价太高的卖家或还价过低的买家，其谈判力弱。</li>
<li>重要的问题是：政府向地产商征税，或者向购房者征税，两者有区别吗？经济学明白无误地告诉我们：两者没有任何区别。不管政府规定税赋是向哪一方征收的，都不影响买卖双方分担税负的比例。这被戏称为“法律无效定律”（The Law of the Irrelevance of the Laws），是任何接触税务问题的经济学学生必学的内容。</li>
<li>投资和投机，从可观察的行为看，是没有区别的。</li>
<li>歧视行为的影响不是单向的，而是双向的，不仅被歧视者要受影响，歧视者本身也要受影响。</li>
<li>更直截了当地说，选择就是歧视。</li>
<li>概括一下：具体情景下的供需关系，决定了单笔交易价；无数单笔交易价累加，形成了统计学意义上的均价；时间和条件不同，均价也就不同，而想求索产品的真正“原价”只能是折腾，注定徒劳无功；真正帮助顾客享受低价的方法，不是通过“纵向原价监管”来减少单笔交易间的价格离差，而是让卖家充分竞争、形成稳定而统一的交易平台，从而让顾客通过“横向实时比价”来获得低价。</li>
<li>消费者的选择行为，是与贸易保护主义者的口号背道而驰的。贸易保护主义者总是声称，消费者需要质量更高的产品，而进口的大米有虫、进口的西红柿太小、进口的香蕉改了基因、进口的面条缺乏韧性。问题不在于他们说的是不是事实，而是他们假借消费者的名义，限制了消费者选择劣质产品的自由。</li>
<li>从经济学看，道路不是公用品（public goods），而是私用品（private goods）。所谓公用品，指的是一个人用不影响其他人用的物品。典型的例子是音乐旋律、故事情节、科学定理等。公用品既可以由政府提供，如公共电视台的节目；也可以由个人提供，如带版权的电影和书籍。 私用品，指“一个人用了别人就不能用”的物品，包括粮食、电力、用水、医疗服务、教育设施、国家公园、交通工具和公路航道等。私用品也是既可以由政府提供，也可以由个人或者私营机构提供的。关键是，不论谁提供，也不论提供者是否向使用者收费，私用品的“一个人用了别人就不能用”的属性不变。公路就是这样：尽管它很可能是政府铺设的，而政府也很可能不收费，但一条车道，一辆车用了，别的车就不能同时同地使用，所以才会发生拥堵。其他私用品，也一概如是。</li>
<li>要知道，经济学家常说交易双方是自愿的，是双赢的。这没错，但他们还说了第三句话，即交易往往会使第三方受损。经济学上所说的“帕雷托最优”状态——交易后双方得益，且没有任何第三方受损的状态——是几乎不会出现的。也就是说，任何自愿交易的背后，几乎总是能够找到一些不同程度受损害的人。</li>
<li>假设市场上存在两个互相竞争的标准或平台，分别称为方案甲和方案乙，两者都具有正的网络效应，即参与的用户越多就越具价值，其中方案甲的价值，能从2人参与时的10元上升到10人参与时的20元，而方案乙的价值，能从2人参与时的4元上升到10人参与时的34元。尽管当参与者增加到10人时，方案乙优于方案甲，但人们是否会由于方案甲的初期价值较高，而在路径依赖的作用下，被方案甲锁住而无法选择当用户数量增加后价值后来居上的方案乙呢？ 两位经济学家的回答是：取决于方案乙是否“有主”。如果方案乙是无主的，那它就会得不到推广而被放弃，而这不是“市场所造成的失败”，而是“缺乏市场所造成的失败”。反之，如果方案乙是有主的，那么其主就会设法先垫支部分未来收入，补贴方案乙的早期用户，从而推动方案乙尽快达到超越方案甲的盈利规模。在这个过程中，拥有标准或平台的产权、从而形成动力、努力预测未来收益、筹资补贴先到用户、从而扩大网络规模、提高网络增值速度等环节，恰恰是市场挣脱“路径依赖陷阱”的关键步骤。</li>
<li>唯一应该反对的垄断，就是政府设置的准入障碍和特许经营。如果解除了政府保护，市场上出现的一切似乎是垄断的竞争形态，其实就都是自由竞争的结果。</li>
<li>弗里德曼（Milton Friedman）曾经列举过四种效率递减的花钱模式：一，花自己的钱替自己办事；二，花自己的钱替别人办事；三，花别人的钱替自己办事；四，花别人的钱替别人办事。</li>
<li>经济学家阿尔钦说得准确：“竞争从来都是在需求者和需求者之间展开的，或在供应者和供应者之间展开的。需求者和供应者之间不存在竞争。”</li>
<li>1960年代，法律经济学创始人戴瑞德（Aaron Director，1901-2004）曾经发现一个规律，即任何政府针对穷人的补贴措施，最终都会让中产阶级得益，而由极穷者和极富者付账。</li>
<li>所谓“管制汇率”，就是一国通过强行控制进出口商品量和外币兑换量，把本国货币的币值，硬性维持在某个先定的价位上。……而“自主汇率”，就是一国的货币当局只盯着本国的物价水平，以维持物价稳定为原则来控制货币流通量，而让本国货币与外币的兑换率自由浮动。至于“联系汇率”，则是本国货币与某国外币按固定汇率进行兑换。</li>
<li><strong>人的思想五花八门，而人的行动却大同小异；因为前者不承受代价，后者承受代价。</strong></li>
<li>很多人并不了解罢工的真正含义。不工作是旷工，集体不工作是集体旷工，生病不工作是请假，雇主允许不工作是放假，要求加薪是劳资协议，集体要求加薪是集体协议，自己卷铺盖走人是辞工。都不是罢工。 只有通过（1）在关键时刻忽然停止工作、使得雇主临时无法找到别人替代，或（2）占着工作岗位不工作，并且设法阻止别人代替自己工作，来要挟雇主增加工资或福利的行为，才叫罢工。占着位置不干活并且不让别人代替自己干活，是罢工的基本特征。罢工就是集体敲竹杠，就是集体违约，而且必然包含暴力因素。 临时以停止工作为威胁来要求加薪，是罢工的雏形。在1902年美国的Alaska Packers’ Association v. Domenico 案中，雇主准备了渔船，雇用了渔民，从旧金山出发到阿拉斯加捕捞三文鱼。船到了目的地后，渔民们便宣布临时要求加薪，否则就停止工作，这叫罢工。同样，1965年在美国爆发了葡萄园罢工，大量的葡萄眼看就要烂掉，采摘工人集体停工并要求增加工资，这也是罢工。敲竹杠是罢工的首要特征。</li>
<li>斯密并非写了两部自相矛盾的著作，分别供市场经济的怀疑这和支持者引用。相反，他通过《道德情操论》和《国富论》构造了一个自洽体系：由于人不仅是自私的，而且还天生需要通过满足小范围的同情心来换取快感，所以不仅需要在私人领域强调爱心，而且也更需要在公众领域强调应由自私之心在看不见的手的引导下来推动公益，并强调要警惕自私的掌权者对市场机制的破坏。只有这样，才能理解斯密为什么被视为市场经济之父，而不是计划经济或福利主义之父。</li>
<li>首次为阿尔钦带来国际声誉，并为经济学科学找到了稳固的落脚点的，是在他1950年发表的《不确定性、进化和经济理论》 （Uncertainty,Evolution, and Economic Theory )一文。该文的背景很简单：当时有两位大经济学家（Richard Lester和Fritz Machlup）在争论，企业家究竟有没有在计算边际成本和边际收益。阿尔钦回答：计算与否不重要，重要的是背后主宰企业家存活的客观规律；由于存在不确定性，所以人们在逻辑上不可能求得最大化； 人们只是在争取存活；即使（或虽然）人人都是傻瓜，物竞天择的规律也仍然时刻在发挥作用。 人们总想随心所欲，但因为必须为自己的所作所为负责，所以才不得不尽量保持理性。这正是阿尔钦（Armen Alchian）在1950年的《莫测、进化和经济理论》一文的深刻主题：不管人的主观上是否有意识地追求最大化，客观上只有那些成功地达到了最大化的人或集体才能在竞争中存活。 </li>
<li>价格有三个作用，一是传递信息，二是激励最有效的生产，三是分配产品。市场上的每个人都根据价格所蕴含的信息，选择生存方式和调整生产节奏，并以社会成本最低的方式分配产品</li>
<li>世界上不存在绝对刚性的需求，人们不可能不惜任何代价地追求某个目标。 人际需求不可比原则：效用只能自己跟自己比，不能拿人与人比。 人们有追求免费服务的自由，却没有逃避付出代价的自由。</li>
<li>正是客流暴增，才导致了火车票的涨价。火车票提价的幅度是多少，取决于客流增加的幅度，而跟乘客的心理承受能力扯不上任何关系。</li>
<li>现实可能不受欢迎，甚至令人憎恶，但经济评论的任务，应该是客观地解释真实的世界，而不是给读者发送歪曲的信息，流于用一厢情愿的愿望来博取读者的欢心。</li>
<li>愿意出高价买火车票的人，他所挣得的钞票，是他在别的场合向社会其他人提供服务换来的。也就是说，他为争夺火车票而作出的努力，已经得到了社会其他人的认可。</li>
<li>多年前、老友尹忠东教了我三件事情、会我受益无穷。一，他要我讨论问题或写文章时不要用比喻；二他告诉我有一个经济学家名字叫“弗里德曼”；三，他告诉我人的言辞与行动往往是背道而驰的，说是一套，做往往是另一套；人的思想和言论可谓五花八门，但行动却是高度一致的 这第三点，是我理解人性、理解学术争论、理解市场之美的起点。要对付“不确定性”，要提高对未来的预测力，减少资源浪费或空置的现象，人类不仅需要精准的知识，还需要追求知识和信息的原始动力，而追求知识和信息，往往是昂贵而痛苦的过程，而其中的试金石，就是到市场上赌一手，因为市场会不动声色地对你的判断恰如其分的奖惩。</li>
<li>政府不再负责分配住房，大量农村人口涌入城市，城市交通网络极不发达，政府批租土地有限，而居民收入预期逐年增长，这些因素全都表明中国的住房需求不是泡沫，而是真实的、强劲的、递增的、不可能靠行政手段打压下去的</li>
<li>这是说，即使‘政府有责任’，也并不等于‘政府有能力’。政府可以轻而易举地推出各种管制措施，但这些管制措施既不能替代、也不能增加真实的供应。这是经济学教训的核心。未掌握经济学的人，往往异想天开，以为政府有多大责任就能有多大能力，于是赋予政府极大的责任，让他包办衣食住行、生老病死，结果造就了上世纪‘计划经济’的大悲剧。</li>
<li>诺贝尔经济学奖得主加里 贝克尔教授，以研究家庭、犯罪和歧视问题闻名，他给‘歧视’下了定义：只有当歧视者愿意放弃一定的利益，例如收入、利益、工资或者享受，以便满足他个人的偏好时，才是歧视。</li>
<li>那个搔首弄姿的明星，之所以赚大钱，是因为市场对她有需求。你可以讨厌她，但得承认，别的很多人喜欢她，所以她的劳动力才值钱；而不是反过来，因为她投入的成本低，所以她的表演就不值钱。培养博士和专家的成本确实很大，但他们如果去扫地，那就只能接受扫地的工资，而他们过去钻研学问的成本与此无关。如果我搬到总统套房里写专栏，那么应该提高我的稿费吗？不。 归根结底，市场的‘供需’是劳动力价格的唯一决定因素。</li>
<li>根据维基百科的定义：‘庞氏骗局就是靠投资者或后继投资者的钱来还钱，而不是靠实际盈利来还钱的运作。它通常靠别人所不能的回报来吸引新的投资者，而这些回报通常是短期还款，它要么高的不正常，要么就是持续地不正常。这种生生不息的回报需要不断增长的现金流来维持。’ …… 有别于次，庞氏骗局的特征，是举债人刻意、反复、系统地向放款人谎报其经营所得和还款来源。甄别的关键，一是举债人的还款究竟来自经营的盈利，还是新的举债；二是放贷人在做出放贷决定时，究竟是清楚了解举债人的财务运作模式，还是受到了刻意的蒙骗。</li>
<li>考试是考书上的，不要东看西看。但平时思想的时候，就要东看西看、东想西想才行。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/10/08/2021-10-08-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/08/2021-10-08-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/" class="post-title-link" itemprop="url">持续集成</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-08 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-08T00:00:00+08:00">2021-10-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-10-09 00:21:25" itemprop="dateModified" datetime="2021-10-09T00:21:25+08:00">2021-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%85%AC%E5%8F%B8%E5%9F%B9%E8%AE%AD/" itemprop="url" rel="index"><span itemprop="name">公司培训</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="应用云化部署与运维工程师学习专区"><a href="#应用云化部署与运维工程师学习专区" class="headerlink" title="应用云化部署与运维工程师学习专区"></a>应用云化部署与运维工程师学习专区</h1><h2 id="1-持续集成与交付"><a href="#1-持续集成与交付" class="headerlink" title="1 持续集成与交付"></a>1 持续集成与交付</h2><h3 id="1-1-持续集成与交付的原则"><a href="#1-1-持续集成与交付的原则" class="headerlink" title="1.1 持续集成与交付的原则"></a>1.1 持续集成与交付的原则</h3><h4 id="1-1-1-软件交付痛点"><a href="#1-1-1-软件交付痛点" class="headerlink" title="1.1.1 软件交付痛点"></a>1.1.1 软件交付痛点</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA1.png"></p>
<h4 id="1-1-2-持续集成的作用、过程和优势"><a href="#1-1-2-持续集成的作用、过程和优势" class="headerlink" title="1.1.2 持续集成的作用、过程和优势"></a>1.1.2 持续集成的作用、过程和优势</h4><ul>
<li>作用</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA2.png"></p>
<ul>
<li>过程</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA3.png"></p>
<h4 id="1-1-3-CI工具"><a href="#1-1-3-CI工具" class="headerlink" title="1.1.3 CI工具"></a>1.1.3 CI工具</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA4.png"></p>
<h4 id="1-1-4-项目产品的自动化构建"><a href="#1-1-4-项目产品的自动化构建" class="headerlink" title="1.1.4 项目产品的自动化构建"></a>1.1.4 项目产品的自动化构建</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA5.png"></p>
<h4 id="1-1-5-持续测试"><a href="#1-1-5-持续测试" class="headerlink" title="1.1.5 持续测试"></a>1.1.5 持续测试</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA6.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA7.png"></p>
<h4 id="1-1-6-持续改进"><a href="#1-1-6-持续改进" class="headerlink" title="1.1.6 持续改进"></a>1.1.6 持续改进</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA8.png"></p>
<blockquote>
<p>总结</p>
<ul>
<li>持续集成、持续交付、持续部署</li>
<li>持续集成的工具</li>
</ul>
</blockquote>
<p>思考题：</p>
<ol>
<li>持续集成和持续交付是一个意思</li>
</ol>
<p>错误。持续交付是把持续集成的版本放到类生产环境中。</p>
<ol start="2">
<li> 目前那款CI工具较常用？</li>
</ol>
<p>Jenkins</p>
<h3 id="1-2-CI实际交付中的应用"><a href="#1-2-CI实际交付中的应用" class="headerlink" title="1.2 CI实际交付中的应用"></a>1.2 CI实际交付中的应用</h3><h4 id="1-2-1-持续交付的研发流程"><a href="#1-2-1-持续交付的研发流程" class="headerlink" title="1.2.1 持续交付的研发流程"></a>1.2.1 持续交付的研发流程</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA9.png"></p>
<h4 id="1-2-2-高质量的单元测试提高软件开发质量"><a href="#1-2-2-高质量的单元测试提高软件开发质量" class="headerlink" title="1.2.2 高质量的单元测试提高软件开发质量"></a>1.2.2 高质量的单元测试提高软件开发质量</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA10.png"></p>
<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA11.png"></h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA12.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA13.png"></p>
<h4 id="1-2-3-每日构建中的应用"><a href="#1-2-3-每日构建中的应用" class="headerlink" title="1.2.3 每日构建中的应用"></a>1.2.3 每日构建中的应用</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA14.png"></p>
<h4 id="1-2-4-基于脚本的自动化部署"><a href="#1-2-4-基于脚本的自动化部署" class="headerlink" title="1.2.4 基于脚本的自动化部署"></a>1.2.4 基于脚本的自动化部署</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA15.png"></p>
<blockquote>
<p>总结</p>
<ul>
<li> 研发过程中持续交付的应用</li>
<li>TDD测试驱动开发（Test Driven Development）</li>
<li>脚本部署</li>
</ul>
</blockquote>
<ol>
<li> 通过TDD可以降低开发者负担</li>
</ol>
<p>正确</p>
<ol start="2">
<li> 如下哪些是TDD的优点？ </li>
</ol>
<p>A 研发周期长  B 快速反馈 C 保护机制 D 提前澄清需求</p>
<p>答案：BCD</p>
<h3 id="1-3-启动化测试的理论和方法"><a href="#1-3-启动化测试的理论和方法" class="headerlink" title="1.3 启动化测试的理论和方法"></a>1.3 启动化测试的理论和方法</h3><h4 id="1-3-1-自动化测试的实施背景"><a href="#1-3-1-自动化测试的实施背景" class="headerlink" title="1.3.1 自动化测试的实施背景"></a>1.3.1 自动化测试的实施背景</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA16.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA17.png"></p>
<h4 id="1-3-2-自动化测试效应与自动化测试目标"><a href="#1-3-2-自动化测试效应与自动化测试目标" class="headerlink" title="1.3.2 自动化测试效应与自动化测试目标"></a>1.3.2 自动化测试效应与自动化测试目标</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA18.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA19.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA20.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA21.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA22.png"></p>
<h4 id="1-3-3-分层自动哈测试"><a href="#1-3-3-分层自动哈测试" class="headerlink" title="1.3.3  分层自动哈测试"></a>1.3.3  分层自动哈测试</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA23.png"></p>
<h4 id="1-3-4-持续集成过程中自动化测试流程"><a href="#1-3-4-持续集成过程中自动化测试流程" class="headerlink" title="1.3.4  持续集成过程中自动化测试流程"></a>1.3.4  持续集成过程中自动化测试流程</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA24.png"></p>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA25.png"></h4><h4 id="1-3-5-分层自动哈测试的应用"><a href="#1-3-5-分层自动哈测试的应用" class="headerlink" title="1.3.5 分层自动哈测试的应用"></a>1.3.5 分层自动哈测试的应用</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA26.png"></p>
<blockquote>
<p>总结：</p>
<ul>
<li> 自动化测试的实时背景</li>
<li>自动化测试的收益比</li>
<li>自动化测试的各层工具</li>
</ul>
</blockquote>
<ol>
<li>selenium属于接口自动化测试阶段的工具</li>
</ol>
<p>错误 </p>
<ol start="2">
<li> 常见的UI自动化测试工具有哪些</li>
</ol>
<p>A selenium B appinm D postman D jnuit </p>
<p>答案：AB</p>
<h3 id="1-4-自动化测试实践"><a href="#1-4-自动化测试实践" class="headerlink" title="1.4 自动化测试实践"></a>1.4 自动化测试实践</h3><h4 id="1-4-1-单元测试"><a href="#1-4-1-单元测试" class="headerlink" title="1.4.1 单元测试"></a>1.4.1 单元测试</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA27.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA28.png"></p>
<h4 id="1-4-2-接口自动化测试应用：postman"><a href="#1-4-2-接口自动化测试应用：postman" class="headerlink" title="1.4.2 接口自动化测试应用：postman"></a>1.4.2 接口自动化测试应用：postman</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA29.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA30.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA31.png"></p>
<h4 id="1-4-3-接口自动化测试-request"><a href="#1-4-3-接口自动化测试-request" class="headerlink" title="1.4.3 接口自动化测试 request"></a>1.4.3 接口自动化测试 request</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA32.png"></p>
<h4 id="1-4-4-UI自动化测试"><a href="#1-4-4-UI自动化测试" class="headerlink" title="1.4.4 UI自动化测试"></a>1.4.4 UI自动化测试</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA33.png"></p>
<h4 id="1-4-5-selenium-自动化测试框架"><a href="#1-4-5-selenium-自动化测试框架" class="headerlink" title="1.4.5 selenium 自动化测试框架"></a>1.4.5 selenium 自动化测试框架</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA34.png"></p>
<blockquote>
<p> 总结</p>
<ul>
<li> 单元、接口与UI工具的应用</li>
<li>自动化测试框架的应用 </li>
</ul>
</blockquote>
<ol>
<li>selenium 中仍包含RC </li>
</ol>
<p>错误</p>
<ol start="2">
<li> 如下selenium的哪个版本已经被淘汰</li>
</ol>
<p>A selenium3 B selenium2 C selenium1 </p>
<p>C </p>
<h3 id="1-5-持续集成与交互工具的使用方法"><a href="#1-5-持续集成与交互工具的使用方法" class="headerlink" title="1.5 持续集成与交互工具的使用方法"></a>1.5 持续集成与交互工具的使用方法</h3><h4 id="1-5-1-持续集成工具"><a href="#1-5-1-持续集成工具" class="headerlink" title="1.5.1 持续集成工具"></a>1.5.1 持续集成工具</h4><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA35.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E5%8D%8E%E4%B8%BA36.png"></p>
<h4 id="1-5-2-创建任务"><a href="#1-5-2-创建任务" class="headerlink" title="1.5.2 创建任务"></a>1.5.2 创建任务</h4><h4 id="1-5-3-进行构建"><a href="#1-5-3-进行构建" class="headerlink" title="1.5.3 进行构建"></a>1.5.3 进行构建</h4><h4 id="1-5-4-自动哈构建"><a href="#1-5-4-自动哈构建" class="headerlink" title="1.5.4 自动哈构建"></a>1.5.4 自动哈构建</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/10/03/2021-20-03-%E3%80%8A%E5%8F%97%E6%88%92%E3%80%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/03/2021-20-03-%E3%80%8A%E5%8F%97%E6%88%92%E3%80%8B/" class="post-title-link" itemprop="url">《受戒》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-10-03 18:20:00 / 修改时间：18:27:47" itemprop="dateCreated datePublished" datetime="2021-10-03T18:20:00+08:00">2021-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>《受戒》</p>
<p><strong>作者</strong></p>
<p>汪曾祺（1920年3月5日—1997年5月16日），男，汉族，江苏高邮人，当代作家、散文家、戏剧家，京派作家的代表人物。早年毕业于西南联大，历任中学教师、北京市文联干部、《北京文艺》编辑、北京京剧院编辑。汪曾祺在短篇小说创作上颇有成就，著有小说集《邂逅集》，小说《受戒》、《大淖记事》，散文集《蒲桥集》，其大部分作品收录在《汪曾祺全集》中。被誉为“抒情的人道主义者，中国最后一个纯粹的文人，中国最后一个士大夫。”1997年5月16日上午10点30分，汪曾祺因病医治无效去世，享年77岁。 ——豆瓣</p>
<p><strong>摘录</strong></p>
<ul>
<li><p>“当了沙弥尾跟别的和尚有什么不同？</p>
<p>” “沙弥头，沙弥尾，将来都能当方丈。现在的方丈退居了，就当。石桥原本就是沙弥尾。”</p>
<p> “你当沙弥尾吗？”</p>
<p> “还不一定哪。”</p>
<p> “你当方丈，管善因寺？管那么大一个庙？！” </p>
<p>“还早哪！” </p>
<p><strong>划了一气</strong>，小英子说：“你不要当方丈！”</p>
<p> “好，不当。” </p>
<p>“你也不要当沙弥尾！”</p>
<p> “好，不当。” <strong>又划了一气</strong>，看见那一片芦花荡子了。 小英子忽然把桨放下，走到船尾，趴在名字的耳朵旁边，小声地说： “我给你当老婆，你要不要？” <strong>明子眼睛鼓得大大的</strong>。 “你说话呀！” </p>
<p>明子说：“嗯。” </p>
<p>“什么叫‘嗯’呀！要不要，要不要？”</p>
<p> 明子大声地说：“要！” </p>
<p>“你喊什么！” </p>
<p>明子小小声地说：“要——！”</p>
<p> “快点划！” 英子跳到中舱，两只桨<strong>飞快地</strong>划起来，划进了芦花荡。 </p>
<p>——写的太温柔， 小英子的勇敢矜持，明子的懵懂羞涩，人类最美好的感情，是两小无猜的欢喜</p>
</li>
<li><p>各种卖小吃的都来了。卖牛肉高粱酒的，卖回卤豆腐干的，卖五香花生米的、芝麻灌香糖的，卖豆腐脑的，卖煮荸荠的，还有卖河鲜——卖紫皮鲜菱角和新剥鹅头米的……</p>
</li>
<li><p>同事之间为了“联络感情”，时常轮流做东，约好了在星期天早上“吃早茶”。这地方“吃早茶”不是喝茶，主要是吃各种点心——蟹肉包子、火腿烧麦、冬笋蒸饺、脂油千层糕。还可叫一个三鲜煮干丝，小酌两杯。</p>
</li>
<li><p>这家专做“草炉烧饼”。这种烧饼是一箩到底的粗面做的，做蒂子只涂很少一点油，没有什么层，因为是贴在吊炉里用一把稻草烘熟的，故名草炉烧饼，以别于在桶状的炭炉中烤出的加料插酥的“桶炉烧饼”。这种烧饼便宜，也实在，乡下人进城，爱买了当饭。几个草庐烧饼，一碗宽汤饺面，有吃有喝，就饱了。</p>
</li>
<li><p>“晚茶”大都是一碗干拌面，——葱花、猪油、酱油、虾子、虾米为料，面下在里面；或几个麻团、“油墩子”，——白铁敲成浅模，浇入稀面，以萝卜丝为馅，入油炸熟。八千岁家的晚茶，一年三百六十日，都是草炉烧饼，一人两个。这里的店铺，有“客人”，照例早上要请上茶馆。“上茶馆”是喝茶，吃包子、蒸饺、烧麦。照例由店里的“先生”或东家作陪。一般都是叫一笼“杂花色”（即各样包点都有）…… </p>
<p>——汪先生对食物的描写，妙笔柔情，劳苦大众普通的饮食，变得温柔。这些简单的东西，不知道我会写成什么样， 这样的文字应当细品，但是我都没有心思，静下来细读，我们是不是过的太着急？</p>
</li>
<li><p>高先生很孤僻，不出人情，不随份子，几乎不与人通庆吊。他家从不请客，他也从不赴宴。他教书之外，还为人写寿序，撰挽联，委托的人家照例都得请请他，知单送到，他照例都在自己的名字下书一个“谢”字。久而久之，都知道他这脾气，也就不来多此一举了。 他不吃烟，不饮酒，不打牌，不看戏。除了学校和自己的家，哪里也不去，每天他清早出门，傍晚回家。拍拍白木的板门，过了一会儿，门开了。进门是一条狭长的过道，砖缝里长着扫帚苗，苦艾，和一种名叫“七里香”其实是闻不出什么气味，开着蓝色的碎花的野草，有两个黄蝴蝶寂寞的飞着。高先生就从这些野草丛中踏着沉重的步子走进去，走进里面一个小门，好像走进了一个深深的洞穴，高大的背影消失了。木板门又关了，把门上的一副春联关在外面。</p>
</li>
<li><p>  高先生在东街住过的老屋倒塌了，临街的墙壁和白木板门倒还没有倒。板门上高先生写的春联也还在。大红朱笺被风雨漂得几乎是白色的了，墨写的字迹却还很浓，很黑。    辛夸高岭桂    未徙北溟鹏</p>
</li>
</ul>
<p>   ——汪先生笔下皆小人物，高先生有自己的个性，风格，坚持，信仰(尊师)，怎能不令人，动容</p>
<ul>
<li> 一天夜里，李小龙在梦里闻到一股醉人的香味。他忽然惊醒了：昙花开了！ 李小龙一骨碌坐了起来，划根火柴，点亮了煤油灯：昙花真的开了！ 李小龙好像在做梦。 昙花真美呀！雪白雪白的。白的像玉，想通草，像天上的云。花心淡黄，淡得像没有颜色，淡得真雅。她像一个睡醒了的美人，正在舒展着她的肢体，一面吹出醉人的香气。啊呀，真香呀！香死了！ 李小龙两手托着下巴，目不转睛的看着昙花。看了很久，很久。 他困了。他想就这样看他一夜，但是他困了。吹熄了灯，他睡了。一睡就睡着了。 睡着之后，他做了一个梦，梦见昙花开了。 于是李小龙有了两盆昙花。一盆在他的床前，一盆在他的梦里。 </li>
</ul>
<p>​       ——孩子的童心，心思 </p>
<ul>
<li>他们吃饭不怎么嚼，只在嘴里打一个滚，咕咚一声就咽下去了。看他们吃得那样香，你会觉得世界上再没有比这个饭更好吃的饭了。</li>
<li>都到岁数了，心里不是没有。只是像一片薄薄的云，飘过来，飘过去，下不成雨。</li>
<li>她们像男人一样的挣钱，走相、坐相也像男人。走起来一阵风，坐下来两条叉得很开。她们像男人一样亦脚穿草鞋（脚指甲却用风仙花 染红）。她们嘴里不生冷，男人怎么说话她们怎么说话，她们也用男人骂人的话骂人。打起号子来也是“好大娘个歪歪子咧！” 没出门子的姑娘还文雅一点 一做了媳妇就简直是“姜太公在此百无禁忌”，要多野有多野。 这里人家的婚嫁极少明媒正娶，花轿吹鼓手是挣不着他们的钱的媳妇，多是自己跑来的；姑娘，一般是自己找人。她们在男女关系上是比较随便的。姑娘在家生私孩子；一个媳妇，在丈夫之外，再“靠”个，不是稀奇事。这里的女人和男人好，还是恼，只有一个标准：情愿。有的姑娘、媳妇相与了一个男人，自然也跟他要钱买花戴，但是有的不但不要他们的钱，反而把钱给他花，叫做“倒贴”。 因此，街里的人说这里“风气不好” 到底是哪里的风气更好一些呢？难说。</li>
<li>“他们打你，你只要说不再进我家的门，就不打你了，你就不会吃这样大的苦了，你为什么不说？” “你要我说么?” “不要。” “我知道你不要。” “你值么?” “我值。 “十一子,你真好!我喜欢你!你快点好。” “你亲我一下,我就好得快。” “好,亲你!”</li>
</ul>
<p>​     ——大淖人敢爱敢恨</p>
<ul>
<li><p>小吕有一件大红的球衣，干活时他喜欢把外面的衣裳脱去，于是，在果园里就经常看见通红的一团，轻快地、兴冲冲地弹跳出没于高高低低、深深浅浅的丛绿之中，惹得过路的人看了，眼睛里也不由得漾出笑意，觉得天色也明朗，风吹得也舒服</p>
<p>——劳动人民单纯的幸福，我想到了少平把力气都用完。</p>
</li>
<li><p>晚饭米都没得一颗，还你妈的之乎——者也！</p>
</li>
</ul>
<p>——痛苦的文人，哎，读书</p>
<ul>
<li>  全县第一个大画家是季匋民，第一个鉴赏家是叶三。 </li>
</ul>
<p>——传说先秦的琴师伯牙一次在荒山野地弹琴，樵夫钟子期竟能领会这是 描绘“峨峨兮若泰山”和“洋洋兮若江河”。伯牙惊道：“善哉，子之心而与吾心同。”钟子期死后，伯牙痛失知音，摔琴绝弦，终生不弹，故有高山流水之曲。季匋民与叶三现代伯牙子期。</p>
<ul>
<li>陈相公挨了打，当时没敢哭。到了晚上，上了门，一个人呜呜地哭了半天。他向他远在故乡的母亲说：“妈妈，我又挨打了！妈妈，不要紧的，再挨两年打，我就能养活你老人家了！”</li>
<li>陈小手的得名是因为他的手特别小，比女人的手还小，比一般女人的手还更柔软细嫩。他专能治难产。横生、倒生，都能接生下来（他当然也要借助于药物和器械）。据说因为他的手小，动作细腻，可以减少产妇很多的痛苦。大户人家，非到万不得已，是不会请他的。中小户人家，忌讳较少，遇到产妇胎位不正，老娘束手，老娘就会建议：“去请陈小手吧。” …… 有一年，来了联军。我们那里那几年打来打去的，是两支军队。一支是国民革命军，当称之为“党军”；相对的一支是孙传芳的军队。孙传芳自称“五省联军总司令”，他的部队就被称为“联军”。联军驻扎在天王寺，有一团人。团长的太太（谁知道是正太太还是姨太太），要生了，生不下来。叫来几个老娘，还是弄不出来。这太太杀猪也似的乱叫。团长派人去叫称小手。 …… 这女人身上的脂油太多，陈小手费九牛二虎之力，总算把孩子掏出来了…… 陈小手出了天王寺，跨上马。团长掏出枪来，从后面，一枪就把他打了下来。 团长：“我的女人，怎么让他摸来摸去！他身上，除了我，任何男人都不许碰！这小子，太欺负人了！日他奶奶！” 团长觉得怪委屈。</li>
<li>宋侉子每年要在虞小兰家住一两个月，朝朝寒食，夜夜元宵。他老婆死了，也不续弦，这里就是他的家。他有个孩子，有时也带了孩子来玩。他和关家算起来有点远亲，小兰叫他宋大哥。到钱花得差不多了，就说一声：“我明天有事，不来了。”跨上他的踢雪乌骓骏马，一扬鞭子，没影儿了。在一起时，恩恩义义；分开时，潇潇洒洒。 虞小兰有时出来走走，逛逛宜园。夏天的傍晚，穿了一身剪裁合体的白绸衫裤，拿一柄生丝白团扇，站在柳树下面，或倚定红桥栏杆，看人捕鱼采藕。她长得像一颗水蜜桃，皮肤非常白嫩，腰身、手脚都好看。路上行人看见，就不禁放慢了脚步，或者停下来装做看天上的晚霞，好好地看她几眼。他们在心里想：这样的人，这样的命，深深为她惋惜；有人不免想到家中洗衣做饭的黄脸老婆，为自己感到一点不平；或在心里轻轻吟道：“牡丹绝色三春暖，不是梅花处士妻”，情绪相当复杂。</li>
<li>养鸭是一种游离，一种放逐，一种流浪。 </li>
</ul>
<p>——汪先生对劳苦大众有深刻的洞察，有无差别的爱</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/09/30/2021-09-30-%E3%80%8A%E7%BE%8E%E4%B8%BD%E6%96%B0%E4%B8%96%E7%95%8C%E3%80%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/30/2021-09-30-%E3%80%8A%E7%BE%8E%E4%B8%BD%E6%96%B0%E4%B8%96%E7%95%8C%E3%80%8B/" class="post-title-link" itemprop="url">《美丽新世界》</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-30 17:17:00" itemprop="dateCreated datePublished" datetime="2021-09-30T17:17:00+08:00">2021-09-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-10-03 18:22:05" itemprop="dateModified" datetime="2021-10-03T18:22:05+08:00">2021-10-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>《美丽新世界》</p>
<p><strong>作者</strong></p>
<p>奥尔德斯•赫胥黎（Aldous Huxley, 1894—1963），英国杰出的小说家、诗人、散文家、批评家和剧作家，著名的人道主义者。他以大量的小说和散文、杂文、评论作品，有意识地担负起一个人文主义知识分子的道义职责，充当了社会道德和现代文明的拷问者。</p>
<p><strong>摘录</strong></p>
<ul>
<li>有一种东西叫做民主。好像人和人之间除了物理和化学性能平等之外还有什么别的东西也会平等似的。</li>
<li>“如果人不必考虑幸福的话，”他想，“哪会多么有趣！”</li>
<li>慢性悔恨是一种最不健康的情绪。如果你做错了事，你可以忏悔，然后尽自己所能进行弥补，让自己下一次做得更好。千万不要沉浸在过去的错误中，在淤泥中打滚绝对无法让你变得干净</li>
<li>他们为人类准备好了床，如果人类不适应这张床，那就只能自认倒霉，只能把人拉长或截短。</li>
<li>例如，我们去一个热带岛屿，在DDT杀虫剂的帮助下，我们消灭了疟疾，在两三年的时间里，拯救了成千上万的生命。这显然是件好事。但是这些被拯救的成千上万人生育了数百万的孩子，这个岛屿上的可利用资源无法满足这些孩子衣食住行和教育的需要。疟疾带来的快速死亡已经不存在了，但是由于营养不良和拥挤，这里的生活痛苦不堪，饥饿造成的慢性死亡威胁着更多人的生命。</li>
<li>在一个大规模生产和营销的世界里，资金不足的小人物常常处于劣势，在和大人物的竞争中，他失去自己的资本，最后被大人物吞食，失去作为独立生产者存在的权利。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/09/27/%E4%BA%8C%E7%BA%A7%E5%88%B6%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/27/%E4%BA%8C%E7%BA%A7%E5%88%B6%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">二级制方法搭建k8s集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-27 15:20:00" itemprop="dateCreated datePublished" datetime="2021-09-27T15:20:00+08:00">2021-09-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-28 23:08:44" itemprop="dateModified" datetime="2021-09-28T23:08:44+08:00">2021-09-28</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1 准备工作"></a>1 准备工作</h2><h3 id="1-1-服务器或虚拟机"><a href="#1-1-服务器或虚拟机" class="headerlink" title="1.1 服务器或虚拟机"></a>1.1 服务器或虚拟机</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">操作系统：</span><br><span class="line">    CentOS7</span><br><span class="line">内核： </span><br><span class="line"></span><br><span class="line">三台或更多节点及其地址</span><br><span class="line">master：</span><br><span class="line">192.168.2.20  kube-apiserver，kube-controller-manager，kube-scheduler，etcd</span><br><span class="line"></span><br><span class="line">node1：</span><br><span class="line">192.168.2.21  kubelet，kube-proxy，docker，flannel，etcd</span><br><span class="line"></span><br><span class="line">node2：</span><br><span class="line">192.168.2.21  kubelet，kube-proxy，docker，flannel，etcd</span><br></pre></td></tr></table></figure>

<h3 id="1-2-修改主机名-所有节点操作"><a href="#1-2-修改主机名-所有节点操作" class="headerlink" title="1.2 修改主机名  ( 所有节点操作 )"></a>1.2 修改主机名  ( 所有节点操作 )</h3><p>master:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname master</span><br></pre></td></tr></table></figure>

<p>node1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node1</span><br></pre></td></tr></table></figure>

<p>node2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果命令失败， 直接修改 /etc/hostname, 重启后生效  </p>
<p>hostname # 可查看是否修改成功</p>
</blockquote>
<h3 id="1-3-关闭防火强-所有节点操作"><a href="#1-3-关闭防火强-所有节点操作" class="headerlink" title="1.3 关闭防火强 ( 所有节点操作 )"></a>1.3 关闭防火强 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有节点相同操作可使用同时发送到所有会话</p>
</blockquote>
<h3 id="1-4-关闭selinux-所有节点操作"><a href="#1-4-关闭selinux-所有节点操作" class="headerlink" title="1.4 关闭selinux ( 所有节点操作 )"></a>1.4 关闭selinux ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 # 临时关闭</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config # 永久关闭</span><br></pre></td></tr></table></figure>

<h3 id="1-5-关闭swap-所有节点操作"><a href="#1-5-关闭swap-所有节点操作" class="headerlink" title="1.5 关闭swap ( 所有节点操作 )"></a>1.5 关闭swap ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a # 临时关闭；关闭swap主要是为了性能考虑</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>

<blockquote>
<p>free # 可以通过这个命令查看swap是否关闭了 </p>
</blockquote>
<h3 id="1-6-同步时间-所有节点操作"><a href="#1-6-同步时间-所有节点操作" class="headerlink" title="1.6 同步时间 ( 所有节点操作 )"></a>1.6 同步时间 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h3 id="1-7-将桥接的IPv4流量传递到iptables的链-所有节点操作"><a href="#1-7-将桥接的IPv4流量传递到iptables的链-所有节点操作" class="headerlink" title="1.7 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )"></a>1.7 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 加载配置文件</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="1-8-添加主机名与IP对应的关系-master操作"><a href="#1-8-添加主机名与IP对应的关系-master操作" class="headerlink" title="1.8 添加主机名与IP对应的关系 ( master操作 )"></a>1.8 添加主机名与IP对应的关系 ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF </span><br><span class="line">192.168.2.20 master</span><br><span class="line">192.168.2.21 node1</span><br><span class="line">192.168.2.22 node2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="2-cfssl证书-master操作"><a href="#2-cfssl证书-master操作" class="headerlink" title="2  cfssl证书  (master操作)"></a>2  cfssl证书  (master操作)</h2><h3 id="2-1-下载文件"><a href="#2-1-下载文件" class="headerlink" title="2.1 下载文件"></a>2.1 下载文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 安装wget </span><br><span class="line">yum -y install wget </span><br><span class="line"># 下载cfssl工具：</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 </span><br><span class="line"># 添加执行权限</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64 </span><br><span class="line"># 移动配置文件</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>若wget失败验证失败， 加 –no-check-certificate参数可解决</p>
</blockquote>
<h3 id="2-2-创建配置文件"><a href="#2-2-创建配置文件" class="headerlink" title="2.2 创建配置文件"></a>2.2 创建配置文件</h3><p>创建以下三个文件：</p>
<ol>
<li>ca-config.json  </li>
<li> ca-csr.json </li>
<li>server-csr.json</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ssl #创建一个目录来存放配置文件</span><br><span class="line">cd ssl </span><br></pre></td></tr></table></figure>

<p>ca-config.json  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;www&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>ca-csr.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>server-csr.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;192.168.2.20&quot;,      </span><br><span class="line">    &quot;192.168.2.21&quot;,</span><br><span class="line">    &quot;192.168.2.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>etcd集群的ip地址<br>“hosts”:<br>   “192.168.2.20”,<br>   “192.168.2.21”,<br>   “192.168.2.22”</p>
</blockquote>
<h3 id="2-3-生成证书"><a href="#2-3-生成证书" class="headerlink" title="2.3 生成证书"></a>2.3 生成证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#生成证书：</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">2021/09/25 23:56:21 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line"></span><br><span class="line">ls *pem</span><br><span class="line">ca-key.pem  ca.pem  server-key.pem  server.pem</span><br><span class="line">#四个.pem文件证书</span><br></pre></td></tr></table></figure>

<h2 id="3-部署etcd"><a href="#3-部署etcd" class="headerlink" title="3 部署etcd"></a>3 部署etcd</h2><h3 id="3-1-下载二进制包-master操作"><a href="#3-1-下载二进制包-master操作" class="headerlink" title="3.1 下载二进制包 ( master操作 )"></a>3.1 下载二进制包 ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#二进制包下载地址：</span><br><span class="line">https://github.com/etcd-io/etcd/releases/download/v3.2.12/etcd-v3.2.12-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="3-2-解压二进制包-master操作"><a href="#3-2-解压二进制包-master操作" class="headerlink" title="3.2  解压二进制包 ( master操作 )"></a>3.2  解压二进制包 ( master操作 )</h3><p>以下部署步骤在三个etcd节点操作一样，唯一不同的是etcd配置文件中的<strong>服务器IP要写当前本机</strong>的， 所以我们在master节点上配置，然后将配置文件复制到node节点上在修改名称和IP，这样方便一点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 解压二进制包：</span><br><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p   </span><br><span class="line">tar zxvf etcd-v3.2.12-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.2.12-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><p>/opt/etcd/bin 里面存放的是可执行文件 etcd 、 etcdctl</p>
</li>
<li><p>/opt/etcd/cfg 里面存放的是配置文件 etcd.conf </p>
</li>
<li><p>/opt/etcd/ssl  里面存放的是证书ca-key.pem 、 ca.pem 、server-key.pem 、server.pem</p>
</li>
</ul>
</blockquote>
<h3 id="3-3-配置etcd-conf-master操作"><a href="#3-3-配置etcd-conf-master操作" class="headerlink" title="3.3 配置etcd.conf  ( master操作 )"></a>3.3 配置etcd.conf  ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#创建etcd.conf配置文件：</span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd01&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.2.20:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.2.20:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.2.20:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.2.20:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.2.20:2380,etcd02=https://192.168.2.21:2380,etcd03=https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>ETCD_NAME 节点名称    （master 是etcd01 node1是etcd02 node2是etcd03）</li>
</ul>
<ul>
<li>ETCD_DATA_DIR 数据目录 （不用修改）</li>
<li>ETCD_LISTEN_PEER_URLS 集群通信监听地址   （修改为本机ip）</li>
<li>ETCD_LISTEN_CLIENT_URLS 客户端访问监听地址   （修改为本机ip）</li>
<li>ETCD_INITIAL_ADVERTISE_PEER_URLS 集群通告地址  （修改为本机ip）</li>
<li>ETCD_ADVERTISE_CLIENT_URLS 客户端通告地址    （修改为本机ip）</li>
<li>ETCD_INITIAL_CLUSTER 集群节点地址    （跟上面节点名称要一一对应）</li>
<li>ETCD_INITIAL_CLUSTER_TOKEN 集群Token</li>
<li>ETCD_INITIAL_CLUSTER_STATE （加入集群的当前状态，new是新集群，existing表示加入已有集群，因为我们是新创建的所以设置为new，否则用existing）</li>
</ul>
</blockquote>
<h3 id="3-4-配置etcd-service-master操作"><a href="#3-4-配置etcd-service-master操作" class="headerlink" title="3.4 配置etcd.service  ( master操作 )"></a>3.4 配置etcd.service  ( master操作 )</h3><p>三个节点相同</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># systemd管理etcd：（方便使用systemctl启动，而不是用一长串的绝对路径启动）</span><br><span class="line">rm -f /usr/lib/systemd/system/etcd.service</span><br><span class="line">vi /usr/lib/systemd/system/etcd.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="line">--name=$&#123;ETCD_NAME&#125; \</span><br><span class="line">--data-dir=$&#123;ETCD_DATA_DIR&#125; \</span><br><span class="line">--listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">--listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">--initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">--initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125; \</span><br><span class="line">--initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">--initial-cluster-state=new \</span><br><span class="line">--cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--peer-key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--enable-v2</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<blockquote>
<p>\ 为换行连接符，不可省略</p>
</blockquote>
<h3 id="3-5-拷贝证书-master操作"><a href="#3-5-拷贝证书-master操作" class="headerlink" title="3.5  拷贝证书  ( master操作 )"></a>3.5  拷贝证书  ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 把刚才生成的证书拷贝到配置文件中的位置：（对应上面systemd管理中的路径）</span><br><span class="line">cp ~/ssl/ca*pem ~/ssl/server*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure>
<h3 id="3-6-将文件复制到node节点-master操作"><a href="#3-6-将文件复制到node节点-master操作" class="headerlink" title="3.6  将文件复制到node节点 ( master操作 )"></a>3.6  将文件复制到node节点 ( master操作 )</h3><p>主要有两个部分文件需要复制</p>
<ul>
<li> /opt/etcd/ 下面的文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 因为证书我们是在master上配置的，所以我们需要拷贝给所有node </span><br><span class="line">scp -r /opt/etcd/ root@192.168.2.21:/opt/ # 发送到node1</span><br><span class="line">scp -r /opt/etcd/ root@192.168.2.22:/opt/ # 发送到node2 </span><br></pre></td></tr></table></figure>
<ul>
<li> /usr/lib/systemd/system/etcd.service 文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.2.21:/usr/lib/systemd/system/</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.2.22:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>传送完成检查node节点上文件是否存在</p>
</blockquote>
<h3 id="3-7-修改node节点etcd-conf-中的名称和IP"><a href="#3-7-修改node节点etcd-conf-中的名称和IP" class="headerlink" title="3.7 修改node节点etcd.conf 中的名称和IP"></a>3.7 修改node节点etcd.conf 中的名称和IP</h3><ul>
<li> node1 操作</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/cfg/etcd&lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd02&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.2.21:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.2.21:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.2.21:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.2.21:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.2.20:2380,etcd02=https://192.168.2.21:2380,etcd03=https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改ETCD_NAME 和IP</p>
</blockquote>
<ul>
<li> node2 操作</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/cfg/etcd&lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd03&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.2.22:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.2.22:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.2.20:2380,etcd02=https://192.168.2.21:2380,etcd03=https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<h3 id="3-8-启动并设置开启启动："><a href="#3-8-启动并设置开启启动：" class="headerlink" title="3.8 启动并设置开启启动："></a>3.8 启动并设置开启启动：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></figure>

<h3 id="3-9-检查etcd集群状态："><a href="#3-9-检查etcd集群状态：" class="headerlink" title="3.9 检查etcd集群状态："></a>3.9 检查etcd集群状态：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 移动命令路径</span><br><span class="line">cp /opt/etcd/bin/etcdctl /bin </span><br><span class="line"># 配置etcdctl 3 环境变量</span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; endpoint status --write-out=table</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|         ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| https://192.168.2.20:2379 | 3ae8ea54109f8cad |  3.4.14 |   20 kB |      true |      false |        61 |         16 |                 16 |        |</span><br><span class="line">| https://192.168.2.21:2379 | cb408b517db6d952 |  3.4.14 |   20 kB |     false |      false |        61 |         16 |                 16 |        |</span><br><span class="line">| https://192.168.2.22:2379 | eca9a4bbb09d42e4 |  3.4.14 |   20 kB |     false |      false |        61 |         16 |                 16 |        |</span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; endpoint health</span><br><span class="line"># 用 etcd2 重新配置后查看集群状态</span><br><span class="line">ETCDCTL_API=2 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; cluster-health</span><br><span class="line"># 重新配置子网 删除原来的配置</span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot;   del /coreos.com/network/config</span><br><span class="line"># 重新配置</span><br><span class="line">ETCDCTL_API=2 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; set /coreos.com/network/config &#x27;&#123; &quot;Network&quot;: &quot;172.17.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-在work-node节点上安装docker"><a href="#4-在work-node节点上安装docker" class="headerlink" title="4 在work node节点上安装docker"></a>4 在work node节点上安装docker</h2><h3 id="4-1-node1-node2安装docker"><a href="#4-1-node1-node2安装docker" class="headerlink" title="4.1 node1 node2安装docker"></a>4.1 node1 node2安装docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 安装依赖库</span><br><span class="line">yum install -y yum-utils</span><br><span class="line"># 安装docker仓库</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 国外的仓库很慢，可以使用国内的镜像快一点</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"># 安装docker</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<h3 id="4-2-systemd-管理-docker"><a href="#4-2-systemd-管理-docker" class="headerlink" title="4.2 systemd 管理 docker"></a>4.2 systemd 管理 docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 启动</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>





<h2 id="5-kube-apiserver-（master操作）"><a href="#5-kube-apiserver-（master操作）" class="headerlink" title="5 kube-apiserver （master操作）"></a>5 kube-apiserver （master操作）</h2><h3 id="5-1-生成-kube-apiserver-需要的配置文件"><a href="#5-1-生成-kube-apiserver-需要的配置文件" class="headerlink" title="5.1 生成 kube-apiserver 需要的配置文件"></a>5.1 生成 kube-apiserver 需要的配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd TLS/k8s </span><br><span class="line">#保存 ca-config.json  ca-csr.json server-csr.json</span><br></pre></td></tr></table></figure>

<ul>
<li> 配置 ca-config.json</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 cca-csr.json</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 server-csr.json</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.0.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.2.20&quot;,</span><br><span class="line">      &quot;192.168.2.21&quot;,</span><br><span class="line">      &quot;192.168.2.22&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-2-生成证书"><a href="#5-2-生成证书" class="headerlink" title="5.2 生成证书"></a>5.2 生成证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">ls *pem</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line">ls server*pem</span><br><span class="line"># 拷贝证书</span><br><span class="line">cp ~/k8s/ca*pem ~/k8s/server*pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure>



<h3 id="5-2-部署-kube-apiserver"><a href="#5-2-部署-kube-apiserver" class="headerlink" title="5.2 部署 kube apiserver"></a>5.2 部署 kube apiserver</h3><p>下载kubernetes-server-linux-amd64.tar.gz，包含了所需的所有组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG- 1.20.1.md#v1183</span><br></pre></td></tr></table></figure>

<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes/server/bin</span><br><span class="line"># 拷贝</span><br><span class="line">cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin</span><br><span class="line">cp kubectl /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="5-3-配置kube-apiserver-conf"><a href="#5-3-配置kube-apiserver-conf" class="headerlink" title="5.3 配置kube-apiserver.conf"></a>5.3 配置kube-apiserver.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--etcd-servers=https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379 \\</span><br><span class="line">--bind-address=192.168.2.20 \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--advertise-address=192.168.2.20 \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode=RBAC,Node \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=100 \\</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<blockquote>
<p>上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用 EOF 保留换 行符。</p>
<ul>
<li>logtostderr：启用日志</li>
<li>v：日志等级</li>
<li>log-dir：日志目录</li>
<li>etcd-servers：etcd 集群地址</li>
<li>bind-address：监听地址</li>
<li>secure-port：https 安全端口</li>
<li>advertise-address：集群通告地址</li>
<li>allow-privileged：启用授权</li>
<li>service-cluster-ip-range：Service 虚拟 IP 地址段</li>
<li>enable-admission-plugins：准入控制模块</li>
<li>authorization-mode：认证授权，启用 RBAC 授权和节点自管理</li>
<li>enable-bootstrap-token-auth：启用 TLS bootstrap 机制</li>
<li>token-auth-file：bootstrap token 文件</li>
<li>service-node-port-range：Service nodeport 类型默认分配端口范围</li>
<li>kubelet-client-xxx：apiserver 访问 kubelet 客户端证书</li>
<li>tls-xxx-file：apiserver https 证书</li>
<li>etcd-xxxfile：连接 Etcd 集群证书</li>
<li>audit-log-xxx：审计日志</li>
</ul>
</blockquote>
<h3 id="5-4-配置token-csv"><a href="#5-4-配置token-csv" class="headerlink" title="5.4 配置token.csv"></a>5.4 配置token.csv</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF</span><br><span class="line">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br><span class="line">a266c491e557753ef5d43e467c600d10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/profile&lt;&lt; EOF</span><br><span class="line">export KUBERNETES_MASTER=&quot;127.0.0.1:8080&quot;</span><br><span class="line">EOF</span><br><span class="line">保存退出</span><br><span class="line">source /etc/profile</span><br><span class="line">刷新环境变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-5-配置kube-apiserver-service"><a href="#5-5-配置kube-apiserver-service" class="headerlink" title="5.5 配置kube-apiserver.service"></a>5.5 配置kube-apiserver.service</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-6-设置自启动与启动"><a href="#5-6-设置自启动与启动" class="headerlink" title="5.6 设置自启动与启动"></a>5.6 设置自启动与启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl status kube-apiserver </span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">kube-apiserver.service - Kubernetes API Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 01:25:36 EDT; 48s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 10945 (kube-apiserver)</span><br><span class="line">   CGroup: /system.slice/kube-apiserver.service</span><br><span class="line">           └─10945 /opt/kubernetes/bin/kube-apiserver --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --etcd-servers=https://192.168.2.20:2379.</span><br></pre></td></tr></table></figure>

<h3 id="5-7-授权-kubelet-bootstrap-用户允许请求证书"><a href="#5-7-授权-kubelet-bootstrap-用户允许请求证书" class="headerlink" title="5.7 授权 kubelet-bootstrap 用户允许请求证书"></a>5.7 授权 kubelet-bootstrap 用户允许请求证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<h2 id="6-部署-kube-controller-manager（master操作）"><a href="#6-部署-kube-controller-manager（master操作）" class="headerlink" title="6 部署 kube-controller-manager（master操作）"></a>6 部署 kube-controller-manager（master操作）</h2><h3 id="6-1-配置kube-controller-manager-conf"><a href="#6-1-配置kube-controller-manager-conf" class="headerlink" title="6.1 配置kube-controller-manager.conf"></a>6.1 配置kube-controller-manager.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--master=127.0.0.1:8080 \\</span><br><span class="line">--bind-address=127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--experimental-cluster-signing-duration=87600h0m0s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-2-systemd-管理-controller-manager"><a href="#6-2-systemd-管理-controller-manager" class="headerlink" title="6.2 systemd 管理 controller-manager"></a>6.2 systemd 管理 controller-manager</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-3-设置kube-controller-manager的自启动并启动"><a href="#6-3-设置kube-controller-manager的自启动并启动" class="headerlink" title="6.3 设置kube-controller-manager的自启动并启动"></a>6.3 设置kube-controller-manager的自启动并启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 01:33:06 EDT; 137ms ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 11011 (kube-controller)</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─11011 /opt/kubernetes/bin/kube-controller-manager --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --leader-elect=true --master=12...</span><br><span class="line"></span><br><span class="line">Sep 27 01:33:06 master systemd[1]: Started Kubernetes Controller Manager.</span><br></pre></td></tr></table></figure>



<h2 id="7-部署-kube-scheduler（master操作）"><a href="#7-部署-kube-scheduler（master操作）" class="headerlink" title="7 部署 kube-scheduler（master操作）"></a>7 部署 kube-scheduler（master操作）</h2><h3 id="7-1-配置kube-scheduler-conf"><a href="#7-1-配置kube-scheduler-conf" class="headerlink" title="7.1 配置kube-scheduler.conf"></a>7.1 配置kube-scheduler.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--leader-elect \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--bind-address=127.0.0.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="7-2-配置-kube-scheduler-service"><a href="#7-2-配置-kube-scheduler-service" class="headerlink" title="7.2 配置 kube-scheduler.service"></a>7.2 配置 kube-scheduler.service</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="7-3-kube-scheduler自启动"><a href="#7-3-kube-scheduler自启动" class="headerlink" title="7.3 kube-scheduler自启动"></a>7.3 kube-scheduler自启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kube-scheduler.service - Kubernetes Scheduler</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 01:36:04 EDT; 123ms ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 11065 (kube-scheduler)</span><br><span class="line">   CGroup: /system.slice/kube-scheduler.service</span><br><span class="line">           └─11065 /opt/kubernetes/bin/kube-scheduler --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --leader-elect --master=127.0.0.1:8080 -...</span><br><span class="line">Sep 27 01:36:04 master systemd[1]: Started Kubernetes Scheduler.</span><br></pre></td></tr></table></figure>

<h3 id="7-4-查看集群状态"><a href="#7-4-查看集群状态" class="headerlink" title="7.4 查看集群状态"></a>7.4 查看集群状态</h3><p>master节点的组件已经部署完成，查看状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="8-部署work-node-的组件"><a href="#8-部署work-node-的组件" class="headerlink" title="8 部署work node 的组件"></a>8 部署work node 的组件</h2><p>这里我们在master上也部署node的组件，打上污点不使用，不影响</p>
<h3 id="8-1-拷贝文件"><a href="#8-1-拷贝文件" class="headerlink" title="8.1 拷贝文件"></a>8.1 拷贝文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br><span class="line"># 从master拷贝需要的文件</span><br><span class="line">scp -r root@192.168.2.20:/root/kubernetes/server/bin/kubelet  /opt/kubernetes/bin</span><br><span class="line">scp -r root@192.168.2.20:/root/kubernetes/server/bin/kube-proxy  /opt/kubernetes/bin</span><br><span class="line">scp -r root@192.168.2.20:/root/kubernetes/server/bin/kubectl  /usr/bin/</span><br><span class="line">scp -r root@192.168.2.20:/opt/kubernetes/ssl  /opt/kubernetes</span><br></pre></td></tr></table></figure>

<h3 id="8-2-配置kubelet-conf"><a href="#8-2-配置kubelet-conf" class="headerlink" title="8.2 配置kubelet.conf"></a>8.2 配置kubelet.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=tr \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--hostname-override=node1 \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \\</span><br><span class="line">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>hostname-override：显示名称，集群中唯一</li>
<li> network-plugin：启用CNI</li>
<li>kubeconfig：空路径，会自动生成，后面用于连接apiserver</li>
<li>bootstrap-kubeconfig：首次启动向apiserver申请证书</li>
<li>config：配置参数文件</li>
<li>cert-dir：kubelet证书生成目录</li>
<li>pod-infra-container-image：管理Pod网络容器的镜像</li>
</ul>
</blockquote>
<h3 id="8-3-配置kubelet-config-yml"><a href="#8-3-配置kubelet-config-yml" class="headerlink" title="8.3 配置kubelet-config.yml"></a>8.3 配置kubelet-config.yml</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 192.168.2.21</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.0.0.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-4-生成bootstrap-kubeconfig文件"><a href="#8-4-生成bootstrap-kubeconfig文件" class="headerlink" title="8.4 生成bootstrap.kubeconfig文件"></a>8.4 生成bootstrap.kubeconfig文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER=&quot;https://192.168.2.20:6443&quot; # apiserver IP:PORT ?</span><br><span class="line">TOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot; # 与token.csv里保持一致</span><br></pre></td></tr></table></figure>

<h3 id="8-5-生成-kubelet-bootstrap-kubeconfig-配置文件"><a href="#8-5-生成-kubelet-bootstrap-kubeconfig-配置文件" class="headerlink" title="8.5 生成 kubelet bootstrap kubeconfig 配置文件"></a>8.5 生成 kubelet bootstrap kubeconfig 配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">kubectl config set-credentials &quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --token=$&#123;TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=&quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"># 拷贝</span><br><span class="line">mv bootstrap.kubeconfig /opt/kubernetes/cfg</span><br></pre></td></tr></table></figure>

<h3 id="8-6-systemd管理kubelet-service"><a href="#8-6-systemd管理kubelet-service" class="headerlink" title="8.6 systemd管理kubelet.service"></a>8.6 systemd管理kubelet.service</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-7-kubelet-启动"><a href="#8-7-kubelet-启动" class="headerlink" title="8.7 kubelet 启动"></a>8.7 kubelet 启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enabel kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl status kubelet</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kubelet.service - Kubernetes Kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 02:26:01 EDT; 1min 18s ago</span><br><span class="line"> Main PID: 26821 (kubelet)</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─26821 /opt/kubernetes/bin/kubelet --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --hostname-override=m1 --network-plugin=cni ..</span><br><span class="line">Sep 27 02:26:01 node1 systemd[1]: Started Kubernetes Kubelet.</span><br></pre></td></tr></table></figure>

<h3 id="8-8-批准加入集群-（master操作）"><a href="#8-8-批准加入集群-（master操作）" class="headerlink" title="8.8 批准加入集群 （master操作）"></a>8.8 批准加入集群 （master操作）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查看kubelet证书请求 </span><br><span class="line">[root@master bin]# kubectl get csr</span><br><span class="line">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-JZLQ2x99c69eRpOjkzoxoDYi3NGF0t5PXEu8AQhkr8M   3m5s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"># 批准请求</span><br><span class="line">[root@master bin]# kubectl certificate approve node-csr-JZLQ2x99c69eRpOjkzoxoDYi3NGF0t5PXEu8AQhkr8M</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-JZLQ2x99c69eRpOjkzoxoDYi3NGF0t5PXEu8AQhkr8M approved</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   NotReady    &lt;none&gt;   24m   v1.18.2</span><br></pre></td></tr></table></figure>



<h2 id="9-部署kube-proxy"><a href="#9-部署kube-proxy" class="headerlink" title="9 部署kube-proxy"></a>9 部署kube-proxy</h2><h3 id="9-1-kube-proxy-conf-node操作"><a href="#9-1-kube-proxy-conf-node操作" class="headerlink" title="9.1 kube-proxy.conf (node操作)"></a>9.1 kube-proxy.conf (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="9-2-kube-proxy-config-yml-node操作"><a href="#9-2-kube-proxy-config-yml-node操作" class="headerlink" title="9.2 kube-proxy-config.yml (node操作)"></a>9.2 kube-proxy-config.yml (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: m1</span><br><span class="line">clusterCIDR: 10.0.0.0/24</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="9-3-生成证书-master操作"><a href="#9-3-生成证书-master操作" class="headerlink" title="9.3 生成证书 (master操作)"></a>9.3 生成证书 (master操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 因为cfssl安装在master上， 在master上生成证书发到nodo上</span><br><span class="line">cd /root/k8s</span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"></span><br><span class="line"># 拷贝到node </span><br><span class="line">scp -r /root/k8s root@192.168.2.21:/opt/ # node1</span><br><span class="line">scp -r /root/k8s root@192.168.2.22:/opt/ # node2 </span><br></pre></td></tr></table></figure>

<h3 id="9-4-生成kubeconfig-node操作"><a href="#9-4-生成kubeconfig-node操作" class="headerlink" title="9.4 生成kubeconfig  (node操作)"></a>9.4 生成kubeconfig  (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">cp kube-proxy.kubeconfig /opt/kubernetes/cfg/</span><br></pre></td></tr></table></figure>

<h3 id="9-5-配置kube-proxy-service-node操作"><a href="#9-5-配置kube-proxy-service-node操作" class="headerlink" title="9.5 配置kube-proxy.service (node操作)"></a>9.5 配置kube-proxy.service (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-6-kube-proxy启动-node操作"><a href="#9-6-kube-proxy启动-node操作" class="headerlink" title="9.6 kube-proxy启动 (node操作)"></a>9.6 kube-proxy启动 (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl enable kube-proxy</span><br><span class="line">systemctl status kube-proxy</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-proxy.service to /usr/lib/systemd/system/kube-proxy.service.</span><br><span class="line">[root@node1 k8s]# </span><br><span class="line">[root@node1 k8s]# systemctl status kube-proxy</span><br><span class="line">● kube-proxy.service - Kubernetes Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 03:19:53 EDT; 137ms ago</span><br><span class="line"> Main PID: 31089 (kube-proxy)</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           └─31089 /opt/kubernetes/bin/kube-proxy --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --config=/opt/kubernetes/cfg/kube-proxy-c...</span><br><span class="line">Sep 27 03:19:53 node1 systemd[1]: Started Kubernetes Proxy.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="10-部署网络组件"><a href="#10-部署网络组件" class="headerlink" title="10 部署网络组件"></a>10 部署网络组件</h2><p>Calico是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#安装calico</span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line">#列出“kube-system”命名空间下的所有pod</span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   28m   v1.18.2</span><br><span class="line">k8s-node1     Ready    &lt;none&gt;   13m   v1.18.2</span><br><span class="line">k8s-node2     Ready    &lt;none&gt;   14m   v1.18.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="授权-apiserver-访问-kubelet"><a href="#授权-apiserver-访问-kubelet" class="headerlink" title="授权 apiserver 访问 kubelet"></a>授权 apiserver 访问 kubelet</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">      - pods/log</span><br><span class="line">    verbs:</span><br><span class="line">      - &quot;*&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kubernetes</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>

<h2 id="11-新增加-Worker-Node"><a href="#11-新增加-Worker-Node" class="headerlink" title="11 新增加 Worker-Node"></a>11 新增加 Worker-Node</h2><h3 id="11-1-拷贝已部署好的Node相关文件到新节点"><a href="#11-1-拷贝已部署好的Node相关文件到新节点" class="headerlink" title="11.1 拷贝已部署好的Node相关文件到新节点"></a>11.1 拷贝已部署好的Node相关文件到新节点</h3><p>在Master节点中，将Worker Node涉及文件拷贝到另外2个节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#拷贝工作目录</span><br><span class="line">scp -r /opt/kubernetes root@192.168.200.201:/opt/</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#拷贝配置文件</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.200.201:/usr/lib/systemd/system</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#拷贝证书文件</span><br><span class="line">scp /opt/kubernetes/ssl/ca.pem root@192.168.200.201:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#对node2机器同样执行一遍</span><br><span class="line">scp -r /opt/kubernetes root@192.168.200.202:/opt/</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.200.202:/usr/lib/systemd/system</span><br><span class="line">scp /opt/kubernetes/ssl/ca.pem root@192.168.200.202:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure>

<h3 id="11-2-删除-kubelet-证书和-kubeconfig-文件"><a href="#11-2-删除-kubelet-证书和-kubeconfig-文件" class="headerlink" title="11.2 删除 kubelet 证书和 kubeconfig 文件"></a>11.2 删除 kubelet 证书和 kubeconfig 文件</h3><p>由于这几个文件是证书申请审批后自动生成的，每个Node不同，因此必须删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在node1、node2两个节点上分别执行如下命令</span><br><span class="line">rm -f /opt/kubernetes/cfg/kubelet.kubeconfig </span><br><span class="line">rm -f /opt/kubernetes/ssl/kubelet*</span><br></pre></td></tr></table></figure>

<h3 id="11-3-修改主机名"><a href="#11-3-修改主机名" class="headerlink" title="11.3 修改主机名"></a>11.3 修改主机名</h3><p>在两台机器上分别打开2个配置文件，并修改主机名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 修改node1 kubelet配置文件</span><br><span class="line">vi /opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">--hostname-override=k8s-node1</span><br><span class="line"># 或者sed -i直接替换</span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node1/g&quot; /opt/kubernetes/cfg/kubelet.conf  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#修改kube-proxy配置文件</span><br><span class="line">vi /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">hostnameOverride: k8s-node1</span><br><span class="line"># 或者sed -i直接替换</span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node1/g&quot; /opt/kubernetes/cfg/kube-proxy-config.yml</span><br></pre></td></tr></table></figure>

<p>node2操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node2/g&quot; /opt/kubernetes/cfg/kubelet.conf  </span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node2/g&quot; /opt/kubernetes/cfg/kube-proxy-config.yml</span><br></pre></td></tr></table></figure>



<h3 id="11-4-启动并设置开机启动"><a href="#11-4-启动并设置开机启动" class="headerlink" title="11.4 启动并设置开机启动"></a>11.4 启动并设置开机启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet kube-proxy</span><br><span class="line">systemctl enable kubelet kube-proxy</span><br><span class="line">systemctl status kubelet kube-proxy</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kube-proxy.service - Kubernetes Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2021-09-28 06:14:10 EDT; 40min ago</span><br><span class="line"> Main PID: 3279 (kube-proxy)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   Memory: 12.3M</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           └─3279 /opt/kubernetes/bin/kube-proxy --logtostderr=false --v=2 --log-...</span><br><span class="line"></span><br><span class="line">Sep 28 06:14:10 k8s-master1 systemd[1]: Started Kubernetes Proxy.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="11-5-在Master上批准新的Node-kubelet证书申请"><a href="#11-5-在Master上批准新的Node-kubelet证书申请" class="headerlink" title="11.5 在Master上批准新的Node kubelet证书申请"></a>11.5 在Master上批准新的Node kubelet证书申请</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 先查看证书请求：</span><br><span class="line">kubectl get csr </span><br><span class="line">在两台node机器上分别执行完前4步操作之后（node节点中启动kubelet后就会有请求信息），查</span><br><span class="line"></span><br><span class="line">#授权ndoe1</span><br><span class="line">kubectl certificate approve node-csr-MYWfZXy8o2n8Gb6dZ-fVKw1qVFkmgEkSFdg7m1VL56w</span><br><span class="line">#授权node2</span><br><span class="line">kubectl certificate approve node-csr-XAp5v8JU6qlAkDwzXPiN0DkJ9xlqsq4KbMekUFqBwKM</span><br></pre></td></tr></table></figure>
<h3 id="11-6：查看Node状态"><a href="#11-6：查看Node状态" class="headerlink" title="11.6：查看Node状态"></a>11.6：查看Node状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   45m   v1.18.2</span><br><span class="line">k8s-node1     Ready    &lt;none&gt;   30m   v1.18.2</span><br><span class="line">k8s-node2     Ready    &lt;none&gt;   31m   v1.18.2</span><br></pre></td></tr></table></figure>

<h2 id="12-测试kubernetes集群"><a href="#12-测试kubernetes集群" class="headerlink" title="12 测试kubernetes集群"></a>12 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>
<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/09/27/2021-09-27-k8s%E9%85%8D%E7%BD%AEflannel%E7%BD%91%E7%BB%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/27/2021-09-27-k8s%E9%85%8D%E7%BD%AEflannel%E7%BD%91%E7%BB%9C/" class="post-title-link" itemprop="url">配置flannel</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-09-27 09:09:00 / 修改时间：12:23:46" itemprop="dateCreated datePublished" datetime="2021-09-27T09:09:00+08:00">2021-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="5-部署Flannel网络"><a href="#5-部署Flannel网络" class="headerlink" title="5 部署Flannel网络"></a>5 部署Flannel网络</h2><p>Falnnel要用etcd存储自身一个子网信息，所以要保证能成功连接Etcd，写入预定义子网段<br> ( master操作 )</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># etcdctl 3</span><br><span class="line">cd /opt/etcd/ssl</span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; put /coreos.com/network/config  &#x27;&#123; &quot;Network&quot;: &quot;172.17.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是etcdctl 3 的用法，与etcdctl 2 不一样:</p>
<p>/opt/etcd/bin/etcdctl <br>–ca-file=ca.pem –cert-file=server.pem –key-file=server-key.pem <br>–endpoints=”<a href="https://192.168.13.141:2379,https://192.168.13.142:2379,https://192.168.13.143:2379&quot;">https://192.168.13.141:2379,https://192.168.13.142:2379,https://192.168.13.143:2379&quot;</a> <br>set /coreos.com/network/config  ‘{ “Network”: “172.17.0.0/16”, “Backend”: {“Type”: “vxlan”}}’</p>
</blockquote>
<p>以下部署步骤在规划的每个node节点都操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 下载二进制包</span><br><span class="line">wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">tar zxvf flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">mkdir -pv /opt/kubernetes/bin</span><br><span class="line">mv flanneld mk-docker-opts.sh /opt/kubernetes/bin</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#配置Flannel：</span><br><span class="line">mkdir -pv /opt/kubernetes/cfg/</span><br><span class="line">cat &gt; /opt/kubernetes/cfg/flanneld &lt;&lt; EOF</span><br><span class="line">FLANNEL_OPTIONS=&quot;--etcd-endpoints=https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379 -etcd-cafile=/opt/etcd/ssl/ca.pem -etcd-certfile=/opt/etcd/ssl/server.pem -etcd-keyfile=/opt/etcd/ssl/server-key.pem&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#systemd管理Flannel：</span><br><span class="line">cat &gt; /usr/lib/systemd/system/flanneld.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/flanneld</span><br><span class="line">ExecStart=/opt/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS</span><br><span class="line">ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果没有/run/flannel/subnet.env， 创建一个</p>
<p>mkdir /run/flannel</p>
<p>cat &gt; /run/flannel/subnet.env &lt;&lt; EOF<br>FLANNEL_NETWORK=172.17.0.0/16<br>FLANNEL_SUBNET=172.17.207.1/24<br>FLANNEL_MTU=1500<br>FLANNEL_IPMASQ=false<br>EOF</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#配置Docker启动指定子网段：</span><br><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>重启flannel和docker：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart flanneld</span><br><span class="line">systemctl enable flanneld</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>检查是否生效：（确保docker0与flannel.1在同一网段。）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:cc:02:29 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.13.143/24 brd 192.168.13.255 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::d059:defe:bc38:137e/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:ce:fa:ff:66 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.69.1/24 brd 172.17.69.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:ceff:fefa:ff66/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether ce:eb:c2:70:84:a2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.69.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::cceb:c2ff:fe70:84a2/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@node1 ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:27:d1:4f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.13.142/24 brd 192.168.13.255 scope global ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4e07:7b5b:8315:984a/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:f4:33:f5:e0 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.91.1/24 brd 172.17.91.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:f4ff:fe33:f5e0/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 42:de:f7:5d:a5:74 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.91.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::40de:f7ff:fe5d:a574/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">       </span><br><span class="line">测试不同节点互通，在当前节点访问另一个Node节点docker0 IP：</span><br><span class="line">(一个node节点去ping另一个node节点的docker0的IP,能通就说明Flannel部署成功)</span><br><span class="line">[root@node1 ~]# ping 172.17.69.1    </span><br><span class="line">PING 172.17.69.1 (172.17.69.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.69.1: icmp_seq=1 ttl=64 time=0.625 ms</span><br><span class="line">64 bytes from 172.17.69.1: icmp_seq=2 ttl=64 time=0.391 ms</span><br><span class="line">64 bytes from 172.17.69.1: icmp_seq=3 ttl=64 time=0.400 ms</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">#创建CA证书：</span><br><span class="line">[root@master ~]# mkdir k8s        #同样创建证书文件存放目录</span><br><span class="line">[root@master ~]# cd k8s</span><br><span class="line">[root@master k8s]# vim ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master k8s]# vim ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">生成apiserver证书：</span><br><span class="line">[root@master k8s]# vim server-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.0.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.13.141&quot;,</span><br><span class="line">      &quot;192.168.13.142&quot;,</span><br><span class="line">      &quot;192.168.13.143&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">=============================================</span><br><span class="line">&quot;10.0.0.1&quot;,   //这个是后边dns要用的虚拟网络的网关,不用改,就用这个--service-cluster-ip-range=10.0.0.0/24 \ 切忌</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.13.141&quot;,    #k8s集群的ip，也就是三台虚拟机的ip</span><br><span class="line">      &quot;192.168.13.142&quot;,</span><br><span class="line">      &quot;192.168.13.143&quot;,</span><br><span class="line">=============================================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">生成kube-proxy证书：</span><br><span class="line">[root@master k8s]# vim kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master k8s]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">[root@master k8s]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line">[root@master k8s]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">最终生成以下证书文件：</span><br><span class="line">[root@master k8s]# ls *pem</span><br><span class="line">ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  server-key.pem  server.pem</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">部署apiserver组件</span><br><span class="line">下载二进制包：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md</span><br><span class="line">下载这个包（kubernetes-server-linux-amd64.tar.gz）就够了，包含了所需的所有组件。</span><br><span class="line">[root@master ~]# mkdir /opt/kubernetes/&#123;bin,cfg,ssl&#125; -pv</span><br><span class="line">[root@master ~]# tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master ~]# cd kubernetes/server/bin</span><br><span class="line">[root@master ~]# cp kube-apiserver kube-scheduler kube-controller-manager kubectl /opt/kubernetes/bin</span><br><span class="line">从生成证书的机器拷贝证书到master(因为是在一台机器上的 所以直接复制就行)</span><br><span class="line">[root@master ~]# cd k8s</span><br><span class="line">[root@master k8s]# cp server.pem  server-key.pem ca.pem ca-key.pem /opt/kubernetes/ssl/</span><br><span class="line">创建token文件，后面会用到：</span><br><span class="line">[root@master ~]# vim /opt/kubernetes/cfg/token.csv</span><br><span class="line">674c457d4dcf2eefe4920d7dbb6b0ddc,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br><span class="line">第一列：随机字符串，自己可生成（最好不要改，后面会用到这串数字）</span><br><span class="line">第二列：用户名</span><br><span class="line">第三列：UID</span><br><span class="line">第四列：用户组</span><br><span class="line"></span><br><span class="line">创建apiserver配置文件：</span><br><span class="line">[root@master ~]# vim /opt/kubernetes/cfg/kube-apiserver </span><br><span class="line"></span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--etcd-servers=https://192.168.13.141:2379,https://192.168.13.142:2379,https://192.168.13.143:2379 \</span><br><span class="line">--bind-address=192.168.13.141 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=192.168.13.141 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth \</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \</span><br><span class="line">--service-node-port-range=30000-50000 \</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem&quot;</span><br><span class="line">============================================================</span><br><span class="line">参数说明：</span><br><span class="line">* --logtostderr 启用日志</span><br><span class="line">* --v 日志等级</span><br><span class="line">* --etcd-servers etcd集群地址</span><br><span class="line">* --bind-address 监听地址（本机）</span><br><span class="line">* --secure-port https安全端口</span><br><span class="line">* --advertise-address 集群通告地址（本机）</span><br><span class="line">* --allow-privileged 启用授权</span><br><span class="line">* --service-cluster-ip-range Service虚拟IP地址段    //这里就用这个网段，切忌不要改</span><br><span class="line">* --enable-admission-plugins 准入控制模块</span><br><span class="line">* --authorization-mode 认证授权，启用RBAC授权和节点自管理</span><br><span class="line">* --enable-bootstrap-token-auth 启用TLS bootstrap功能，后面会讲到</span><br><span class="line">* --token-auth-file token文件</span><br><span class="line">* --service-node-port-range Service Node类型默认分配端口范围</span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">systemd管理apiserver：</span><br><span class="line">[root@master ~]# vim /usr/lib/systemd/system/kube-apiserver.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl enable kube-apiserver</span><br><span class="line">[root@master ~]# systemctl start kube-apiserver</span><br><span class="line"></span><br><span class="line">部署schduler组件</span><br><span class="line">创建schduler配置文件：</span><br><span class="line">[root@master ~]# vim /opt/kubernetes/cfg/kube-scheduler </span><br><span class="line"></span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect&quot;</span><br><span class="line">============================================</span><br><span class="line">参数说明：</span><br><span class="line">* --master 连接本地apiserver</span><br><span class="line">* --leader-elect 当该组件启动多个时，自动选举（HA）</span><br><span class="line">============================================</span><br><span class="line"></span><br><span class="line">systemd管理schduler组件：</span><br><span class="line">[root@master ~]# vim cat /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl enable kube-scheduler </span><br><span class="line">[root@master ~]# systemctl start kube-scheduler </span><br><span class="line"></span><br><span class="line">部署controller-manager组件</span><br><span class="line">创建controller-manager配置文件：</span><br><span class="line">[root@master ~]# cat /opt/kubernetes/cfg/kube-controller-manager </span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--address=127.0.0.1 \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--cluster-name=kubernetes \</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem&quot;</span><br><span class="line"></span><br><span class="line">systemd管理controller-manager组件：</span><br><span class="line">[root@master ~]# cat /usr/lib/systemd/system/kube-controller-manager.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">[root@master ~]# systemctl daemon-reload</span><br><span class="line">[root@master ~]# systemctl enable kube-controller-manager</span><br><span class="line">[root@master ~]# systemctl start kube-controller-manager</span><br><span class="line"></span><br><span class="line">所有组件都已经启动成功，通过kubectl工具查看当前集群组件状态：</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">如上输出说明组件都正常。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">在Node节点部署组件</span><br><span class="line">Master apiserver启用TLS认证后，Node节点kubelet组件想要加入集群，必须使用CA签发的有效证书才能与apiserver通信，当Node节点很多时，签署证书是一件很繁琐的事情，因此有了TLS Bootstrapping机制，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。</span><br><span class="line"></span><br><span class="line">master节点部署</span><br><span class="line">将kubelet-bootstrap用户绑定到系统集群角色</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">  --clusterrole=system:node-bootstrapper \</span><br><span class="line">  --user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line">创建kubeconfig文件:</span><br><span class="line">在生成kubernetes证书的目录下执行以下命令生成kubeconfig文件：</span><br><span class="line">[root@master ~]# cd /k8s</span><br><span class="line">指定apiserver 内网负载均衡地址</span><br><span class="line">[root@master k8s]# KUBE_APISERVER=&quot;https://10.206.176.19:6443&quot;</span><br><span class="line">[root@master k8s]# BOOTSTRAP_TOKEN=674c457d4dcf2eefe4920d7dbb6b0ddc   #这个和上面创建token文件的一致</span><br><span class="line"></span><br><span class="line">设置集群参数</span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">设置客户端认证参数</span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">设置上下文参数</span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">设置默认上下文</span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">创建kube-proxy kubeconfig文件</span><br><span class="line"></span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master k8s]# /opt/kubernetes/bin/kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master k8s]# ls    #会多出下面两个.kubeconfig文件</span><br><span class="line">bootstrap.kubeconfig  kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">将这两个文件拷贝到Node节点/opt/kubernetes/cfg目录下。 !!!!不能忽略</span><br><span class="line">[root@master k8s]# scp bootstrap.kubeconfig  kube-proxy.kubeconfig node1:/opt/kubernetes/cfg</span><br><span class="line">[root@master k8s]# scp bootstrap.kubeconfig  kube-proxy.kubeconfig node2:/opt/kubernetes/cfg</span><br><span class="line"></span><br><span class="line">部署kubelet组件</span><br><span class="line">将前面下载的二进制包中的kubelet和kube-proxy拷贝到/opt/kubernetes/bin目录下。 </span><br><span class="line">（master节点）</span><br><span class="line">cd /root/kubernetes/server/bin/</span><br><span class="line">scp kubelet kube-proxy node1:/opt/kubernetes/bin</span><br><span class="line">scp kubelet kube-proxy node2:/opt/kubernetes/bin</span><br><span class="line">----------------------下面这些操作在所有node节点完成：---------------------------</span><br><span class="line">创建kubelet配置文件：</span><br><span class="line"># vim /opt/kubernetes/cfg/kubelet</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.13.142 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet.config \</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \</span><br><span class="line">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span><br><span class="line">===============================================================</span><br><span class="line">参数说明：</span><br><span class="line">* --hostname-override 在集群中显示的主机名（你改成node1，node2也可以）</span><br><span class="line">* --kubeconfig 指定kubeconfig文件位置，会自动生成</span><br><span class="line">* --bootstrap-kubeconfig 指定刚才生成的bootstrap.kubeconfig文件</span><br><span class="line">* --cert-dir 颁发证书存放位置</span><br><span class="line">* --pod-infra-container-image 管理Pod网络的镜像</span><br><span class="line">===============================================================</span><br><span class="line">其中/opt/kubernetes/cfg/kubelet.config配置文件如下：</span><br><span class="line"># vim /opt/kubernetes/cfg/kubelet.config</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 192.168.13.142</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [&quot;10.0.0.2&quot;]</span><br><span class="line">clusterDomain: cluster.local.</span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: true </span><br><span class="line">  webhook:</span><br><span class="line">    enabled: false</span><br><span class="line"></span><br><span class="line">systemd管理kubelet组件：</span><br><span class="line"># vim /usr/lib/systemd/system/kubelet.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl enable kubelet</span><br><span class="line"># systemctl start kubelet</span><br><span class="line"></span><br><span class="line">master节点：</span><br><span class="line">在Master审批Node加入集群：</span><br><span class="line">启动后还没加入到集群中，需要手动允许该节点才可以。</span><br><span class="line">在Master节点查看请求签名的Node：</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl get csr</span><br><span class="line">找到NAME</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl certificate approve 刚刚获取到的NAME</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl get node</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node节点：</span><br><span class="line">部署kube-proxy组件</span><br><span class="line">创建kube-proxy配置文件：</span><br><span class="line"># vim /opt/kubernetes/cfg/kube-proxy</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=true \</span><br><span class="line">--v=4 \</span><br><span class="line">--hostname-override=192.168.13.142 \</span><br><span class="line">--cluster-cidr=10.0.0.0/24 \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span><br><span class="line"></span><br><span class="line">systemd管理kube-proxy组件：</span><br><span class="line"># vim /usr/lib/systemd/system/kube-proxy.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl enable kube-proxy</span><br><span class="line"># systemctl start kube-proxy</span><br><span class="line"></span><br><span class="line">master节点：</span><br><span class="line">查看集群状态</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl get node</span><br><span class="line">NAME             STATUS    ROLES     AGE       VERSION</span><br><span class="line">192.168.13.142   Ready     &lt;none&gt;    1h        v1.11.0</span><br><span class="line">192.168.13.143   Ready     &lt;none&gt;    1h        v1.11.0</span><br><span class="line">[root@master ~]# /opt/kubernetes/bin/kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/09/23/markdown-mermiad%E6%B5%81%E7%A8%8B%E5%9B%BE%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/23/markdown-mermiad%E6%B5%81%E7%A8%8B%E5%9B%BE%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">markdown mermiad流程图使用方法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-09-23 11:56:00 / 修改时间：13:14:49" itemprop="dateCreated datePublished" datetime="2021-09-23T11:56:00+08:00">2021-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-what-is-mermiad"><a href="#1-what-is-mermiad" class="headerlink" title="1 what is mermiad?"></a>1 what is mermiad?</h3><p>mermaid是一个基于Javascript的图表和图表工具，用文本和代码创建图表和可视化, 可以动态创建和修改图表。</p>
<h3 id="2-mermaid实例"><a href="#2-mermaid实例" class="headerlink" title="2  mermaid实例"></a>2  mermaid实例</h3><p>这是怎么做到的呢？ </p>
<p>我们看看语法，以下语法来自<a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/">mermaid官网</a></p>
<h3 id="3-基本语法"><a href="#3-基本语法" class="headerlink" title="3 基本语法"></a>3 基本语法</h3><p>所有流程图都由节点、几何形状和边、箭头或线组成。mermiad代码定义了这些节点和边的制作和交互方式。</p>
<p>它还可以容纳不同类型的箭头、多方向箭头以及与子图的链接。</p>
<h4 id="3-1-流程图方向"><a href="#3-1-流程图方向" class="headerlink" title="3.1 流程图方向"></a>3.1 流程图方向</h4><p>流程图的方向有以下几种 :</p>
<ul>
<li>TB - top to bottom 由上至下</li>
<li>TD - top-down/ same as top to bottom 由上至下</li>
<li>BT - bottom to top 由下至上</li>
<li>RL - right to left 从右到左</li>
<li>LR - left to right 从左到右</li>
</ul>
<h3 id="3-2-节点形状"><a href="#3-2-节点形状" class="headerlink" title="3.2 节点形状"></a>3.2 节点形状</h3><p>即流程图中每个文本块，包括开始、结束、处理、判断等。Mermaid 中每个节点都有一个 id，以及节点的文字。</p>
<table>
<thead>
<tr>
<th><code>id[文字]</code></th>
<th>矩形节点</th>
</tr>
</thead>
<tbody><tr>
<td><code>id(文字)</code></td>
<td>圆角矩形节点</td>
</tr>
<tr>
<td><code>id([文字])</code></td>
<td>体育场型节点</td>
</tr>
<tr>
<td><code>id[[文字]]</code></td>
<td>子程序型节点</td>
</tr>
<tr>
<td><code>id[(文字)]</code></td>
<td>圆柱型节点</td>
</tr>
<tr>
<td><code>id((文字))</code></td>
<td>圆形节点</td>
</tr>
<tr>
<td><code>id&gt;文字]</code></td>
<td>右向旗帜状节点</td>
</tr>
<tr>
<td><code>id&#123;文字&#125;</code></td>
<td>菱形节点</td>
</tr>
<tr>
<td><code>id&#123;&#123;文字&#125;&#125;</code></td>
<td>六边形节点</td>
</tr>
<tr>
<td><code>id[/文字/]</code></td>
<td>平行四边形节点</td>
</tr>
<tr>
<td><code>id[\文字\]</code></td>
<td>反向平行四边形节点</td>
</tr>
<tr>
<td><code>id[/文字\]</code></td>
<td>梯型节点</td>
</tr>
<tr>
<td><code>id[\文字/]</code></td>
<td>向下梯型节点</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">id1(圆角矩形节点)---id2([体育场型节点])---id3[[子程序型节点]];</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">id1(圆角矩形节点)---id2([体育场型节点])---id3[[子程序型节点]];</span><br></pre></td></tr></table></figure>

<h3 id="3-3-线条、箭头形状"><a href="#3-3-线条、箭头形状" class="headerlink" title="3.3 线条、箭头形状"></a>3.3 线条、箭头形状</h3><table>
<thead>
<tr>
<th>表述</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>--&gt;</code></td>
<td>添加尾部箭头</td>
</tr>
<tr>
<td><code>---</code></td>
<td>不添加尾部箭头</td>
</tr>
<tr>
<td><code>----</code></td>
<td>单线</td>
</tr>
<tr>
<td><code>--text--</code></td>
<td>单线上加文字</td>
</tr>
<tr>
<td><code>--text--&gt;</code></td>
<td>箭头上加文字</td>
</tr>
<tr>
<td><code>==</code></td>
<td>粗线</td>
</tr>
<tr>
<td><code>==text==</code></td>
<td>粗线加文字</td>
</tr>
<tr>
<td><code>-.-</code></td>
<td>虚线</td>
</tr>
<tr>
<td><code>-.text.-</code></td>
<td>虚线加文字</td>
</tr>
<tr>
<td><code>o--o</code></td>
<td>双向圆点</td>
</tr>
<tr>
<td><code>&lt;--&gt;</code></td>
<td>双向箭头</td>
</tr>
<tr>
<td>`x–x</td>
<td>双向x</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">id1(1)---id2(2)--&gt;id3(3)--文字---id4(4);</span><br></pre></td></tr></table></figure>

<p><strong>线的加长或加粗</strong></p>
<table>
<thead>
<tr>
<th>Length</th>
<th>1</th>
<th>2</th>
<th>3</th>
</tr>
</thead>
<tbody><tr>
<td>线条</td>
<td><code>---</code></td>
<td><code>----</code></td>
<td><code>-----</code></td>
</tr>
<tr>
<td>箭头</td>
<td><code>--&gt;</code></td>
<td><code>---&gt;</code></td>
<td><code>----&gt;</code></td>
</tr>
<tr>
<td>加粗</td>
<td><code>===</code></td>
<td><code>====</code></td>
<td><code>=====</code></td>
</tr>
<tr>
<td>加粗箭头</td>
<td><code>==&gt;</code></td>
<td><code>===&gt;</code></td>
<td><code>====&gt;</code></td>
</tr>
<tr>
<td>加长点</td>
<td><code>-.-</code></td>
<td><code>-..-</code></td>
<td><code>-...-</code></td>
</tr>
<tr>
<td>加长点加箭头</td>
<td><code>-.-&gt;</code></td>
<td><code>-..-&gt;</code></td>
<td><code>-...-&gt;</code></td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[Start] --&gt; B&#123;Is it?&#125;;</span><br><span class="line">    B --&gt;|Yes| C[OK];</span><br><span class="line">    C --&gt; D[Rethink];</span><br><span class="line">    D --&gt; B;</span><br><span class="line">    B ----&gt;|No| E[End];</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[Start] --&gt; B&#123;Is it?&#125;;</span><br><span class="line">    B --&gt;|Yes| C[OK];</span><br><span class="line">    C --&gt; D[Rethink];</span><br><span class="line">    D --&gt; B;</span><br><span class="line">    B ----&gt;|No| E[End];</span><br></pre></td></tr></table></figure>



<h3 id="3-4-子图"><a href="#3-4-子图" class="headerlink" title="3.4 子图"></a>3.4 子图</h3><p>可以在流程中添加子图，语法简明，如下 ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">flowchart TB</span><br><span class="line">    c1--&gt;a2</span><br><span class="line">    subgraph one</span><br><span class="line">    a1--&gt;a2</span><br><span class="line">    end</span><br><span class="line">    subgraph two</span><br><span class="line">    b1--&gt;b2</span><br><span class="line">    end</span><br><span class="line">    subgraph three</span><br><span class="line">    c1--&gt;c2</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">flowchart TB</span><br><span class="line">    c1--&gt;a2</span><br><span class="line">    subgraph one</span><br><span class="line">    a1--&gt;a2</span><br><span class="line">    end</span><br><span class="line">    subgraph two</span><br><span class="line">    b1--&gt;b2</span><br><span class="line">    end</span><br><span class="line">    subgraph three</span><br><span class="line">    c1--&gt;c2</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<p>更多用法见官网</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuanwanli</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
