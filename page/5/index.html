<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yuanwanli1995.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/./public/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="等不是办法，干才有出路">
<meta property="og:type" content="website">
<meta property="og:title" content="brisk">
<meta property="og:url" content="http://yuanwanli1995.github.io/page/5/index.html">
<meta property="og:site_name" content="brisk">
<meta property="og:description" content="等不是办法，干才有出路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yuanwanli">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yuanwanli1995.github.io/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>brisk</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">brisk</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yuanwanli</p>
  <div class="site-description" itemprop="description">等不是办法，干才有出路</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">83</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/29/2021-12-29-tornado/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/29/2021-12-29-tornado/" class="post-title-link" itemprop="url">tornado</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-29 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-29T00:00:00+08:00">2021-12-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/27/2021-12-27-vscode--XHR-failed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/27/2021-12-27-vscode--XHR-failed/" class="post-title-link" itemprop="url">vscode--XHR failed</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-27 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-27T00:00:00+08:00">2021-12-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>问题： vscode 安装拓展失败， 报错<code> XHR failed</code></p>
<p>查了一通，是公司网络的原因， 另一台机器切换网络就可以了。 有一台机器网络固定的。</p>
<p>既然直接装不了，也可以离线装。 </p>
<ol>
<li>先到拓展仓库下载 </li>
</ol>
<p><a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/vscode">https://marketplace.visualstudio.com/vscode</a></p>
<ol start="2">
<li><p>extensions 更多选择从VSIX安装</p>
<p>要注意选择版本</p>
</li>
</ol>
<p>解决！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/23/2021-12-02-harbor%E6%98%AF%E4%BB%80%E4%B9%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/23/2021-12-02-harbor%E6%98%AF%E4%BB%80%E4%B9%88/" class="post-title-link" itemprop="url">harbor搭建、镜像推拉、主从备份</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-23 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-23T00:00:00+08:00">2021-12-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-harbor是什么"><a href="#1-harbor是什么" class="headerlink" title="1 harbor是什么"></a>1 harbor是什么</h3><p>Harbor是一个开源镜像仓库，它使用策略和基于角色的访问控制来保护镜像，确保镜像被扫描并没有漏洞，并将图像标记为受信任的。Harbor是CNCF的一个孵化的项目，提供合规、性能和互操作性，帮助您在Kubernetes和Docker等云本地计算平台上一致安全地管理工件。</p>
<p>简而言之， harbor就是跟docker hub差不多的镜像仓库，是一个开源仓库框架。  <a target="_blank" rel="noopener" href="https://demo.goharbor.io/">https://demo.goharbor.io</a>.这是官网提供的样本仓库，看看就明白了。 搭建出来的东西和这个是一样的。 类似的仓库也有不少，官方给出了比较。<a target="_blank" rel="noopener" href="https://goharbor.io/docs/2.4.0/install-config/harbor-compatibility-list/">Harbor docs | Harbor Compatibility List (goharbor.io)</a></p>
<h3 id="2-harbor特性"><a href="#2-harbor特性" class="headerlink" title="2 harbor特性"></a>2 harbor特性</h3><h3 id="3-harbor搭建"><a href="#3-harbor搭建" class="headerlink" title="3 harbor搭建"></a>3 harbor搭建</h3><p>harbor提供release, 搭建也很简单，只是harbor本身不提供证书， 需要第三方或自签的证书。  </p>
<h4 id="3-1-搭建harbor基本要求"><a href="#3-1-搭建harbor基本要求" class="headerlink" title="3.1 搭建harbor基本要求"></a>3.1 搭建harbor基本要求</h4><p><strong>硬件</strong></p>
<table>
<thead>
<tr>
<th align="left">Resource</th>
<th align="left">Minimum</th>
<th align="left">Recommended</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CPU</td>
<td align="left">2 CPU</td>
<td align="left">4 CPU</td>
</tr>
<tr>
<td align="left">Mem</td>
<td align="left">4 GB</td>
<td align="left">8 GB</td>
</tr>
<tr>
<td align="left">Disk</td>
<td align="left">40 GB</td>
<td align="left">160 GB</td>
</tr>
</tbody></table>
<p><strong>软件</strong></p>
<table>
<thead>
<tr>
<th align="left">Software</th>
<th align="left">Version</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Docker engine</td>
<td align="left">Version 17.06.0-ce+ or higher</td>
<td align="left">For installation instructions, see <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/installation/">Docker Engine documentation</a></td>
</tr>
<tr>
<td align="left">Docker Compose</td>
<td align="left">Version 1.18.0 or higher</td>
<td align="left">For installation instructions, see <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/">Docker Compose documentation</a></td>
</tr>
<tr>
<td align="left">Openssl</td>
<td align="left">Latest is preferred</td>
<td align="left">Used to generate certificate and keys for Harbor</td>
</tr>
</tbody></table>
<p><strong>网络</strong></p>
<table>
<thead>
<tr>
<th align="left">Port</th>
<th align="left">Protocol</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">443</td>
<td align="left">HTTPS</td>
<td align="left">Harbor portal and core API accept HTTPS requests on this port. You can change this port in the configuration file.</td>
</tr>
<tr>
<td align="left">4443</td>
<td align="left">HTTPS</td>
<td align="left">Connections to the Docker Content Trust service for Harbor. Only required if Notary is enabled. You can change this port in the configuration file.</td>
</tr>
<tr>
<td align="left">80</td>
<td align="left">HTTP</td>
<td align="left">Harbor portal and core API accept HTTP requests on this port. You can change this port in the configuration file.</td>
</tr>
</tbody></table>
<h3 id="3-2-配置HTTPS访问harbor"><a href="#3-2-配置HTTPS访问harbor" class="headerlink" title="3.2  配置HTTPS访问harbor"></a>3.2  配置HTTPS访问harbor</h3><p>Harbor不提供证书。所以配置HTTPS时，需要先创建SSL证书。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">mkdir harbor &amp;&amp; cd harbor</span><br><span class="line"># 生成CA证书私钥</span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line"></span><br><span class="line"># 生成CA证书</span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line"> -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=myharbor.com&quot; \</span><br><span class="line"> -key ca.key \</span><br><span class="line"> -out ca.crt</span><br><span class="line"> </span><br><span class="line"># 生成服务器证书, 证书通常包含一个.crt文件和一个.key文件，例如myharbor.com.crt和myharbor.com.key</span><br><span class="line">openssl genrsa -out myharbor.com.key 4096</span><br><span class="line"></span><br><span class="line"># 生成证书签名请求(CSR) </span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">    -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=myharbor.com&quot; \</span><br><span class="line">    -key myharbor.com.key \</span><br><span class="line">    -out myharbor.com.csr</span><br><span class="line">    </span><br><span class="line"># 生成x509 v3扩展文件 </span><br><span class="line">cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1=myharbor.com</span><br><span class="line">DNS.2=myharbor</span><br><span class="line">DNS.3=hostname</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 使用v3.ext文件为Harbor主机生成证书 </span><br><span class="line">openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -in myharbor.com.csr \</span><br><span class="line">    -out myharbor.com.crt </span><br><span class="line">    </span><br><span class="line"># 向harbor和docker提供证书 </span><br><span class="line"># 将服务器证书和密钥复制到您的Harbor host的证书文件夹中</span><br><span class="line">mkdir /data/cert/ </span><br><span class="line">cp myharbor.com.crt /data/cert/</span><br><span class="line">cp myharbor.com.key /data/cert/</span><br><span class="line"></span><br><span class="line"># 将.crt转换为.cert，以供Docker使用</span><br><span class="line">openssl x509 -inform PEM -in /data/cert/myharbor.com.crt -out /data/cert/myharbor.com.cert</span><br><span class="line"></span><br><span class="line"># 将服务器证书、密钥和CA文件复制到Harbor主机的Docker证书文件夹中 </span><br><span class="line">mkdir -p /etc/docker/certs.d/myharbor.com/</span><br><span class="line">cp myharbor.com.cert /etc/docker/certs.d/myharbor.com/</span><br><span class="line">cp myharbor.com.key /etc/docker/certs.d/myharbor.com/</span><br><span class="line">cp ca.crt /etc/docker/certs.d/myharbor.com/ </span><br><span class="line"></span><br><span class="line"># 查看证书</span><br><span class="line">[root@k8s-node02 harbor]# ll -a</span><br><span class="line">-rw-r--r--  1 root root 2029 Dec 23 15:37 ca.crt</span><br><span class="line">-rw-r--r--  1 root root 3243 Dec 23 15:37 ca.key</span><br><span class="line">-rw-r--r--  1 root root   17 Dec 23 15:41 ca.srl</span><br><span class="line">-rw-r--r--  1 root root 2090 Dec 23 15:42 myharbor.com.cert</span><br><span class="line">-rw-r--r--  1 root root 2090 Dec 23 15:41 myharbor.com.crt</span><br><span class="line">-rw-r--r--  1 root root 1704 Dec 23 15:40 myharbor.com.csr</span><br><span class="line">-rw-r--r--  1 root root 3243 Dec 23 15:40 myharbor.com.key</span><br><span class="line">-rw-r--r--  1 root root  261 Dec 23 15:41 v3.ext</span><br><span class="line"></span><br><span class="line"># 重启docker </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="3-3-下载安装包"><a href="#3-3-下载安装包" class="headerlink" title="3.3 下载安装包"></a>3.3 下载安装包</h3><p>分为在线安装和离线两种， 都是一样的，按需选择。 这里我们直接选择在线安装，安装包小一点</p>
<p>下载<a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">Releases · goharbor/harbor (github.com)</a></p>
<p>这里我选择最新版本，<code> harbor-online-installer-v2.4.1.tgz</code>  ，版本按需选择</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 解压 </span><br><span class="line">[root@k8s-node02 harbor]# tar -xvf  harbor-online-installer-v2.4.1.tgz</span><br><span class="line">[root@k8s-node02 harbor]# ll</span><br><span class="line">total 48</span><br><span class="line">-rw-r--r-- 1 root root 2029 Dec 23 15:37 ca.crt</span><br><span class="line">-rw-r--r-- 1 root root 3243 Dec 23 15:37 ca.key</span><br><span class="line">-rw-r--r-- 1 root root   17 Dec 23 15:41 ca.srl</span><br><span class="line">drwxr-xr-x 2 root root 4096 Dec 23 15:46 harbor</span><br><span class="line">-rw-r--r-- 1 root root 9844 Dec 23 15:45 harbor-online-installer-v2.4.1.tgz</span><br><span class="line">-rw-r--r-- 1 root root 2090 Dec 23 15:42 myharbor.com.cert</span><br><span class="line">-rw-r--r-- 1 root root 2090 Dec 23 15:41 myharbor.com.crt</span><br><span class="line">-rw-r--r-- 1 root root 1704 Dec 23 15:40 myharbor.com.csr</span><br><span class="line">-rw-r--r-- 1 root root 3243 Dec 23 15:40 myharbor.com.key</span><br><span class="line">-rw-r--r-- 1 root root  261 Dec 23 15:41 v3.ext</span><br><span class="line">[root@k8s-node02 harbor]# cd harbor/</span><br><span class="line">[root@k8s-node02 harbor]# ll</span><br><span class="line">total 36</span><br><span class="line">-rw-r--r-- 1 root root  3361 Dec 16 12:24 common.sh</span><br><span class="line">-rw-r--r-- 1 root root  8999 Dec 16 12:24 harbor.yml.tmpl</span><br><span class="line">-rwxr-xr-x 1 root root  2500 Dec 16 12:24 install.sh</span><br><span class="line">-rw-r--r-- 1 root root 11347 Dec 16 12:24 LICENSE</span><br><span class="line">-rwxr-xr-x 1 root root  1881 Dec 16 12:24 prepare</span><br></pre></td></tr></table></figure>



<h3 id="3-4-配置harbor-yml"><a href="#3-4-配置harbor-yml" class="headerlink" title="3.4 配置harbor.yml"></a>3.4 配置harbor.yml</h3><p>在harbor.yml中配置harbor,</p>
<p>这些参数在运行install.sh脚本安装或重新配置Harbor时生效。</p>
<p>在初始部署和启动Harbor之后，也可以在Harbor Web中执行额外的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cp  harbor.yml.tmpl  harbor.yml</span><br><span class="line">vim  harbor.yml</span><br><span class="line"># 至少要配置hostname 与 证书路径</span><br><span class="line">hostname: myharbor.com</span><br><span class="line"># https related config</span><br><span class="line">https:</span><br><span class="line">  # https port for harbor, default is 443</span><br><span class="line">  port: 443</span><br><span class="line">  # The path of cert and key files for nginx</span><br><span class="line">  certificate: /data/cert/myharbor.com.cert</span><br><span class="line">  private_key: /data/cert/myharbor.com.key</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 配置生效 </span><br><span class="line">./prepare</span><br><span class="line"># 部署</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<p>然后仓库就搭建好了，本地修改hosts就可以通过域名访问，或直接通过ip访问</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/harbor.png"></p>
<p>参数如下，来自官网<a target="_blank" rel="noopener" href="https://goharbor.io/docs/2.4.0/install-config/configure-yml-file/">Harbor docs | Configure the Harbor YML File (goharbor.io)</a></p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">子参数</th>
<th align="left">用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>hostname</code></td>
<td align="left">None</td>
<td align="left">指定要部署Harbor的目标主机的IP地址或完全限定域名(FQDN)。这是您访问harbor和注册服务的地址。例如，“192.168.1.10”或“reg.yourdomain.com”。注册表服务必须能够被外部客户端访问，所以不要指定’ localhost ‘、’ 127.0.0.1 ‘或’ 0.0.0.0 ‘作为主机名。</td>
</tr>
<tr>
<td align="left"><code>http</code></td>
<td align="left"></td>
<td align="left">不要在生产环境中使用HTTP。只有在没有连接到外部internet的测试或开发环境中，才可以接受使用HTTP。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>port</code></td>
<td align="left">HTTP的端口号，海港门户和Docker命令。默认值是80。</td>
</tr>
<tr>
<td align="left"><code>https</code></td>
<td align="left"></td>
<td align="left">使用HTTPS访问海港门户和令牌/通知服务。在生产环境和没有气隙隔离的环境中始终使用HTTPS。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>port</code></td>
<td align="left">使用HTTPS访问海港门户和令牌/通知服务。在生产环境和没有气隙隔离的环境中始终使用HTTPS。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>certificate</code></td>
<td align="left">SSL证书的路径</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>private_key</code></td>
<td align="left">SSL密钥的路径。</td>
</tr>
<tr>
<td align="left"><code>internal_tls</code></td>
<td align="left"></td>
<td align="left">使用HTTPS在港口组件之间通信</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>enabled</code></td>
<td align="left">将该标志设置为“true”意味着启用了内部tls</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>dir</code></td>
<td align="left">包含内部证书和密钥的目录的路径</td>
</tr>
<tr>
<td align="left"><code>harbor_admin_password</code></td>
<td align="left">None</td>
<td align="left">设置Harbor系统管理员的初始密码。此密码仅在第一次启动Harbor时使用。在随后的登录中，将忽略此设置，并在Harbor Portal中设置管理员密码。默认用户名和密码为“admin”和“Harbor12345”。</td>
</tr>
<tr>
<td align="left"><code>database</code></td>
<td align="left"></td>
<td align="left">使用本地PostgreSQL数据库。您可以选择配置一个外部数据库，在这种情况下，您可以禁用这个选项。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>password</code></td>
<td align="left">使用本地PostgreSQL数据库。您可以选择配置一个外部数据库，在这种情况下，您可以禁用这个选项。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>max_idle_conns</code></td>
<td align="left">空闲连接池中的最大连接数。如果设置为&lt;=0，则不保留空闲连接。缺省值是50。如果不配置，则为2。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>max_open_conns</code></td>
<td align="left">‘数据库的最大打开连接数。如果&lt;= 0，则没有打开连接的数量限制。对于到Harbor数据库的最大连接，默认值是100。如果不配置，则为0。</td>
</tr>
<tr>
<td align="left"><code>data_volume</code></td>
<td align="left">None</td>
<td align="left">**目标主机上存储Harbor数据的位置。即使在移除和/或重新创建Harbor的集装箱时，该数据也保持不变。您可以选择配置外部存储，在这种情况下禁用该选项并启用’ storage_service ‘。默认值是’ /data ‘。</td>
</tr>
<tr>
<td align="left"><code>trivy</code></td>
<td align="left"></td>
<td align="left">配置 Trivy 扫描.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>ignore_unfixed</code></td>
<td align="left">将标志设置为“true”，只显示已修复的漏洞。默认值为“false”。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>skip_update</code></td>
<td align="left">您可能希望在测试或CI/CD环境中启用此标志，以避免GitHub速率限制问题。如果启用了该标志，你必须手动下载“trivy-offline.tar.gz”存档文件，提取“trivy.db”和“元数据”。Json ‘文件，并将它们挂载到容器的’ /home/scanner/.cache/trivy/db/trivy.db ‘路径下。默认值为“false”。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>insecure</code></td>
<td align="left">设置标志为true，跳过验证注册表证书。默认值为“false”。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">`github_token</td>
<td align="left">‘设置GitHub访问令牌下载Trivy DB。Trivy DB由Trivy从GitHub发布页面下载。从GitHub匿名下载受每小时60次请求的限制。通常，这样的速率限制对于生产操作来说已经足够了。如果出于任何原因，这还不够，你可以通过指定GitHub访问令牌将速率限制到每小时5000个请求。有关GitHub速率限制的更多信息，请咨询<a target="_blank" rel="noopener" href="https://developer.github.com/v3/#rate-limiting%E3%80%82%E6%82%A8%E5%8F%AF%E4%BB%A5%E6%8C%89%E7%85%A7https://help.github.com/en/github/authen%E4%B8%AD%E7%9A%84%E8%AF%B4%E6%98%8E%E5%88%9B%E5%BB%BAGitHub%E4%BB%A4%E7%89%8C">https://developer.github.com/v3/#rate-limiting。您可以按照https://help.github.com/en/github/authen中的说明创建GitHub令牌</a></td>
</tr>
<tr>
<td align="left"><code>jobservice</code></td>
<td align="left"><code>max_job_workers</code></td>
<td align="left">作业服务中复制工作者的最大数量。对于每个映像复制作业，一个工作人员将存储库中的所有标记同步到远程目标。增加这个数量将允许系统中有更多的并发复制作业。但是，由于每个worker都会消耗一定数量的网络/CPU/IO资源，因此需要根据主机的硬件资源来设置该属性的值。默认值是10。</td>
</tr>
<tr>
<td align="left"><code>notification</code></td>
<td align="left"><code>webhook_job_max_retry</code></td>
<td align="left">设置web hook任务的最大重试次数。默认值是10。</td>
</tr>
<tr>
<td align="left"><code>chart</code></td>
<td align="left"><code>absolute_url</code></td>
<td align="left">设置为“启用”，以便Chart使用绝对URL。设置为’ disabled ‘以便Chart使用相对URL。</td>
</tr>
<tr>
<td align="left"><code>log</code></td>
<td align="left"></td>
<td align="left">配置日志记录。Harbor使用’ rsyslog ‘来收集每个容器的日志</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>level</code></td>
<td align="left">将日志级别设置为“debug”、“info”、“warning”、“error”或“fatal”。默认为’ info ‘。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>local</code></td>
<td align="left">设置日志保留参数:’ rotate_count ‘:日志文件在被删除之前会旋转’ rotate_count ‘多次。如果count为0，则删除旧版本而不是旋转。默认值是50。’ rotate_size ‘:日志文件只有在增长大于’ rotate_size ‘字节时才会被旋转。k表示千字节，M表示兆字节，G表示千兆字节。‘100’、‘100k’、‘100M’和‘100G’都是有效值。默认为200M。’ location ‘:设置存储日志的目录。默认值是’ /var/log/harbor ‘。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>external_endpoint</code></td>
<td align="left">启用此选项，将日志转发到syslog服务器。“protocol”:syslog服务器的传输协议。默认是TCP。’ host ‘: syslog服务器的URL。’ port ‘: syslog服务器监听的端口</td>
</tr>
<tr>
<td align="left"><code>proxy</code></td>
<td align="left"></td>
<td align="left"><em>：</em>配置代理以供普通适配器、复制jobservice和Harbor使用。如果不需要代理，请留空。一些代理服务器有白名单设置，如果Trivy是启用的，你需要添加以下url到代理服务器白名单:’ github-releases.githubusercontent.com ‘，和’ *.s3. amazonaws.com/ ‘。</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>http_proxy</code></td>
<td align="left">Configure an HTTP proxy, for example, <code>http://my.proxy.com:3128</code>.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>https_proxy</code></td>
<td align="left">Configure an HTTPS proxy, for example, <code>http://my.proxy.com:3128</code>.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>no_proxy</code></td>
<td align="left">Configure when not to use a proxy, for example, <code>127.0.0.1,localhost,core,registry</code>.</td>
</tr>
</tbody></table>
<h2 id="可选参数-Parameters"><a href="#可选参数-Parameters" class="headerlink" title="可选参数 Parameters"></a>可选参数 Parameters</h2><p>The following table lists the additional, optional parameters that you can set to configure your Harbor deployment beyond the minimum required settings. To enable a setting, you must uncomment it in <code>harbor.yml</code> by deleting the leading <code>#</code> character.</p>
<table>
<thead>
<tr>
<th align="left">Parameter</th>
<th align="left">Sub-Parameters</th>
<th align="left">Description and Additional Parameters</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>external_url</code></td>
<td align="left">None</td>
<td align="left">Enable this option to use an external proxy. When enabled, the hostname is no longer used.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><code>storage_service</code></td>
<td align="left"></td>
<td align="left">By default, Harbor stores images and charts on your local filesystem. In a production environment, you might want to use another storage backend instead of the local filesystem. The parameters listed below are the configurations for the registry. See <em>Configuring Storage Backend</em> below for more information about how to configure a different backend.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>ca_bundle</code></td>
<td align="left">The path to the custom root CA certificate, which is injected into the trust store of registry and chart repository containers. This is usually needed if internal storage uses a self signed certificate.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>filesystem</code></td>
<td align="left">The default is <code>filesystem</code>, but you can set <code>azure</code>, <code>gcs</code>, <code>s3</code>, <code>swift</code> and <code>oss</code>. For information about how to configure other backends, see <a target="_blank" rel="noopener" href="https://goharbor.io/docs/2.4.0/install-config/configure-yml-file/#backend">Configuring a Storage Backend</a> below. Set <code>maxthreads</code> to limit the number of threads to the external provider. The default is 100.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>redirect</code></td>
<td align="left">Set <code>disable</code> to <code>true</code> when you want to disable registry redirect</td>
</tr>
<tr>
<td align="left"><code>external_database</code></td>
<td align="left"></td>
<td align="left">Configure external database settings, if you disable the local database option. Currently, Harbor only supports PostgreSQL database. You must create three databases for Harbor core, Notary server, and Notary signer. The tables are generated automatically when Harbor starts up.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>harbor</code></td>
<td align="left">Configure an external database for Harbor data.<code>host</code>: Hostname of the Harbor database.<code>port</code>: Database port.<code>db_name</code>: Database name.<code>username</code>: Username to connect to the core Harbor database.<code>password</code>: Password for the account you set in <code>username</code>.<code>ssl_mode</code>: Enable SSL mode.<code>max_idle_conns</code>: The maximum number of connections in the idle connection pool. If &lt;=0 no idle connections are retained. The default value is 2.<code>max_open_conns</code>: The maximum number of open connections to the database. If &lt;= 0 there is no limit on the number of open connections. The default value is 0.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>notary_signer</code></td>
<td align="left">Configure an external database for the Notary signer database<code>host</code>: Hostname of the Notary signer database<code>port</code>: Database port.<code>db_name</code>: Database name.<code>username</code>: Username to connect to the Notary signer database.<code>password</code>: Password for the account you set in <code>username</code>.<code>ssl_mode</code>: Enable SSL mode.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>notary_server</code></td>
<td align="left"><code>host</code>: Hostname of the Notary server database.<code>port</code>: Database port.<code>db_name</code>: Database name.<code>username</code>: Username to connect to the Notary server database.<code>password</code>: Password for the account you set in <code>username</code>.<code>ssl_mode</code>: Enable SSL mode.e</td>
</tr>
<tr>
<td align="left"><code>external_redis</code></td>
<td align="left"></td>
<td align="left">Configure an external Redis instance.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>host</code></td>
<td align="left">redis_host:redis_port of the external Redis instance. If you are using Sentinel mode, this part should be host_sentinel1:port_sentinel1,host_sentinel2:port_sentinel2</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>sentinel_master_set</code></td>
<td align="left">Only set this when using Sentinel mode</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>password</code></td>
<td align="left">Password to connect to the external Redis instance.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>registry_db_index</code></td>
<td align="left">Database index for Harbor registry.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>jobservice_db_index</code></td>
<td align="left">Database index for jobservice.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>chartmuseum_db_index</code></td>
<td align="left">Database index for Chart museum.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>trivy_db_index</code></td>
<td align="left">Database index for Trivy adapter.</td>
</tr>
<tr>
<td align="left"><code>metric</code></td>
<td align="left"></td>
<td align="left">Configure exposing Harbor instance metrics to a specified port and path</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>enabled</code></td>
<td align="left">Enable exposing metrics on your Harbor instance by setting this to <code>true</code>. Default is <code>false</code></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>port</code></td>
<td align="left">Port metrics are exposed on. Default is <code>9090</code></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>path</code></td>
<td align="left">Path metrics are exposed on. Default is <code>/metrics</code></td>
</tr>
<tr>
<td align="left"><code>trace</code></td>
<td align="left"></td>
<td align="left">Configure exposing Distributed tracing data</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>enabled</code></td>
<td align="left">Enable exposing tracing on your Harbor instance by setting this to <code>true</code>. Default is <code>false</code></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>sample_rate</code></td>
<td align="left">Set the sample rate of tracing. For example, set sample_rate to <code>1</code> if you wanna sampling 100% of trace data; set <code>0.5</code> if you wanna sampling 50% of trace data, and so forth</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>namespace</code></td>
<td align="left">Namespace used to differenciate different harbor services, which will set to attribute with key <code>service.namespace</code></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>attributes</code></td>
<td align="left">The attributes is a key value dict contains user defined customized attributes used to initialize trace provider, and all of these atributes will added to trace data</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>jaeger</code></td>
<td align="left"><code>endpoint</code>: The url of endpoint(for example <code>http://127.0.0.1:14268/api/traces</code>). set endpoint means export to jaeger collector via http.<code>username:</code>: Username used to connect endpoint. Left empty if not needed.<code>password:</code>: Password used to connect endpoint. Left empty if not needed.<code>agent_host</code>: The host name of jaeger agent. Set agent_host means export data to jaeger agent via udp.<code>agent_port:</code>: The port name of jaeger agent.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><code>otel</code></td>
<td align="left"><code>endpoint</code>: The hostname and port for otel compitable backend(for example <code>127.0.0.1:4318</code>).<code>url_path:</code>: The url path of endpoint(for example <code>127.0.0.1:4318</code>)<code>compression:</code>: If enabling data compression<code>insecure</code>: Ignore cert verification for otel backend<code>timeout:</code>: The timeout of data transfer</td>
</tr>
</tbody></table>
<h3 id="3-镜像推送"><a href="#3-镜像推送" class="headerlink" title="3 镜像推送"></a>3 镜像推送</h3><p>镜像推送也很方便，现在仓库web中新建账户zhangsan，再新建项mytest, 在项目中添加zhangsan. 就可以在项目-&gt;镜像仓库中看到推拉镜像的参考命令。十分的人性化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/harbor2.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 登陆到harbor </span><br><span class="line">[root@k8s-node02 harbor]# docker login myharbor.com</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id=""><a href="#" class="headerlink" title=""></a></h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/20/2021-12-20-%E9%A1%B9%E7%9B%AE-rancher%E5%A4%9A%E9%9B%86%E7%BE%A4%E6%B1%87%E6%80%BB%E5%B1%95%E7%A4%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/20/2021-12-20-%E9%A1%B9%E7%9B%AE-rancher%E5%A4%9A%E9%9B%86%E7%BE%A4%E6%B1%87%E6%80%BB%E5%B1%95%E7%A4%BA/" class="post-title-link" itemprop="url">项目-rancher多集群汇总展示</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-20 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-20T00:00:00+08:00">2021-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="rancher多集群汇总展示"><a href="#rancher多集群汇总展示" class="headerlink" title="rancher多集群汇总展示"></a>rancher多集群汇总展示</h1><h2 id="1-需求"><a href="#1-需求" class="headerlink" title="1 需求"></a>1 需求</h2><p> rancher管理集群越来越多， 而rancher自己提供的可视化只能提供单个集群的状态可视化，集群过多时，看起来过于麻烦，如何快速把握所有集群的状态呢？我们想做一个集群汇总的可视化，可以看到 所有集群或者重点集群的信息汇总，如果总的cpu, 储存，pod数等。组件状态等。</p>
<h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2 解决方案"></a>2 解决方案</h2><h4 id="1-rancher-api"><a href="#1-rancher-api" class="headerlink" title="1 rancher api"></a>1 rancher api</h4><p>通过Rancher提供的api，抓取所有集群的数据，导入到时序数据库,如influxDB，在通过grafana导入数据，展示数据。 </p>
<p><strong>问题</strong>:<br>1 rancher api数据为json格式， 数据项较多， 需要筛选，且木有找到类似的解决方法，重新造轮子，工作量较大。<br>2 依赖rancher稳定性，单节点rancher不太适用</p>
<p><strong>优势</strong><br>1 搭建好之后，后续的工作量可能较小，只要rancher导入rancher管理，那么就可以监控到。</p>
<h4 id="2-多prometheus-grafana"><a href="#2-多prometheus-grafana" class="headerlink" title="2 多prometheus+grafana"></a>2 多prometheus+grafana</h4><p>搭建1套独立的grafana，配置所有集群的prometheus数据源，load重点监控的json文件，例如overview，以集群为单位，进行展示。</p>
<p><strong>优势</strong><br>1 promethus，grafana是成熟的解决方法，做起来简单，<strong>工作重点</strong>在于不同数据源的数据如何汇总展示。<br>2 直接从集群获取数据，不依赖rancher的稳定性<br><strong>问题</strong><br>1 每个集群都需要额外部署服务，这样比较麻烦。</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h4 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h4><p>由于没有方案可以参考，需要选择数据库和可视化组件。<br>数据可选的有graphite, openTSDB, influxDB<br>可视化组件可选 grafana, dataV</p>
<p>rancher api 获得的数据是json格式， 如何存储json格式的数据，</p>
<p>学习了第一套架构。<br>Telegraf+InfluxDB+Grafana自动化运维<br>influxdb 用起来并不复查，用法跟sql差不多，解决了存储的问题。<br>现在的问题<br>1.怎么把rancher api 的数据导入数据库。<br>2。多设备监控如何汇总 </p>
<p>转存数据，学习数据结构含义， 以及数据查询都是问题。 </p>
<h4 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h4><p>经过实测，多个prometheus + influxdb + grafana ， 每个都是成熟的组件， 之间无缝连接。</p>
<p>现在依然存在的问题： </p>
<ol>
<li>  官方的exporter default 的collectors太多了，有很多我们需要的数据。  </li>
</ol>
<p>解决， node exporter的github上面看到可以配置不需要的collectors.  如下：</p>
<h3 id="Filtering-enabled-collectors"><a href="#Filtering-enabled-collectors" class="headerlink" title="Filtering enabled collectors"></a>Filtering enabled collectors</h3><p>The <code>node_exporter</code> will expose all metrics from enabled collectors by default. This is the recommended way to collect metrics to avoid errors when comparing metrics of different families.</p>
<p>For advanced use the <code>node_exporter</code> can be passed an optional list of collectors to filter metrics. The <code>collect[]</code> parameter may be used multiple times. In Prometheus configuration you can use this syntax under the <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#">scrape config</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">params:</span><br><span class="line">  collect[]:</span><br><span class="line">    - foo</span><br><span class="line">    - bar</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>  每个集群都配置一套prometheus，会极大增加集群负担。 看看能不能只部署expoter, 理论上是可以的，还没有尝试。</li>
</ol>
<p>   解决： 可以， exporter 暴露http接口， prometheus抓取数据。    </p>
<ol start="3">
<li> 每个数据中心自定义标签问题，否则无法安装集群来展示。</li>
</ol>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="监控指标"><a href="#监控指标" class="headerlink" title="监控指标"></a>监控指标</h2><p>1.网络<br>2..存储<br>3.主机数<br>4pod数<br>sum(kubelet_running_pod_count{}) </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/16/2021-11-16-%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAk8s%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/16/2021-11-16-%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAk8s%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">使用kubeadm快速部署一个k8s集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-16 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-16T00:00:00+08:00">2021-12-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p>
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<h2 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1. 安装要求"></a>1. 安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2. 准备环境"></a>2. 准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.1.11</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.12</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.13</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"># 关闭selinux</span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">setenforce 0  # 临时</span><br><span class="line"></span><br><span class="line"># 关闭swap</span><br><span class="line">swapoff -a  # 临时</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # 永久</span><br><span class="line"></span><br><span class="line"># 根据规划设置主机名</span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"># 在master添加hosts</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.2.13 k8smaster</span><br><span class="line">192.168.2.10 k8snode1</span><br><span class="line">192.168.2.11 k8snode2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链</span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"># 生效</span><br><span class="line">sysctl --system  </span><br><span class="line"></span><br><span class="line"># 时间同步</span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h2 id="3-所有节点安装Docker-kubeadm-kubelet"><a href="#3-所有节点安装Docker-kubeadm-kubelet" class="headerlink" title="3. 所有节点安装Docker/kubeadm/kubelet"></a>3. 所有节点安装Docker/kubeadm/kubelet</h2><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="3-1-安装Docker"><a href="#3-1-安装Docker" class="headerlink" title="3.1 安装Docker"></a>3.1 安装Docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#安装wget</span><br><span class="line">yum install wget </span><br><span class="line">#下载docker包</span><br><span class="line">wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"># 安装docker</span><br><span class="line">yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line"># 设置docker自启动</span><br><span class="line">ystemctl enable docker </span><br><span class="line"># 启动docker</span><br><span class="line">systemctl start docker</span><br><span class="line"># 检查docker是否安装成功</span><br><span class="line">docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 配置docker阿里云镜像 </span><br><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"># 重启docker </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="3-2-添加阿里云yum软件源"><a href="#3-2-添加阿里云yum软件源" class="headerlink" title="3.2 添加阿里云yum软件源"></a>3.2 添加阿里云yum软件源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-3-安装kubeadm，kubelet和kubectl"><a href="#3-3-安装kubeadm，kubelet和kubectl" class="headerlink" title="3.3 安装kubeadm，kubelet和kubectl"></a>3.3 安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<h2 id="4-部署Kubernetes-Master"><a href="#4-部署Kubernetes-Master" class="headerlink" title="4. 部署Kubernetes Master"></a>4. 部署Kubernetes Master</h2><p>在192.168.2.13（Master）执行。由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --apiserver-advertise-address=192.168.2.13 </span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers </span><br><span class="line">  --kubernetes-version v1.18.0 </span><br><span class="line">  --service-cidr=10.96.0.0/12 </span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>结果如下即成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.2.13:6443 --token tb681z.zr2l20onx60p0rlc \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:eb0df9f6cdf57a160187b61f45b7465f85a3f9cdfb84077c8754fc0ad8c8d8b6 </span><br></pre></td></tr></table></figure>

<p>使用kubectl工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="comment"># 查看节点</span></span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<h2 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5. 加入Kubernetes Node"></a>5. 加入Kubernetes Node</h2><p>在192.168.1.10/11（Node）执行。</p>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.2.13:6443 --token tb681z.zr2l20onx60p0rlc \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:eb0df9f6cdf57a160187b61f45b7465f85a3f9cdfb84077c8754fc0ad8c8d8b6</span><br></pre></td></tr></table></figure>

<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<h2 id="6-部署CNI网络插件"><a href="#6-部署CNI网络插件" class="headerlink" title="6. 部署CNI网络插件"></a>6. 部署CNI网络插件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 镜像地址可能无法访问，先添加/etc/hosts</span><br><span class="line">199.232.68.133 raw.githubusercontent.com</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 安装kube-flannel</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1/1     Running   0          72s</span><br></pre></td></tr></table></figure>

<h2 id="7-测试kubernetes集群"><a href="#7-测试kubernetes集群" class="headerlink" title="7. 测试kubernetes集群"></a>7. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/15/2021-12-14-influxdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/15/2021-12-14-influxdb/" class="post-title-link" itemprop="url">influxdb</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-15T00:00:00+08:00">2021-12-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>97  2021-12-10 16:05:20 wget  <a target="_blank" rel="noopener" href="https://dl.influxdata.com/influxdb/releases/influxdb-1.8.0.x86_64.rpm">https://dl.influxdata.com/influxdb/releases/influxdb-1.8.0.x86_64.rpm</a><br>   98  2021-12-10 16:06:43 yum localinstall -y influxdb-1.8.0.x86_64.rpm</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/15/2021-12-15-git%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%9A%84%E5%B8%B8%E8%A7%84%E7%94%A8%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/15/2021-12-15-git%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%9A%84%E5%B8%B8%E8%A7%84%E7%94%A8%E6%B3%95/" class="post-title-link" itemprop="url">git版本控制的常规用法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-15T00:00:00+08:00">2021-12-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-21 09:42:57" itemprop="dateModified" datetime="2022-03-21T09:42:57+08:00">2022-03-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<p>最近在改服务器上改代码的时候，每次都要在本地备份，有时在本地改完还要同步，搞多个版本把我自己都搞乱了，是时候使用git了。 我的需求之一就是在多台机器上操作，能够同步，在服务器上能下载最新的版本， 更改后再更新到仓库，git可以解决我的需求，github作为仓库，有的时候网络不稳定，gitee更快一点，所以就选择gitee作为远程仓库。</p>
<h3 id="gitee"><a href="#gitee" class="headerlink" title="gitee"></a>gitee</h3><p>首先要创建gitee账户，再新建仓库。 </p>
<h3 id="linux系统"><a href="#linux系统" class="headerlink" title="linux系统"></a>linux系统</h3><p>安装git , 配置密钥，然后就可以拉取或者更新。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 源里有git，直接yum安装即可</span><br><span class="line">yum -y install git</span><br><span class="line"># 新建一个文件夹，作为gitee仓库交互的仓库</span><br><span class="line">mkdir gitee &amp;&amp; cd gitee </span><br><span class="line"># git 初始化</span><br><span class="line">git init </span><br><span class="line"># 初始化一个.git文件，是一个工作目录， 保存status, 克隆是不需要的.git的, 查找.git顺序， 同级目录，上级目录。</span><br><span class="line"># 配置用户</span><br><span class="line">git config --global user.name &quot;yuanwl&quot;</span><br><span class="line">git config --global user.email &quot;yuan.wanli@qq.com&quot;</span><br><span class="line"># 配置远端地址 - 目标远程仓库的下载链接 #origin 远端仓库本地名称</span><br><span class="line">git remote add origin https://gitee.com/yuanwl/k8s.git</span><br><span class="line"># 会生成一些配置文件，看一下</span><br><span class="line">[root@node61 gitee]# ll -a</span><br><span class="line">drwxr-xr-x   8 root root 4096 Dec 15 15:39 .git</span><br><span class="line">[root@node61 gitee]# ll -a .git/</span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x  2 root root 4096 Dec 15 10:39 branches </span><br><span class="line"># 分支</span><br><span class="line">-rw-r--r--  1 root root    5 Dec 15 15:31 COMMIT_EDITMSG</span><br><span class="line"># commit 信息  </span><br><span class="line">-rw-r--r--  1 root root  352 Dec 15 15:39 config  ---远端配置文件在这里</span><br><span class="line"># 配置文件</span><br><span class="line">-rw-r--r--  1 root root   73 Dec 15 10:39 description</span><br><span class="line">-rw-r--r--  1 root root   82 Dec 15 14:35 FETCH_HEAD</span><br><span class="line">-rw-r--r--  1 root root   23 Dec 15 10:39 HEAD</span><br><span class="line">drwxr-xr-x  2 root root 4096 Dec 15 10:39 hooks</span><br><span class="line"># 命令</span><br><span class="line">-rw-r--r--  1 root root 1241 Dec 15 15:30 index</span><br><span class="line">drwxr-xr-x  2 root root 4096 Dec 15 10:39 info </span><br><span class="line">drwxr-xr-x  3 root root 4096 Dec 15 10:45 logs</span><br><span class="line"># 日志</span><br><span class="line">drwxr-xr-x 55 root root 4096 Dec 15 14:56 objects </span><br><span class="line">-rw-r--r--  1 root root   41 Dec 15 14:35 ORIG_HEAD</span><br><span class="line">drwxr-xr-x  5 root root 4096 Dec 15 14:36 refs </span><br><span class="line"># 许多文件也不清楚作用， 但应该git配置和操作的信息都在这</span><br></pre></td></tr></table></figure>

<p>git配置后之后，已经可以和gitee或其他线上仓库交互了，比如拉取一个仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone origin https://gitee.com/yuanwl/k8s.git</span><br><span class="line"># 或者</span><br><span class="line">git pull origin https://gitee.com/yuanwl/k8s.git</span><br></pre></td></tr></table></figure>

<p>可以在本地修改同步到远程仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 例如刚修改了 README.md, 提交到暂存区</span><br><span class="line">git add README.md </span><br><span class="line"># 这就告诉了git, 做了哪些修改</span><br><span class="line">git commit -m &quot;test&quot;</span><br><span class="line"># commit就是确认提交到了本地仓库， -m 的参数是这次提交的注释，虽然写注释有点麻烦，但是写一下还是有用的，知道是提交了什么 </span><br><span class="line">git push  </span><br><span class="line"># 之后会提示输入用户和密码，然后就可以提交了</span><br></pre></td></tr></table></figure>

<p>这是一个变更同步到仓库的过程，第一次接触可能会疑问，为什么不能一步到位，要三个命令才能同步呢？这是因为git的工作台机制，为了版本控制。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/git.drawio.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 测试</span><br><span class="line">[root@node61 k8s]#echo &quot;this is a test &quot;work stage&quot;&quot; &gt;&gt; test.md </span><br><span class="line"># 更改后查看状态， not staged </span><br><span class="line">[root@node61 k8s]# git status  </span><br><span class="line"># On branch master</span><br><span class="line"># Changes not staged for commit:</span><br><span class="line">#   (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class="line">#   (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class="line">#</span><br><span class="line">#	modified:   test.md</span><br><span class="line">#</span><br><span class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</span><br><span class="line">[root@node61 k8s]# git add test.md</span><br><span class="line"># add后查看状态， not commited </span><br><span class="line">[root@node61 k8s]# git status </span><br><span class="line"># On branch master</span><br><span class="line"># Changes to be committed:</span><br><span class="line">#   (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</span><br><span class="line">#</span><br><span class="line">#	modified:   test.md</span><br><span class="line">#</span><br><span class="line">[root@node61 k8s]# git commit -m &quot;1&quot;</span><br><span class="line">[master 31f1e76] 1</span><br><span class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class="line"> # commit后查看状态， 没有push</span><br><span class="line">[root@node61 k8s]# git status</span><br><span class="line"># On branch master</span><br><span class="line"># Your branch is ahead of &#x27;origin/master&#x27; by 1 commit.</span><br><span class="line">#   (use &quot;git push&quot; to publish your local commits)</span><br><span class="line">#</span><br><span class="line">nothing to commit, working directory clean</span><br><span class="line">[root@node61 k8s]# git push </span><br><span class="line">Counting objects: 5, done.</span><br><span class="line">Compressing objects: 100% (2/2), done.</span><br><span class="line">Writing objects: 100% (3/3), 271 bytes | 0 bytes/s, done.</span><br><span class="line">Total 3 (delta 1), reused 0 (delta 0)</span><br><span class="line">remote: Powered by GITEE.COM [GNK-6.2]</span><br><span class="line">To https://gitee.com/yuanwl/k8s.git</span><br><span class="line">   d664e8f..31f1e76  master -&gt; master</span><br><span class="line"># push之后，工作台干净了</span><br><span class="line">[root@node61 k8s]# git status</span><br><span class="line"># On branch master</span><br><span class="line">nothing to commit, working directory clean</span><br></pre></td></tr></table></figure>

<p>这样搞清了每一步要干啥，但麻烦的是每次都要输入账号密码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 可以配置记住密码</span><br><span class="line">git config --global credential.helper store</span><br><span class="line"># 产生一个文件 /root/.gitconfig</span><br><span class="line">[root@VM-4-15-centos ~]# cat .gitconfig </span><br><span class="line">[credential]</span><br><span class="line">	helper = store</span><br><span class="line">[user]</span><br><span class="line">	email = yuan.wanli@qq.com</span><br><span class="line">	name = yuanwl</span><br><span class="line"># 记录了账号与用户 </span><br><span class="line"># 然后执行git pull 之后， 就会记住密码，存在/root/.git-credentials以后就不用输入了</span><br><span class="line">[root@VM-4-15-centos ~]# cat .git-credentials </span><br><span class="line">https://yuanwl:123456789@gitee.com</span><br><span class="line"># 这问题明显了，密码明文可见，一点都不安全，平时自己用用测试是可以的</span><br></pre></td></tr></table></figure>

<p>ssh免密登陆</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 生成密钥</span><br><span class="line">ssh-keygen </span><br><span class="line"># 将公钥~/.ssh/id_rsa.pub放在gitee公钥上，设置--ssh公钥--添加</span><br><span class="line"># 添加ssh路径，git开头，和http路径不同  或者修改</span><br><span class="line">[root@node61 ~]# ssh -T git@gitee.com</span><br><span class="line">Hi yuanwanli! You&#x27;ve successfully authenticated, but GITEE.COM does not provide shell access. </span><br><span class="line"># 这时就可以直接 clone 了 </span><br><span class="line"># 如果要push , 远端路径也要ssh协议的。不然还是走密码 </span><br><span class="line">git remote add git@gitee.com:yuanwl/autoblog.git </span><br><span class="line"># 也可以直接修改 .git/config</span><br><span class="line"># 然后就可以免密提交了</span><br><span class="line"># 配置git私钥地址</span><br><span class="line">#Windows环境中使用/作为路径分隔符，--global表示全局配置，不加则只对当前Git项目生效。</span><br><span class="line">git config [--global] core.sshCommand &quot;ssh -i /path/to/your/privateKey&quot;</span><br><span class="line">#或者修改.git/config</span><br><span class="line">[root@nginx autoblog]# cat  .git/config</span><br><span class="line">[core]</span><br><span class="line">        repositoryformatversion = 0</span><br><span class="line">        filemode = true</span><br><span class="line">        bare = false</span><br><span class="line">        logallrefupdates = true</span><br><span class="line">        sshCommand = ssh -i /path/to/your/privateKey</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">        url = git@gitee.com:yuanwl/autoblog.git</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch &quot;master&quot;]</span><br><span class="line">        remote = origin</span><br><span class="line">        merge = refs/heads/master</span><br><span class="line"></span><br><span class="line">[root@nginx ~]#  ssh -T git@gitee.com</span><br><span class="line">Permission denied (publickey).</span><br><span class="line"># 确认私钥是否正确 </span><br><span class="line"># 不行清空 .ssh ,可以</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1、id_rsa：本机（服务端）的私钥文件。</p>
<p>2、id_rsa.pub：本机（服务端）的公钥文件。</p>
<p>3、authorized_key：存放想要通过公私钥校验方式连接本机（服务端）的客户端公钥。</p>
<p>4、known_hosts：本地的客户端存放成功连接本机（服务端）的服务端信息，服务端信息变更的话会再次询问，是否连接。（即存放曾经连接成功过的远程服务器信息</p>
</blockquote>
<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>我很多时候是在window多台主机上做修改。windows中在官网<a target="_blank" rel="noopener" href="https://www.git-scm.com/download/win">Git - Downloading Package (git-scm.com)</a>下载git应用，安装一路next即可。 </p>
<p>新建同步文件夹之后，右键选择 git bash here. 之后操作就和linux一样了。 </p>
<h3 id="进一步使用"><a href="#进一步使用" class="headerlink" title="进一步使用"></a>进一步使用</h3><p><strong>删除文件</strong>， 如果删除了一个文件， 就不能git add filename ，可以使用 <code>git rm</code>确认删除了，然后commit.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rm -f test.md </span><br><span class="line">git rm test.md </span><br><span class="line"># 这样可能比较麻烦，有时也会忘，也没有关系。 如果在add 的时候提示： </span><br><span class="line">warning: You ran &#x27;git add&#x27; with neither &#x27;-A (--all)&#x27; or &#x27;--ignore-removal&#x27;,</span><br><span class="line">whose behaviour will change in Git 2.0 with respect to paths you removed.</span><br><span class="line">Paths like &#x27;test.md&#x27; that are</span><br><span class="line">removed from your working tree are ignored with this version of Git.</span><br><span class="line"></span><br><span class="line">* &#x27;git add --ignore-removal &lt;pathspec&gt;&#x27;, which is the current default,</span><br><span class="line">  ignores paths you removed from your working tree.</span><br><span class="line"></span><br><span class="line">* &#x27;git add --all &lt;pathspec&gt;&#x27; will let you also record the removals.</span><br><span class="line"># 这时候再使用， git add -A 或者 git add --ignore-removal 也可以。</span><br><span class="line"># 也可以直接用git rm test.md</span><br></pre></td></tr></table></figure>

<p>另一种情况是， 如果是<strong>误删</strong>呢？ 也可有恢复<code>checkout</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node61 k8s]# git checkout -- test.md</span><br><span class="line">[root@node61 k8s]# ls </span><br><span class="line">-rw-r--r-- 1 root root  320 Dec 16 16:04  test.md</span><br><span class="line"># 文件回来了, 但只有commit之后才能恢复，没有commit的东西git根本不知道，也无法恢复。</span><br></pre></td></tr></table></figure>

<p>如果我第二天不知道自己昨天改了什么呢？<code>git diff</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node61 k8s]# git diff test.md</span><br><span class="line">diff --git a/test.md b/test.md</span><br><span class="line">index 90bfcb5..2178a28 100644</span><br><span class="line">--- a/test.md</span><br><span class="line">+++ b/test.md</span><br><span class="line">@@ -1 +1,2 @@</span><br><span class="line"> this is a test</span><br><span class="line">+this is a test</span><br></pre></td></tr></table></figure>
<p>如果我不知道现在改的文件有没有提交怎么办呢？<code>git status</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node61 k8s]# git status test.md</span><br><span class="line"># On branch master</span><br><span class="line"># Your branch is ahead of &#x27;origin/master&#x27; by 1 commit.</span><br><span class="line">#   (use &quot;git push&quot; to publish your local commits)</span><br><span class="line">#</span><br><span class="line"># Changes not staged for commit:</span><br><span class="line">#   (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class="line">#   (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class="line">#</span><br><span class="line">#	modified:   test.md</span><br><span class="line">#</span><br><span class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</span><br></pre></td></tr></table></figure>

<p>当然了，在实际工作中，我们脑子里怎么可能记得一个几千行的文件每次都改了什么内容，不然要版本控制系统干什么。版本控制系统肯定有某个命令可以告诉我们<strong>历史记录</strong>，在Git中，我们用<code>git log</code>可以查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node61 k8s]# git log</span><br><span class="line">commit 088a4167f946247ced6766c58ffd0568369ce69d</span><br><span class="line">Author: yuanwl &lt;yuan.wanli@qq.com&gt;</span><br><span class="line">Date:   Thu Dec 16 11:41:56 2021 +0800</span><br><span class="line">    first commit </span><br><span class="line">commit ca0ffde7153d0f4eee8473cfa23797835ed74ae9</span><br><span class="line">Merge: e72ac3d 259e9bf</span><br><span class="line"># 可以看最近三次的提交日志 </span><br></pre></td></tr></table></figure>

<p><strong>版本回退</strong>，如果我提交了错误的修改，可以回退到上个版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node61 k8s]# git reset --hard HEAD^</span><br><span class="line">HEAD is now at 818a7ff test</span><br><span class="line"># 也可以根据版本commit 版本号回退， git reflog</span><br><span class="line">[root@node61 k8s]# git reflog</span><br><span class="line">d664e8f HEAD@&#123;0&#125;: pull: Fast-forward</span><br><span class="line">818a7ff HEAD@&#123;1&#125;: reset: moving to HEAD^</span><br><span class="line">d664e8f HEAD@&#123;2&#125;: pull: Fast-forward</span><br><span class="line">818a7ff HEAD@&#123;3&#125;: commit: test</span><br><span class="line">088a416 HEAD@&#123;4&#125;: clone: from https://gitee.com/yuanwl/k8s.git</span><br><span class="line">[root@node61 k8s]# git reset HEAD 818a7ff</span><br></pre></td></tr></table></figure>

<h3 id="分支合并"><a href="#分支合并" class="headerlink" title="分支合并"></a>分支合并</h3><p>分支合并是git中最核心的操作， 开始的时候只有一条分支master, 这样的问题是如果多人一起开发，那么可能出现每次push都会遇到别人修改的仓库。每个人一个分支, 在本地修改好再同步到master， 保证master是稳定的，其余分支是工作的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/gitbranch.drawio.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># 创建分支 </span><br><span class="line">git branch lenovo </span><br><span class="line"># 切换分支  </span><br><span class="line">git checkout lenovo </span><br><span class="line"># pull 特定分支</span><br><span class="line">git pull -b main url</span><br><span class="line"># 切换到一个新的分支 git checkout -b levono </span><br><span class="line"># 查看分支 , 当前的分支前有星号 </span><br><span class="line">$ git branch</span><br><span class="line">* lenovo</span><br><span class="line">  master</span><br><span class="line"># 在levono分支修改后，切换回master分支是看不到修改内容的，需要同步一下。 </span><br><span class="line">git merge lenovo </span><br><span class="line"># 同步有两种情况： </span><br><span class="line"># 1 lenovo只是新增了内容， 没有冲突， 可以快速合并 </span><br><span class="line"># 2 lenovo上修改了内容，两条分支内容有冲突， 所以需要手动确认内容。 下面是冲突的情况</span><br><span class="line"># lenovo 中 tesk.md 如下： </span><br><span class="line">$ cat test.md</span><br><span class="line">which is the stable branch?</span><br><span class="line">lenovo</span><br><span class="line"></span><br><span class="line"># master 中tesk.md 如下：</span><br><span class="line">$ cat test.md</span><br><span class="line">which is the stable branch?</span><br><span class="line">master</span><br><span class="line"></span><br><span class="line"># 这是两个分支是有冲突的， git merge之后回提示需要手动解决冲突，冲突会在test.md文档中标记</span><br><span class="line">$ cat test.md</span><br><span class="line">which is the stable branch?</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD   # 当前指向 </span><br><span class="line">master</span><br><span class="line">=======</span><br><span class="line">lenovo</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; lenovo  # lenovo分支内容  </span><br><span class="line"></span><br><span class="line"># 需要手动修改文档成最终我们需要的内容,然后commit就同步了 </span><br><span class="line">$ cat test.md</span><br><span class="line">which is the stable branch?</span><br><span class="line">master</span><br><span class="line"></span><br><span class="line"># 删除分支 </span><br><span class="line">git checkout -d lenovo </span><br><span class="line"></span><br><span class="line"># 本地lenovo分支推送远程master分支 </span><br><span class="line">git push origin lenovo:master</span><br><span class="line"></span><br><span class="line"># 拉取远程master到本地lenovo分子</span><br><span class="line">git pull origin master:lenovo</span><br><span class="line"># 总结就是 git push/pull origin  &lt;源仓库名称&gt;:&lt;目标仓库名称&gt;</span><br></pre></td></tr></table></figure>

<h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p>tag就是一个让人容易记住的有意义的名字，它跟某个commit绑在一起。 发布一个版本时，我们通常先在版本库中打一个标签（tag），这样，就唯一确定了打标签时刻的版本。将来无论什么时候，取某个标签的版本，就是把那个打标签的时刻的历史版本取出来。所以，标签也是版本库的一个快照。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># 标签是commit的称呼，所以先看commit </span><br><span class="line">$ git log --abbrev-commit</span><br><span class="line">commit 0e8c272 (HEAD -&gt; master, tag: v3.0)</span><br><span class="line">Author: yuanwanli &lt;yuan.wanli@qq.com&gt;</span><br><span class="line">Date:   Sun Dec 19 10:52:18 2021 +0800</span><br><span class="line"></span><br><span class="line">    add C 10.53</span><br><span class="line"></span><br><span class="line">commit 98ea6fb</span><br><span class="line">Author: yuanwanli &lt;yuan.wanli@qq.com&gt;</span><br><span class="line">Date:   Sun Dec 19 10:51:54 2021 +0800</span><br><span class="line"></span><br><span class="line">    add b 10.52</span><br><span class="line"></span><br><span class="line">commit 8350365</span><br><span class="line">Author: yuanwanli &lt;yuan.wanli@qq.com&gt;</span><br><span class="line">Date:   Sun Dec 19 10:51:22 2021 +0800</span><br><span class="line"></span><br><span class="line">    add a 10.51</span><br><span class="line"># 给最近的修改加标签 </span><br><span class="line">$ git ag v3.0 0e8c272</span><br><span class="line">$ git tag v2.0 98ea6fb</span><br><span class="line"></span><br><span class="line"># 查看标签列表 </span><br><span class="line">$ git tag</span><br><span class="line">v2.0</span><br><span class="line">v3.0</span><br><span class="line"></span><br><span class="line"># 查看标签明细</span><br><span class="line">$ git show v3.0</span><br><span class="line">commit 0e8c272709f6ac07155849fd7d0d3727161bf1f6 (HEAD -&gt; master, tag: v3.0)</span><br><span class="line">Author: yuanwanli &lt;yuan.wanli@qq.com&gt;</span><br><span class="line">Date:   Sun Dec 19 10:52:18 2021 +0800</span><br><span class="line"></span><br><span class="line">    add C 10.53</span><br><span class="line"></span><br><span class="line">diff --git a/test.md b/test.md</span><br><span class="line">index 422c2b7..de98044 100644</span><br><span class="line">--- a/test.md</span><br><span class="line">+++ b/test.md</span><br><span class="line">@@ -1,2 +1,3 @@</span><br><span class="line"> a</span><br><span class="line"> b</span><br><span class="line">+c</span><br><span class="line"></span><br><span class="line"># 标签推送，讲v3.0推送到远端仓库</span><br><span class="line">$ git push origin v3.0</span><br><span class="line">Enumerating objects: 18, done.</span><br><span class="line">Counting objects: 100% (18/18), done.</span><br><span class="line">Delta compression using up to 8 threads</span><br><span class="line">Compressing objects: 100% (11/11), done.</span><br><span class="line">Writing objects: 100% (16/16), 1.20 KiB | 204.00 KiB/s, done.</span><br><span class="line">Total 16 (delta 7), reused 0 (delta 0), pack-reused 0</span><br><span class="line">remote: Powered by GITEE.COM [GNK-6.2]</span><br><span class="line">To https://gitee.com/yuanwl/k8s.git</span><br><span class="line"> * [new tag]         v3.0 -&gt; v3.0</span><br><span class="line"></span><br><span class="line"># 标签删除</span><br><span class="line">$ git tag -d v2.0</span><br><span class="line">Deleted tag &#x27;v2.0&#x27; (was 98ea6fb)</span><br></pre></td></tr></table></figure>

<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>在push的时候遇到这样一个错误</p>
<p>error: failed to push some refs to ‘<a target="_blank" rel="noopener" href="https://gitee.com/yuanwl/k8s.git&#39;">https://gitee.com/yuanwl/k8s.git&#39;</a><br>Updates were rejected because the remote contains work that you do<br>not have locally. This is usually caused by another repository pushing<br>to the same ref. You may want to first merge the remote changes (e.g.,<br>hint: ‘git pull’) before pushing again.</p>
<p>就是线上的仓库在上次我clone之后有了改动(是我删了一个文件)， 这样不能直接commit, </p>
<p>git会记下上次pull的版本，如果pull之后远程又做了修改，无法直接push, 这也很好理解，git不知道如何处理远程仓库的改动。</p>
<p>可以使用git pull同步。</p>
<h3 id="简易git"><a href="#简易git" class="headerlink" title="简易git"></a>简易git</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">简易的命令行入门教程:</span><br><span class="line">Git 全局设置:</span><br><span class="line"></span><br><span class="line">git config --global user.name &quot;yuanwanli&quot;</span><br><span class="line">git config --global user.email &quot;yuan.wanli@qq.com&quot;</span><br><span class="line">创建 git 仓库:</span><br><span class="line"></span><br><span class="line">mkdir autoblog</span><br><span class="line">cd autoblog</span><br><span class="line">git init </span><br><span class="line">touch README.md</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line">git remote add origin https://gitee.com/yuanwl/autoblog.git</span><br><span class="line">git push -u origin &quot;master&quot;</span><br><span class="line">已有仓库?</span><br><span class="line"></span><br><span class="line">cd existing_git_repo</span><br><span class="line">git remote add origin https://gitee.com/yuanwl/autoblog.git</span><br><span class="line">git push -u origin &quot;master&quot;</span><br></pre></td></tr></table></figure>





<h3 id="gitsubmodule"><a href="#gitsubmodule" class="headerlink" title="gitsubmodule"></a>gitsubmodule</h3><p>面对比较复杂的项目，我们有可能会将代码根据功能拆解成不同的子模块。主项目对子模块有依赖关系，却又并不关心子模块的内部开发流程细节。</p>
<p>这种情况下，通常不会把所有源码都放在同一个 Git 仓库中。</p>
<p>有一种比较简单的方式，是在当前工作目录下，将子模块文件夹加入到 <code>.gitignore</code> 文件内容中，这样主项目就能够无视子项目的存在。这样做有一个弊端就是，使用主项目的人需要有一个先验知识：需要在当前目录下放置一份某版本的子模块代码。</p>
<p>.gitignore是始终忽略这些文件，也不上传。</p>
<p>还有另外一种方式可供借鉴，可以使用 Git 的 <code>submodule</code> 功能，实际上 Git 工具的 <code>submodule</code> 功能就是建立了当前项目与子模块之间的依赖关系：<code>子模块路径</code>、<code>子模块的远程仓库</code>、<code>子模块的版本号</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 创建子项目</span><br><span class="line">git submodule add &lt;submodule_url&gt;  </span><br><span class="line"></span><br><span class="line">drwxr-xr-x 9 root root 4096 Feb 15 17:26 .git</span><br><span class="line">-rw-r--r-- 1 root root   67 Feb 15 17:25 .gitmodules</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 15 17:25 md</span><br><span class="line">多了三个文件</span><br><span class="line">git add </span><br><span class="line">git commit -m &#x27;add sub module &#x27; </span><br><span class="line"></span><br><span class="line"># 获取子项目代码</span><br><span class="line">pull  --recurse-submodules</span><br><span class="line">#</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update </span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/13/2021-12-13-promethus%E8%81%94%E9%82%A6+-%E8%BF%9C%E7%A8%8B%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8+-%E5%8F%AF%E8%A7%86%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/13/2021-12-13-promethus%E8%81%94%E9%82%A6+-%E8%BF%9C%E7%A8%8B%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8+-%E5%8F%AF%E8%A7%86%E5%8C%96/" class="post-title-link" itemprop="url">promethus联邦+ 远程持久化存储+ 可视化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-13 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-13T00:00:00+08:00">2021-12-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="联邦集群"><a href="#联邦集群" class="headerlink" title="联邦集群"></a>联邦集群</h3><p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E8%81%94%E9%82%A6%E9%9B%86%E7%BE%A4.png">    </p>
<h3 id="实验架构"><a href="#实验架构" class="headerlink" title="实验架构"></a>实验架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 两个集群</span><br><span class="line"># prometheus_cluster1</span><br><span class="line"># prometheus_cluster2 </span><br><span class="line"># 一个主机承担 </span><br><span class="line"># prometheus_master + influxdb + grafana</span><br></pre></td></tr></table></figure>

<h3 id="实验操作"><a href="#实验操作" class="headerlink" title="实验操作"></a>实验操作</h3><h4 id="1-集群部署prometheus"><a href="#1-集群部署prometheus" class="headerlink" title="1 集群部署prometheus"></a>1 集群部署prometheus</h4><p>集群部署文件存在gitee/k8s仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitee.com/yuanwl/k8s.git</span><br><span class="line">cd  k8s/pig</span><br><span class="line"># 新建一个监控namespace</span><br><span class="line">kubectl apply -f monitor.ns.yml</span><br><span class="line">cd prometheus</span><br><span class="line"># 启动prometheus监控</span><br><span class="line">kubectl apply -f  </span><br><span class="line"># 测试可以访问</span><br><span class="line">http://&lt;node_ip&gt;/graph</span><br></pre></td></tr></table></figure>

<ol>
<li>多个k8s集群，这里两个集群，并且已经配置prometheus服务，接口分别是: </li>
</ol>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- &#x27;1.13.92.201:30003&#x27;</span><br><span class="line">- &#x27;1.13.102.83:30003&#x27;</span><br><span class="line"># 测试http://1.13.102.83:30003/graph 可查当前数据中心数据即可</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>一个主机 main </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.117.61.155 centOS 7.6 2C4G</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="主机main配置"><a href="#主机main配置" class="headerlink" title="主机main配置"></a>主机main配置</h3><h4 id="1-配置influxdb"><a href="#1-配置influxdb" class="headerlink" title="1 配置influxdb"></a>1 配置influxdb</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 下载</span><br><span class="line">wget https://dl.influxdata.com/influxdb/releases/influxdb-1.8.1.x86_64.rpm </span><br><span class="line"># 安装</span><br><span class="line">yum -y localinstall influxdb-1.8.1.x86_64.rpm </span><br><span class="line"># 配置/etc/influxdb/influxdb.conf 开启http </span><br><span class="line"># 新建一个database </span><br><span class="line">curl -XPOST http://localhost:8086/query --data-urlencode &quot;q=CREATE DATABASE prometheus&quot;</span><br></pre></td></tr></table></figure>

<p>也可以docker启动influxdb </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#使用docker-compose定义并启动Influxdb数据库服务，docker-compose.yml定义如下：</span><br><span class="line"></span><br><span class="line">version: &#x27;2&#x27;</span><br><span class="line">services:</span><br><span class="line">  influxdb:</span><br><span class="line">    image: influxdb:1.3.5</span><br><span class="line">    command: -config /etc/influxdb/influxdb.conf</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8086:8086&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - INFLUXDB_DB=prometheus</span><br><span class="line">      - INFLUXDB_ADMIN_ENABLED=true</span><br><span class="line">      - INFLUXDB_ADMIN_USER=admin</span><br><span class="line">      - INFLUXDB_ADMIN_PASSWORD=admin</span><br><span class="line">      - INFLUXDB_USER=prom</span><br><span class="line">      - INFLUXDB_USER_PASSWORD=prom</span><br><span class="line"># 启动influxdb服务</span><br><span class="line">docker-compose up -d</span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">795d0ead87a1        influxdb:1.3.5      &quot;/entrypoint.sh -c...&quot;   3 hours ago         Up 3 hours          0.0.0.0:8086-&gt;8086/tcp   localhost_influxdb_1</span><br><span class="line"># 获取并启动Prometheus提供的Remote Storage Adapter：</span><br><span class="line"># 先配置golang , 官方下载安装包，再添加路径</span><br><span class="line"># go get 下载并编译</span><br><span class="line">go get github.com/prometheus/prometheus/documentation/examples/remote_storage/remote_storage_adapter</span><br><span class="line"># 获取remote_storage_adapter源码后，go会自动把相关的源码编译成可执行文件，并且保存在$GOPATH/bin/目录下。</span><br><span class="line"></span><br><span class="line"># 启动remote_storage_adapter并且设置Influxdb相关的认证信息：</span><br><span class="line"></span><br><span class="line">INFLUXDB_PW=prom $GOPATH/bin/remote_storage_adapter -influxdb-url=http://localhost:8086 -influxdb.username=prom -influxdb.database=prometheus -influxdb.retention-policy=autogen</span><br></pre></td></tr></table></figure>



<h4 id="2-配置prometheus"><a href="#2-配置prometheus" class="headerlink" title="2 配置prometheus"></a>2 配置prometheus</h4><p>使用docker或者安装包部署prometheus都可以，这里使用安装包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># 1 下载安装包prometheus-1.6.2.linux-amd64.tar.gz</span><br><span class="line">https://github.com/prometheus/prometheus/releases/tag/v1.6.2</span><br><span class="line"># 2 解压</span><br><span class="line">tar -xvf prometheus-1.6.2.linux-amd64.tar.gz</span><br><span class="line">cd prometheus-1.6.2.linux-amd64</span><br><span class="line"># 3 配置prometheus.yml， 配置prometheus联邦，拉取两个cluster的数据。</span><br><span class="line"></span><br><span class="line">cat &gt; prometheus.yml &lt;&lt; EOF</span><br><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line">  # Attach these labels to any time series or alerts when communicating with</span><br><span class="line">  # external systems (federation, remote storage, Alertmanager).</span><br><span class="line">  external_labels:</span><br><span class="line">      monitor: &#x27;codelab-monitor&#x27;</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first.rules&quot;</span><br><span class="line">  # - &quot;second.rules&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#x27;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#x27;federate&#x27;</span><br><span class="line">    scrape_interval: 15s</span><br><span class="line"></span><br><span class="line">    honor_labels: true</span><br><span class="line">    metrics_path: &#x27;/federate&#x27;</span><br><span class="line"># 联邦集群</span><br><span class="line">    params:</span><br><span class="line">      &#x27;match[]&#x27;:</span><br><span class="line">        - &#x27;&#123;job=&quot;prometheus&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-apiservers&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-nodes&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-cadvisor&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-service-endpoints&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-services&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-ingresses&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;job=&quot;kubernetes-pods&quot;&#125;&#x27;</span><br><span class="line">        - &#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span><br><span class="line"># 这里抓的matrics与集群prometheus服务中的job匹配</span><br><span class="line">#    static_configs:</span><br><span class="line">#      - targets:</span><br><span class="line">#        - &#x27;1.13.92.201:30003&#x27;</span><br><span class="line">#        - &#x27;1.13.102.83:30003&#x27;</span><br><span class="line"># 配置数据中心， 集群任意节点加nodeport端口 </span><br><span class="line"># 为了在展示中心展示数据中心的名称， 可在grafanaz主机添加host,然后通过名称导入</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - &#x27;cluster1:30003&#x27;</span><br><span class="line">        - &#x27;cluster2:30003&#x27;</span><br><span class="line"># 使用名称后需要加个数据中心的标签重写， 并加入正则匹配数据中心</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels:  [&quot;__address__&quot;]</span><br><span class="line">        target_label: &quot;data_center&quot;</span><br><span class="line">        regex: (.+):\d*</span><br><span class="line"># 远程读写</span><br><span class="line">#remote_write:</span><br><span class="line"># - url: &quot;http://localhost:8086/api/v1/prom/write?db=prometheus&quot;       </span><br><span class="line">EOF</span><br><span class="line"># /etc/hosts配置</span><br><span class="line">cluster1 1.13.92.201</span><br><span class="line">cluster2 11.13.102.83</span><br><span class="line"># 4 启动</span><br><span class="line">nohup ./prometheus -config.file=prometheus.yml &gt; myout.file  2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"># 5 WEB页面访问http://1.117.61.155:9090/ ，可以看到两个数据中心</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/prom.png"></p>
<h4 id="3-配置grafana"><a href="#3-配置grafana" class="headerlink" title="3 配置grafana"></a>3 配置grafana</h4><p>面配置grafana展示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 1 下载 </span><br><span class="line">wget https://dl.grafana.com/oss/release/grafana-6.7.1-1.x86_64.rpm</span><br><span class="line"># 2 安装</span><br><span class="line">yum -y install grafana-6.7.1-1.x86_64.rpm</span><br><span class="line"># 3 启动服务， 默认配置即可</span><br><span class="line">systemctl restart grafana-server.service</span><br><span class="line">systemctl enable grafana-server.service  </span><br><span class="line"># 4 默认端口3000 </span><br><span class="line">http://&lt;ip&gt;:3000 访问</span><br><span class="line"># 5 配置数据源为promethues, http://1.117.61.155:9090/ </span><br></pre></td></tr></table></figure>

<p>数据源配置具体部分省略，也已经同步到influxdb仓库中。 </p>
<p>grafana的面板配置在k8s/grafana中，可直接导入json生成面板。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/10/2021-12-10-linux%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/10/2021-12-10-linux%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/" class="post-title-link" itemprop="url">linux常用快捷键</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-10 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-10T00:00:00+08:00">2021-12-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>linux中常用的快捷键，总结备查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">tab # 命令或路径等的补全键，linux用的最多的一个快捷键 </span><br><span class="line"># 光标移动</span><br><span class="line">ctrl+a # 光标回到行首 </span><br><span class="line">ctrl+e # 光标回到行尾</span><br><span class="line">ctrl+f # 光标向右移动一个字符 forwards</span><br><span class="line">ctrl+b # 光标向左移动一个字符 behind</span><br><span class="line">esc+. # 注意那个&quot;.“ 意思是获取上一条命令的(以空格为分隔符)最后的部分</span><br><span class="line">esc+b # 移动到当前单词的开头</span><br><span class="line">esc+f # 移动到当前单词的结尾</span><br><span class="line"># 剪切 </span><br><span class="line">ctrl+u # 剪切光标处到行首的所有字符, 也就是删除</span><br><span class="line">ctrl+k # 剪切光标处到行尾的所有字符</span><br><span class="line">ctrl+w # 剪切光标前的一个单词(word)</span><br><span class="line">ctrl+h # 删除光标前的一个字符（相当于退格键）</span><br><span class="line"># 粘贴</span><br><span class="line">ctrl+y # 粘贴 ctrl+k、ctrl+u、ctrl+w 删除的字符</span><br><span class="line"># 中断</span><br><span class="line">ctrl+c # 中断终端正在执行的任务并开启一个新的一行</span><br><span class="line">ctrl+z # 暂停在终端运行的任务,使用&quot;fg&quot;命令可以使暂停恢复</span><br><span class="line">ctrl+d # 退出当前shell命令行，如果是切换过来的用户，则执行这个命令回退到原用户</span><br><span class="line"># 清空</span><br><span class="line">ctrl+l # 清空屏幕所有的内容，并开启一个新的一行，等价于clear,似乎比clear快一点</span><br><span class="line"># 锁定</span><br><span class="line">ctrl+s # 锁定终端，使之任何人无法输入</span><br><span class="line">ctrl+q # 解锁ctrl+s的锁定状态</span><br><span class="line"># 历史命令</span><br><span class="line">ctrl+r # 搜索命令行使用过的历史命令记录，比history好用一点</span><br><span class="line">ctrl+g # 从ctrl+r的搜索历史命令模式中退出</span><br><span class="line">!! # 执行上一条命令 </span><br><span class="line">!commdand # 这是一个例子，是执行以ommdand开头的命令，这里的ommdand可以换成任何已经执行过的字符</span><br><span class="line">!commdand:p # 这是一个例子，是仅打印以commdand开头的命令，但不执行，最后的那个“p”是命令固定字符</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上命令不区分大小写，如ctrl+a与ctrl+A效果相同</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/12/09/2021-12-09-promQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/09/2021-12-09-promQL/" class="post-title-link" itemprop="url">promQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-09 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-09T00:00:00+08:00">2021-12-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-19 18:50:15" itemprop="dateModified" datetime="2022-03-19T18:50:15+08:00">2022-03-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Prometheus的自定义查询语言PromQL(promtheus query language) 。通过PromQL用户可以非常方便地对监控样本数据进行统计分析，PromQL支持常见的运算操作符，同时PromQL中还提供了大量的内置函数可以实现对数据的高级处理。PromQL作为Prometheus的核心能力除了实现数据的对外查询和展现，同时告警监控也是依赖PromQL实现的。</p>
<p>promql本质上和sql没什么不同，根据不同的标签查询数据麻。只是promtheus是时序性数据库，使其和关系性数据库有区别。所系我们需要先了解Prometheus的样本数据模型。</p>
<h3 id="1-prometheus样本数据模型"><a href="#1-prometheus样本数据模型" class="headerlink" title="1 prometheus样本数据模型"></a>1 prometheus样本数据模型</h3><p>Prometheus会将所有采集到的样本数据以时间序列（time-series）的方式保存在内存数据库中，并且定时保存到硬盘上。</p>
<p>在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成：</p>
<ul>
<li>指标(metric)：metric name和描述当前样本特征的labelsets;</li>
<li>时间戳(timestamp)：一个精确到毫秒的时间戳;</li>
<li>样本值(value)： 一个float64的浮点型数据表示当前样本的值。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;--------------- metric ---------------------&gt;&lt;-timestamp -&gt;&lt;-value-&gt;</span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;GET&quot;&#125;@1434417560938 =&gt; 94355</span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;GET&quot;&#125;@1434417561287 =&gt; 94334</span><br><span class="line"></span><br><span class="line">http_request_total&#123;status=&quot;404&quot;, method=&quot;GET&quot;&#125;@1434417560938 =&gt; 38473</span><br><span class="line">http_request_total&#123;status=&quot;404&quot;, method=&quot;GET&quot;&#125;@1434417561287 =&gt; 38544</span><br><span class="line"></span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;POST&quot;&#125;@1434417560938 =&gt; 4748</span><br><span class="line">http_request_total&#123;status=&quot;200&quot;, method=&quot;POST&quot;&#125;@1434417561287 =&gt; 4785</span><br></pre></td></tr></table></figure>

<p>样本点的集合成为集合(vector)</p>
<h3 id="2-指标-metric"><a href="#2-指标-metric" class="headerlink" title="2 指标(metric)"></a>2 指标(metric)</h3><p>在形式上，所有的指标(Metric)都通过如下格式标示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;</span><br></pre></td></tr></table></figure>

<p>指标的名称(metric name)可以反映被监控样本的含义（比如，<code>http_request_total</code> - 表示当前系统接收到的HTTP请求总量）。</p>
<p>标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等。</p>
<p>在Prometheus的存储实现上所有的监控样本都是以time-series的形式保存在Prometheus内存的TSDB（时序数据库）中，而time-series所对应的监控指标(metric)也是通过labelset进行唯一命名的。</p>
<p>从存储上来讲所有的监控指标metric都是相同的，但是根据不同的展示需求，可以讲metric分为不同的类型。</p>
<p>Prometheus定义了4中不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要）。如果要看累计的值，比如访问总量就是Counter。看瞬时的值比如当前内存剩余就是gauge。而histogram</p>
<p>在Exporter返回的样本数据中，其注释中也包含了该样本的类型。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP node_cpu Seconds the cpus spent in each mode.</span><br><span class="line"># TYPE node_cpu counter</span><br><span class="line">node_cpu&#123;cpu=&quot;cpu0&quot;,mode=&quot;idle&quot;&#125; 362812.7890625</span><br></pre></td></tr></table></figure>

<h4 id="Counter：只增不减的计数器"><a href="#Counter：只增不减的计数器" class="headerlink" title="Counter：只增不减的计数器"></a>Counter：只增不减的计数器</h4><p>Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。</p>
<p>Counter是一个简单但有强大的工具，例如我们可以在应用程序中记录某些事件发生的次数，通过以时序的形式存储这些数据，我们可以轻松的了解该事件产生速率的变化。 PromQL内置的聚合操作和函数可以让用户对这些数据进行进一步的分析：</p>
<p>例如，通过rate()函数获取HTTP请求量的增长率：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[5m])</span><br></pre></td></tr></table></figure>

<p>查询当前系统中，访问量前10的HTTP地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(10, http_requests_total)</span><br></pre></td></tr></table></figure>

<h4 id="Gauge：可增可减的仪表盘"><a href="#Gauge：可增可减的仪表盘" class="headerlink" title="Gauge：可增可减的仪表盘"></a>Gauge：可增可减的仪表盘</h4><p>与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。</p>
<p>通过Gauge指标，用户可以直接查看系统的当前状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_memory_MemFree</span><br></pre></td></tr></table></figure>

<p>对于Gauge类型的监控指标，通过PromQL内置函数delta()可以获取样本在一段时间返回内的变化情况。例如，计算CPU温度在两个小时内的差异：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delta(cpu_temp_celsius&#123;host=&quot;zeus&quot;&#125;[2h])</span><br></pre></td></tr></table></figure>

<p>还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。例如，预测系统磁盘空间在4个小时之后的剩余情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[1h], 4 * 3600)</span><br></pre></td></tr></table></figure>

<h4 id="分布情况——Histogram和Summary"><a href="#分布情况——Histogram和Summary" class="headerlink" title="分布情况——Histogram和Summary"></a>分布情况——Histogram和Summary</h4><p>除了Counter和Gauge类型的监控指标以外，Prometheus还定义了Histogram和Summary的指标类型。Histogram和Summary主用用于统计和分析样本的分布情况。</p>
<p>在大多数情况下人们都倾向于使用某些量化指标的平均值，例如CPU的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统API调用的平均响应时间为例：如果大多数API请求都维持在100ms的响应时间范围内，而个别请求的响应时间需要5s，那么就会导致某些WEB页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</p>
<p>为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在0<del>10ms之间的请求数有多少而10</del>20ms之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram和Summary都是为了能够解决这样问题的存在，通过Histogram和Summary类型的监控指标，我们可以快速了解监控样本的分布情况。</p>
<p>例如，指标prometheus_tsdb_wal_fsync_duration_seconds的指标类型为Summary。 它记录了Prometheus Server中wal_fsync处理的处理时间，通过访问Prometheus Server的/metrics地址，可以获取到以下监控样本数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.</span><br><span class="line"># TYPE prometheus_tsdb_wal_fsync_duration_seconds summary</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile=&quot;0.5&quot;&#125; 0.012352463</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile=&quot;0.9&quot;&#125; 0.014458005</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile=&quot;0.99&quot;&#125; 0.017316173</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds_sum 2.888716127000002</span><br><span class="line">prometheus_tsdb_wal_fsync_duration_seconds_count 216</span><br></pre></td></tr></table></figure>

<p>从上面的样本中可以得知当前Prometheus Server进行wal_fsync操作的总次数为216次，耗时2.888716127000002s。其中中位数（quantile=0.5）的耗时为0.012352463，9分位数（quantile=0.9）的耗时为0.014458005s。</p>
<p>在Prometheus Server自身返回的样本数据中，我们还能找到类型为Histogram的监控指标prometheus_tsdb_compaction_chunk_range_bucket。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># HELP prometheus_tsdb_compaction_chunk_range Final time range of chunks on their first compaction</span><br><span class="line"># TYPE prometheus_tsdb_compaction_chunk_range histogram</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;100&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;400&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;1600&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;6400&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;25600&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;102400&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;409600&quot;&#125; 0</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;1.6384e+06&quot;&#125; 260</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;6.5536e+06&quot;&#125; 780</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;2.62144e+07&quot;&#125; 780</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_bucket&#123;le=&quot;+Inf&quot;&#125; 780</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_sum 1.1540798e+09</span><br><span class="line">prometheus_tsdb_compaction_chunk_range_count 780</span><br></pre></td></tr></table></figure>

<p>与Summary类型的指标相似之处在于Histogram类型的样本同样会反应当前指标的记录的总数(以_count作为后缀)以及其值的总量（以_sum作为后缀）。不同在于Histogram指标直接反应了在不同区间内样本的个数，区间通过标签len进行定义。</p>
<p>同时对于Histogram的指标，我们还可以通过histogram_quantile()函数计算出其值的分位数。不同在于Histogram通过histogram_quantile函数是在服务器端计算的分位数。 而Sumamry的分位数则是直接在客户端计算完成。因此对于分位数的计算而言，Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。反之对于客户端而言Histogram消耗的资源更少。在选择这两种方式时用户应该按照自己的实际场景进行选择。</p>
<h3 id="3-promQL"><a href="#3-promQL" class="headerlink" title="3 promQL"></a>3 promQL</h3><p>Prometheus通过指标名称（metrics name）以及对应的一组标签（labelset）唯一定义一条时间序列。指标名称反映了监控样本的基本标识，而label则在这个基本特征上为采集到的数据提供了多种特征维度。用户可以基于这些特征维度过滤，聚合，统计从而产生新的计算后的一条时间序列。</p>
<p>PromQL是Prometheus内置的数据查询语言，其提供对时间序列数据丰富的查询，聚合以及逻辑运算能力的支持。并且被广泛应用在Prometheus的日常应用当中，包括对数据查询、可视化、告警处理当中。</p>
<h4 id="查询时间序列"><a href="#查询时间序列" class="headerlink" title="查询时间序列"></a>查询时间序列</h4><p>当Prometheus通过Exporter采集到相应的监控指标样本数据后，我们就可以通过PromQL对监控样本数据进行查询。</p>
<p>当我们直接使用监控指标名称查询时，可以查询该指标下的所有时间序列。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total</span><br></pre></td></tr></table></figure>

<p>等同于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>该表达式会返回指标名称为http_requests_total的所有时间序列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;alerts&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=(20889@1518096812.326)</span><br><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;graph&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=(21287@1518096812.326)</span><br></pre></td></tr></table></figure>

<p>PromQL还支持用户根据时间序列的标签匹配模式来对时间序列进行过滤，目前主要支持两种匹配模式：完全匹配和正则匹配。</p>
<p>PromQL支持使用<code>=</code>和<code>!=</code>两种完全匹配模式：</p>
<ul>
<li>通过使用<code>label=value</code>可以选择那些标签满足表达式定义的时间序列；</li>
<li>反之使用<code>label!=value</code>则可以根据标签匹配排除时间序列；</li>
</ul>
<p>例如，如果我们只需要查询所有http_requests_total时间序列中满足标签instance为localhost:9090的时间序列，则可以使用如下表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance=&quot;localhost:9090&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>反之使用<code>instance!=&quot;localhost:9090&quot;</code>则可以排除这些时间序列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance!=&quot;localhost:9090&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>除了使用完全匹配的方式对时间序列进行过滤以外，PromQL还可以支持使用正则表达式作为匹配条件，多个表达式之间使用<code>|</code>进行分离：</p>
<ul>
<li>使用<code>label=~regx</code>表示选择那些标签符合正则表达式定义的时间序列；</li>
<li>反之使用<code>label!~regx</code>进行排除；</li>
</ul>
<p>例如，如果想查询多个环节下的时间序列序列可以使用如下表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;environment=~&quot;staging|testing|development&quot;,method!=&quot;GET&quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h2><p>直接通过类似于PromQL表达式http*requests*total查询时间序列时，返回值中只会包含该时间序列中的最新的一个样本值，这样的返回结果我们称之为<strong>瞬时向量</strong>。而相应的这样的表达式称之为__瞬时向量表达式**。</p>
<p>而如果我们想过去一段时间范围内的样本数据时，我们则需要使用<strong>区间向量表达式</strong>。区间向量表达式和瞬时向量表达式之间的差异在于在区间向量表达式中我们需要定义时间选择的范围，时间范围通过时间范围选择器<code>[]</code>进行定义。例如，通过以下表达式可以选择最近5分钟内的所有样本数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125;[5m]</span><br></pre></td></tr></table></figure>

<p>该表达式将会返回查询到的时间序列中最近5分钟的所有样本数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;alerts&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=[</span><br><span class="line">    1@1518096812.326</span><br><span class="line">    1@1518096817.326</span><br><span class="line">    1@1518096822.326</span><br><span class="line">    1@1518096827.326</span><br><span class="line">    1@1518096832.326</span><br><span class="line">    1@1518096837.325</span><br><span class="line">]</span><br><span class="line">http_requests_total&#123;code=&quot;200&quot;,handler=&quot;graph&quot;,instance=&quot;localhost:9090&quot;,job=&quot;prometheus&quot;,method=&quot;get&quot;&#125;=[</span><br><span class="line">    4 @1518096812.326</span><br><span class="line">    4@1518096817.326</span><br><span class="line">    4@1518096822.326</span><br><span class="line">    4@1518096827.326</span><br><span class="line">    4@1518096832.326</span><br><span class="line">    4@1518096837.325</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>通过区间向量表达式查询到的结果我们称为<strong>区间向量</strong>。</p>
<p>除了使用m表示分钟以外，PromQL的时间范围选择器支持其它时间单位：</p>
<ul>
<li>s - 秒</li>
<li>m - 分钟</li>
<li>h - 小时</li>
<li>d - 天</li>
<li>w - 周</li>
<li>y - 年</li>
</ul>
<h2 id="时间位移操作"><a href="#时间位移操作" class="headerlink" title="时间位移操作"></a>时间位移操作</h2><p>在瞬时向量表达式或者区间向量表达式中，都是以当前时间为基准：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125; # 瞬时向量表达式，选择当前最新的数据</span><br><span class="line">http_request_total&#123;&#125;[5m] # 区间向量表达式，选择以当前时间为基准，5分钟内的数据</span><br></pre></td></tr></table></figure>

<p>而如果我们想查询，5分钟前的瞬时样本数据，或昨天一天的区间内的样本数据呢? 这个时候我们就可以使用位移操作，位移操作的关键字为<strong>offset</strong>。</p>
<p>可以使用offset时间位移操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125; offset 5m</span><br><span class="line">http_request_total&#123;&#125;[1d] offset 1d</span><br></pre></td></tr></table></figure>

<h2 id="使用聚合操作"><a href="#使用聚合操作" class="headerlink" title="使用聚合操作"></a>使用聚合操作</h2><p>一般来说，如果描述样本特征的标签(label)在并非唯一的情况下，通过PromQL查询数据，会返回多条满足这些特征维度的时间序列。而PromQL提供的聚合操作可以用来对这些时间序列进行处理，形成一条新的时间序列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查询系统所有http请求的总量</span><br><span class="line">sum(http_request_total)</span><br><span class="line"></span><br><span class="line"># 按照mode计算主机CPU的平均使用时间</span><br><span class="line">avg(node_cpu) by (mode)</span><br><span class="line"></span><br><span class="line"># 按照主机查询各个主机的CPU使用率</span><br><span class="line">sum(sum(irate(node_cpu&#123;mode!=&#x27;idle&#x27;&#125;[5m]))  / sum(irate(node_cpu[5m]))) by (instance)</span><br></pre></td></tr></table></figure>

<h2 id="标量和字符串"><a href="#标量和字符串" class="headerlink" title="标量和字符串"></a>标量和字符串</h2><p>除了使用瞬时向量表达式和区间向量表达式以外，PromQL还直接支持用户使用标量(Scalar)和字符串(String)。</p>
<h3 id="标量（Scalar）：一个浮点型的数字值"><a href="#标量（Scalar）：一个浮点型的数字值" class="headerlink" title="标量（Scalar）：一个浮点型的数字值"></a>标量（Scalar）：一个浮点型的数字值</h3><p>标量只有一个数字，没有时序。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是，当使用表达式count(http_requests_total)，返回的数据类型，依然是瞬时向量。用户可以通过内置函数scalar()将单个瞬时向量转换为标量。</p>
</blockquote>
<h3 id="字符串（String）：一个简单的字符串值"><a href="#字符串（String）：一个简单的字符串值" class="headerlink" title="字符串（String）：一个简单的字符串值"></a>字符串（String）：一个简单的字符串值</h3><p>直接使用字符串，作为PromQL表达式，则会直接返回字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;this is a string&quot;</span><br><span class="line">&#x27;these are unescaped: \n \\ \t&#x27;</span><br><span class="line">`these are not unescaped: \n &#x27; &quot; \t`</span><br></pre></td></tr></table></figure>

<h2 id="合法的PromQL表达式"><a href="#合法的PromQL表达式" class="headerlink" title="合法的PromQL表达式"></a>合法的PromQL表达式</h2><p>所有的PromQL表达式都必须至少包含一个指标名称(例如http_request_total)，或者一个不会匹配到空字符串的标签过滤器(例如{code=”200”})。</p>
<p>因此以下两种方式，均为合法的表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http_request_total # 合法</span><br><span class="line">http_request_total&#123;&#125; # 合法</span><br><span class="line">&#123;method=&quot;get&quot;&#125; # 合法</span><br></pre></td></tr></table></figure>

<p>而如下表达式，则不合法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;job=~&quot;.*&quot;&#125; # 不合法</span><br></pre></td></tr></table></figure>

<p>同时，除了使用<code>&lt;metric name&gt;&#123;label=value&#125;</code>的形式以外，我们还可以使用内置的<code>__name__</code>标签来指定监控指标名称：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;__name__=~&quot;http_request_total&quot;&#125; # 合法</span><br><span class="line">&#123;__name__=~&quot;node_disk_bytes_read|node_disk_bytes_written&quot;&#125; # 合法</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>224a31b93706e3592cb8961318638e3dca071f41</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuanwanli</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  





</body>
</html>
