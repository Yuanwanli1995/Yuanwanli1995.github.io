<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yuanwanli1995.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/./public/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="等不是办法，干才有出路">
<meta property="og:type" content="website">
<meta property="og:title" content="brisk">
<meta property="og:url" content="http://yuanwanli1995.github.io/page/6/index.html">
<meta property="og:site_name" content="brisk">
<meta property="og:description" content="等不是办法，干才有出路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yuanwanli">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yuanwanli1995.github.io/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>brisk</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">brisk</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yuanwanli</p>
  <div class="site-description" itemprop="description">等不是办法，干才有出路</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/22/2021-11-23-%E4%BD%BF%E7%94%A8cat-EOF%E6%97%B6%E5%86%85%E5%AE%B9%E5%90%AB%E6%9C%89$%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/22/2021-11-23-%E4%BD%BF%E7%94%A8cat-EOF%E6%97%B6%E5%86%85%E5%AE%B9%E5%90%AB%E6%9C%89$%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">使用cat EOF时内容含有$需要处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-22 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-22T00:00:00+08:00">2021-11-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在使用cat EOF内容中若出现$变量通常会直接被执行，则与想要输入的内容不一致。若想保持$变量不变需要使用 \ 符进行注释 。比如下面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; EOF</span><br><span class="line">vim /etc/yum.repos.d/nginx.repo </span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>执行时发现，输入的内容不正确， 因为输入的内容中含有$, 会当成命令执行， 要使用转义符\换成普通字符$ .</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/xshell5.png"><br> 在linux shell脚本中我们经常见到类似于cat &lt;&lt; EOF的语句，问题是EOF好像是文件的结束符，用在这里起到什么作用？<br>首先必要说明的是EOF在这里没有特殊的含义，你可以使用FOE或OOO等（当然也不限制在三个字符或大写字符)<br>下面是几种常见的使用方式及其作用：<br>1、cat&lt;&lt;EOF，以EOF输入字符为标准输入结束：<br>2、cat&gt;filename，创建文件，并把标准输入输出到filename文件中，以ctrl+d作为输入结束,输入时是没有’&gt;’的。<br>3、cat&gt;filename&lt;&lt;EOF，以EOF作为输入结束，和ctrl+d的作用一样</p>
<blockquote>
<p>注意，结束后必须和前面一样是EOF， 前面有空格都不可以。有时无法结束，检查有没有空格.<br>意，结束后必须和前面一样是EOF， 前面有空格都不可以。有时无法结束，检查有没有空格.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/22/2021-11-22-iptables%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/22/2021-11-22-iptables%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">转载iptables</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-22 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-22T00:00:00+08:00">2021-11-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="iptables概念"><a href="#iptables概念" class="headerlink" title="iptables概念"></a>iptables概念</h1><p>这篇文章会尽量以通俗易懂的方式描述iptables的相关概念，请耐心的读完它。</p>
<p> 你好顶顶顶的</p>
<h2 id="防火墙相关概念"><a href="#防火墙相关概念" class="headerlink" title="防火墙相关概念"></a>防火墙相关概念</h2><p>此处先描述一些相关概念。</p>
<p>从逻辑上讲。防火墙可以大体分为主机防火墙和网络防火墙。</p>
<ul>
<li><p>主机防火墙：针对于单个主机进行防护。</p>
</li>
<li><p>网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。</p>
</li>
</ul>
<p>网络防火墙和主机防火墙并不冲突，可以理解为，网络防火墙主外（集体）， 主机防火墙主内（个人）。</p>
<p>从物理上讲，防火墙可以分为硬件防火墙和软件防火墙。</p>
<ul>
<li><p>硬件防火墙：在硬件级别实现部分防火墙功能，另一部分功能基于软件实现，性能高，成本高。</p>
</li>
<li><p>软件防火墙：应用软件处理逻辑运行于通用硬件平台之上的防火墙，性能低，成本低。<br><img src="https://www.zsythink.net/wp-content/uploads/ueditor/php/upload/image/20170212/1486863972980583.png"></p>
</li>
</ul>
<p>那么在此处，我们就来聊聊Linux的iptables</p>
<p><em><strong>iptables</strong></em>其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的安全框架中，这个安全框架才是真正的防火墙，这个框架的名字叫<em><strong>netfilter</strong></em></p>
<p>netfilter才是防火墙真正的安全框架（framework），netfilter位于内核空间。</p>
<p>iptables其实是一个命令行工具，位于用户空间，我们用这个工具操作真正的框架。</p>
<p>netfilter/iptables（下文中简称为iptables）组成Linux平台下的包过滤防火墙，与大多数的Linux软件一样，这个包过滤防火墙是免费的，它可以代替昂贵的商业防火墙解决方案，完成封包过滤、封包重定向和网络地址转换（NAT）等功能。</p>
<p>Netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有如下功能：</p>
<p>网络地址转换(Network Address Translate)</p>
<p>数据包内容修改</p>
<p>以及数据包过滤的防火墙功能</p>
<p>所以说，虽然我们使用service iptables start启动iptables”服务”，但是其实准确的来说，iptables并没有一个守护进程，所以并不能算是真正意义上的服务，而应该算是内核提供的功能。</p>
<h2 id="iptables基础"><a href="#iptables基础" class="headerlink" title="iptables基础"></a>iptables基础</h2><p>我们知道iptables是按照规则来办事的，我们就来说说规则（rules），规则其实就是网络管理员预定义的条件，规则一般的定义为”如果数据包头符合这样的条件，就这样处理这个数据包”。规则存储在内核空间的信息包过滤表中，这些规则分别指定了源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）等。当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。</p>
<p>这样说可能并不容易理解，我们来换个容易理解的角度，从头说起.</p>
<p>当客户端访问服务器的web服务时，客户端发送报文到网卡，而tcp/ip协议栈是属于内核的一部分，所以，客户端的信息会通过内核的TCP协议传输到用户空间中的web服务中，而此时，客户端报文的目标终点为web服务所监听的套接字（IP：Port）上，当web服务需要响应客户端请求时，web服务发出的响应报文的目标终点则为客户端，这个时候，web服务所监听的IP与端口反而变成了原点，我们说过，netfilter才是真正的防火墙，它是内核的一部分，所以，如果我们想要防火墙能够达到”防火”的目的，则需要在内核中设置关卡，所有进出的报文都要通过这些关卡，经过检查后，符合放行条件的才能放行，符合阻拦条件的则需要被阻止，于是，就出现了input关卡和output关卡，而这些关卡在iptables中不被称为”关卡,而被称为”链”。<br><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_1.png"></p>
<p>其实我们上面描述的场景并不完善，因为客户端发来的报文访问的目标地址可能并不是本机，而是其他服务器，当本机的内核支持IP_FORWARD时，我们可以将报文转发给其他服务器，所以，这个时候，我们就会提到iptables中的其他”关卡”，也就是其他”链，他们就是  “路由前”、”转发”、”路由后”，他们的英文名是</p>
<p><strong>PREROUTING、FORWARD、POSTROUTING</strong></p>
<p>也就是说，当我们启用了防火墙功能时，报文需要经过如下关卡，也就是说，根据实际情况的不同，报文经过链”可能不同。如果报文需要转发，那么报文则不会经过input链发往用户空间，而是直接在内核空间中经过forward链和postrouting链转发出去的。</p>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_2.png"></p>
<p>所以，根据上图，我们能够想象出某些常用场景中，报文的流向：</p>
<p>到本机某进程的报文：PREROUTING –&gt; INPUT</p>
<p>由本机转发的报文：PREROUTING &gt; FORWARD –&gt; POSTROUTING</p>
<p>由本机的某进程发出报文（通常为响应报文）：OUTPUT –&gt; POSTROUTING</p>
<h2 id="链的概念"><a href="#链的概念" class="headerlink" title="链的概念"></a>链的概念</h2><p>现在，我们想象一下，这些”关卡”在iptables中为什么被称作”链”呢？我们知道，防火墙的作用就在于对经过的报文匹配”规则”，然后执行对应的”动作”,所以，当报文经过这些关卡的时候，则必须匹配这个关卡上的规则，但是，这个关卡上可能不止有一条规则，而是有很多条规则，当我们把这些规则串到一个链条上的时候，就形成了”链,所以，我们把每一个”关卡”想象成如下图中的模样  ，这样来说，把他们称为”链更为合适，每个经过这个”关卡的报文，都要将这条链”上的所有规则匹配一遍，如果有符合条件的规则，则执行规则对应的动作。<br><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_3.png"></p>
<h2 id="表的概念"><a href="#表的概念" class="headerlink" title="表的概念"></a>表的概念</h2><p>我们再想想另外一个问题，我们对每个”链上都放置了一串规则，但是这些规则有些很相似，比如，A类规则都是对IP或者端口的过滤，B类规则是修改报文，那么这个时候，我们是不是能把实现相同功能的规则放在一起呢，必须能的。</p>
<p>我们把具有相同功能的规则的集合叫做”表，所以说，不同功能的规则，我们可以放置在不同的表中进行管理，而iptables已经为我们定义了4种表，每种表对应了不同的功能，而我们定义的规则也都逃脱不了这4种功能的范围，所以，学习iptables之前，我们必须先搞明白每种表 的作用。</p>
<p>iptables为我们提供了如下规则的分类，或者说，iptables为我们提供了如下”表</p>
<ul>
<li><p>filter表：负责过滤功能，防火墙；内核模块：iptables_filter</p>
</li>
<li><p>nat表：network address translation，网络地址转换功能；内核模块：iptable_nat</p>
</li>
<li><p>mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle</p>
</li>
<li><p>raw表：关闭nat表上启用的连接追踪机制；iptable_raw</p>
</li>
</ul>
<p>也就是说，我们自定义的所有规则，都是这四种分类中的规则，或者说，所有规则都存在于这4张”表中。</p>
<h2 id="表链关系"><a href="#表链关系" class="headerlink" title="表链关系"></a>表链关系</h2><p>但是我们需要注意的是，某些”链”中注定不会包含”某类规则”，就像某些关卡”天生就不具备某些功能一样，比如，A”关卡只负责打击陆地敌人，没有防空能力，B关卡”只负责打击空中敌人，没有防御步兵的能力，C”关卡”可能比较NB，既能防空，也能防御陆地敌人，D关卡”最屌，海陆空都能防。</p>
<p>那让我们来看看，每个”关卡”都有哪些能力，或者说，让我们看看每个”链上的规则都存在于哪些”表”中。</p>
<p>我们还是以图为例，先看看prerouting链”上的规则都存在于哪些表中。</p>
<blockquote>
<p>注意：下图只用于说明prerouting链上的规则存在于哪些表中，并没有描述表的顺序。<br><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_4.png"></p>
</blockquote>
<p>这幅图是什么意思呢？它的意思是说，prerouting链”只拥有nat表、raw表和mangle表所对应的功能，所以，prerouting中的规则只能存放于nat表、raw表和mangle表中。</p>
<p>那么，根据上述思路，我们来总结一下，每个”关卡”都拥有什么功能，</p>
<p>或者说，每个”链”中的规则都存在于哪些”表”中。</p>
<ul>
<li><p>PREROUTING      的规则可以存在于：raw表，mangle表，nat表。</p>
</li>
<li><p>INPUT          的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。</p>
</li>
<li><p>FORWARD         的规则可以存在于：mangle表，filter表。</p>
</li>
<li><p>OUTPUT         的规则可以存在于：raw表mangle表，nat表，filter表。</p>
</li>
<li><p>POSTROUTING      的规则可以存在于：mangle表，nat表。</p>
</li>
</ul>
<p>但是，我们在实际的使用过程中，往往是通过”表作为操作入口，对规则进行定义的，之所以按照上述过程介绍iptables，是因为从”关卡”的角度更容易从入门的角度理解，但是为了以便在实际使用的时候，更加顺畅的理解它们，此处我们还要将各”表与”链”的关系罗列出来，</p>
<p>表（功能）&lt;–&gt;   链（钩子）：</p>
<p>raw     表中的规则可以被哪些链使用：PREROUTING，OUTPUT</p>
<p>mangle  表中的规则可以被哪些链使用：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</p>
<p>nat     表中的规则可以被哪些链使用：PREROUTING，OUTPUT，POSTROUTING（centos7中还有INPUT，centos6中没有）</p>
<p>filter  表中的规则可以被哪些链使用：INPUT，FORWARD，OUTPUT</p>
<p>其实我们还需要注意一点，因为数据包经过一个”链的时候，会将当前链的所有规则都匹配一遍，但是匹配时总归要有顺序，我们应该一条一条的去匹配，而且我们说过，相同功能类型的规则会汇聚在一张”表中，那么，哪些”表中的规则会放在”链的最前面执行呢，这时候就需要有一个优先级的问题，我们还拿prerouting”链”做图示。</p>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_5.png"><br>prerouting链中的规则存放于三张表中，而这三张表中的规则执行的优先级如下：</p>
<p>raw –&gt; mangle –&gt; nat</p>
<p>但是我们知道，iptables为我们定义了4张”表,当他们处于同一条链”时，执行的优先级如下。</p>
<p>优先级次序（由高而低）：</p>
<p>raw –&gt; mangle &gt; nat –&gt; filter</p>
<p>但是我们前面说过，某些链天生就不能使用某些表中的规则，所以，4张表中的规则处于同一条链的目前只有output链，它就是传说中海陆空都能防守的关卡。</p>
<p>为了更方便的管理，我们还可以在某个表里面创建自定义链，将针对某个应用程序所设置的规则放置在这个自定义链中，但是自定义链接不能直接使用，只能被某个默认的链当做动作去调用才能起作用，我们可以这样想象，自定义链就是一段比较”短”的链子，这条短”链子上的规则都是针对某个应用程序制定的，但是这条短的链子并不能直接使用，而是需要”焊接”在iptables默认定义链子上，才能被IPtables使用，这就是为什么默认定义的”链”需要把”自定义链”当做动作”去引用的原因。这是后话，后面再聊，在实际使用时我们即可更加的明白。</p>
<h2 id="数据经过防火墙的流程"><a href="#数据经过防火墙的流程" class="headerlink" title="数据经过防火墙的流程"></a>数据经过防火墙的流程</h2><p>结合上述所有的描述，我们可以将数据包通过防火墙的流程总结为下图：</p>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png"></p>
<p>我们在写Iptables规则的时候，要时刻牢记这张路由次序图，灵活配置规则。</p>
<p>我们将经常用到的对应关系重新写在此处，方便对应图例查看。</p>
<p>链的规则存放于哪些表中（从链到表的对应关系）：</p>
<ul>
<li><p>PREROUTING   的规则可以存在于：raw表，mangle表，nat表。</p>
</li>
<li><p>NPUT        的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。</p>
</li>
<li><p> FORWARD      的规则可以存在于：mangle表，filter表。</p>
</li>
<li><p>OUTPUT       的规则可以存在于：raw表mangle表，nat表，filter表。</p>
</li>
<li><p>POSTROUTING  的规则可以存在于：mangle表，nat表。</p>
</li>
</ul>
<p>表中的规则可以被哪些链使用（从表到链的对应关系）：</p>
<ul>
<li><p> raw     表中的规则可以被哪些链使用：PREROUTING，OUTPUT</p>
</li>
<li><p>mangle  表中的规则可以被哪些链使用：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</p>
</li>
<li><p>nat     表中的规则可以被哪些链使用：PREROUTING，OUTPUT，POSTROUTING（centos7中还有INPUT，centos6中没有）</p>
</li>
<li><p>filter  表中的规则可以被哪些链使用：INPUT，FORWARD，OUTPUT</p>
</li>
</ul>
<p>下图中nat表在centos7中的情况就不再标明。</p>
<p> <img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_7.png"></p>
<h2 id="规则的概念"><a href="#规则的概念" class="headerlink" title="规则的概念"></a>规则的概念</h2><p>说了一圈又说回来了，在上述描述中我们一直在提规则，可是没有细说，现在说说它。</p>
<p>先说说规则的概念，然后再通俗的解释它。</p>
<p>规则：根据指定的匹配条件来尝试匹配每个流经此处的报文，一旦匹配成功，则由规则后面指定的处理动作进行处理；</p>
<p>那么我们来通俗的解释一下什么是iptables的规则，之前打过一个比方，每条链”都是一个”关卡，每个通过这个”关卡”的报文都要匹配这个关卡上的规则，如果匹配，则对报文进行对应的处理，比如说，你我二人此刻就好像两个报文”，你我二人此刻都要入关，可是城主有命，只有器宇轩昂的人才能入关，不符合此条件的人不能入关，于是守关将士按照城主制定的”规则，开始打量你我二人，最终，你顺利入关了，而我已被拒之门外，因为你符合器宇轩昂的标准，所以把你”放行”了，而我不符合标准，所以没有被放行，其实，”器宇轩昂”就是一种”匹配条件”，”放行”就是一种”动作”，”匹配条件”与”动作”组成了规则。</p>
<p>了解了规则的概念，那我们来聊聊规则的组成部分,此处只是大概的将规则的结构列出，后面的文章中会单独对规则进行总结。</p>
<p>规则由匹配条件和处理动作组成。</p>
<p><strong>匹配条件</strong><br>匹配条件分为基本匹配条件与扩展匹配条件</p>
<p><strong>基本匹配条件</strong>：</p>
<p>源地址Source IP，目标地址 Destination IP</p>
<p>上述内容都可以作为基本匹配条件。</p>
<p><strong>扩展匹配条件</strong>：</p>
<p>除了上述的条件可以用于匹配，还有很多其他的条件可以用于匹配，这些条件泛称为扩展条件，这些扩展条件其实也是netfilter中的一部分，只是以模块的形式存在，如果想要使用这些条件，则需要依赖对应的扩展模块。</p>
<p>源端口Source Port, 目标端口Destination Port</p>
<p>上述内容都可以作为扩展匹配条件</p>
<p><strong>处理动作</strong><br>处理动作在iptables中被称为target（这样说并不准确，我们暂且这样称呼），动作也可以分为基本动作和扩展动作。</p>
<p>此处列出一些常用的动作，之后的文章会对它们进行详细的示例与总结：</p>
<ul>
<li><p>ACCEPT：允许数据包通过。</p>
</li>
<li><p>DROP：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</p>
</li>
<li><p>REJECT：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</p>
</li>
<li><p>SNAT：源地址转换，解决内网用户用同一个公网地址上网的问题。</p>
</li>
<li><p>MASQUERADE：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</p>
</li>
<li><p>DNAT：目标地址转换。</p>
</li>
<li><p>REDIRECT：在本机做端口映射。</p>
</li>
<li><p>LOG：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配。</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/19/2021-11-19-xshell%E5%AD%97%E7%AC%A6%E9%97%B4%E9%9A%94%E4%BF%AE%E6%94%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/19/2021-11-19-xshell%E5%AD%97%E7%AC%A6%E9%97%B4%E9%9A%94%E4%BF%AE%E6%94%B9/" class="post-title-link" itemprop="url">xshell字符间隔修改</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-19 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-19T00:00:00+08:00">2021-11-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>好像点到了一个设置，shell的字符间隔变得很大，看起来巨难受，</p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/shell.png"><br>在<code>默认会话设置</code> 中改了外观，没什么用，查了一下，可以在default配置文件中改。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/shell%E9%85%8D%E7%BD%AE.png"></p>
<p>将LineSpace，CharSpace改为1就改回来了。 </p>
<p>原来shell会话很多设置都可以在default中配置。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/16/2021-11-16-EFK%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6%E9%83%A8%E7%BD%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/16/2021-11-16-EFK%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6%E9%83%A8%E7%BD%B2/" class="post-title-link" itemprop="url">EFK日志管理框架部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-16 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-16T00:00:00+08:00">2021-11-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-工具介绍"><a href="#1-工具介绍" class="headerlink" title="1 工具介绍"></a>1 工具介绍</h1><p>Kubernetes 中比较流行的日志收集解决方案是 <code>Elasticsearch</code>、<code>Fluentd</code> 和 <code>Kibana</code>（EFK）技术栈，也是官方现在比较推荐的一种方案。 </p>
<p><code>Elasticsearch</code> 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于<strong>索引和搜索大量日志数据</strong>，也可用于搜索许多不同类型的文档。</p>
<p><code>Kibana</code> 是一个功能强大的数<strong>据可视化 Dashboard</strong>，Kibana 允许你通过 web 界面来浏览 Elasticsearch 日志数据。</p>
<p><code>Fluentd</code>是一个流行的开源<strong>数据收集器</strong>，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</p>
<p><img src="E:\blogpic\efk.png"></p>
<h1 id="2-配置-Elasticsearch-集群"><a href="#2-配置-Elasticsearch-集群" class="headerlink" title="2 配置 Elasticsearch 集群"></a>2 配置 Elasticsearch 集群</h1><p>2.1 命名空间 </p>
<p>创建集群之前，我们先建立一个日志管理的命名空间，用来存放日志分析的所有资源，方便查看和管理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace logging</span><br></pre></td></tr></table></figure>

<p> 2.2 创建es服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; elasticsearch-svc.yaml &lt;&lt; EOF </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: elasticsearch</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: elasticsearch</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9200</span><br><span class="line">      name: rest</span><br><span class="line">    - port: 9300</span><br><span class="line">      name: inter-node</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f elasticsearch-svc.yaml</span><br><span class="line"># 查看 </span><br><span class="line">kubectl get svc --namespace=logging</span><br></pre></td></tr></table></figure>

<p>2.3 statfulset </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; elasticsearch-storageclass.yaml &lt;&lt; EOF </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: es-cluster</span><br><span class="line">  namespace: logging</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: elasticsearch</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: elasticsearch</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: elasticsearch</span><br><span class="line">        image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.4.3</span><br><span class="line">        resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 1000m</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 100m</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: rest</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: inter-node</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: /usr/share/elasticsearch/data</span><br><span class="line">        env:</span><br><span class="line">          - name: cluster.name</span><br><span class="line">            value: k8s-logs</span><br><span class="line">          - name: node.name</span><br><span class="line">            valueFrom:</span><br><span class="line">              fieldRef:</span><br><span class="line">                fieldPath: metadata.name</span><br><span class="line">          - name: discovery.zen.ping.unicast.hosts</span><br><span class="line">            value: &quot;es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch&quot;</span><br><span class="line">          - name: discovery.zen.minimum_master_nodes</span><br><span class="line">            value: &quot;2&quot;</span><br><span class="line">          - name: ES_JAVA_OPTS</span><br><span class="line">            value: &quot;-Xms512m -Xmx512m&quot;</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: fix-permissions</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;chown -R 1000:1000 /usr/share/elasticsearch/data&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: /usr/share/elasticsearch/data</span><br><span class="line">      - name: increase-vm-max-map</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">      - name: increase-fd-ulimit</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;ulimit -n 65536&quot;]</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: data</span><br><span class="line">      labels:</span><br><span class="line">        app: elasticsearch</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      storageClassName: es-data-db</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 20Gi</span><br><span class="line">EOF </span><br></pre></td></tr></table></figure>

<p>2.4 部署es-storageclass </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  elasticsearch-storageclass.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: es-data-db</span><br><span class="line">provisioner: fuseim.pri/ifs </span><br><span class="line">EOF</span><br><span class="line"># 该值需要和 provisioner 配置的保持一致</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 部署es-storageclass </span><br><span class="line">kubectl create -f elasticsearch-storageclass.yaml</span><br><span class="line">storageclass.storage.k8s.io &quot;es-data-db&quot; created</span><br><span class="line"></span><br><span class="line"># 部署es-statefulset</span><br><span class="line">kubectl create -f elasticsearch-statefulset.yaml</span><br><span class="line">statefulset.apps/es-cluster created</span><br><span class="line"></span><br><span class="line"># 查看 </span><br><span class="line">kubectl get sts -n logging</span><br><span class="line"></span><br><span class="line">kubectl get pods -n logging</span><br></pre></td></tr></table></figure>

<p>Pods 部署完成后，我们可以通过请求一个 REST API 来检查 Elasticsearch 集群是否正常运行。使用下面的命令将本地端口9200转发到 Elasticsearch 节点（如es-cluster-0）对应的端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward es-cluster-0 9200:9200 --namespace=logging</span><br><span class="line">Forwarding from 127.0.0.1:9200 -&gt; 9200</span><br><span class="line">Forwarding from [::1]:9200 -&gt; 9200</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200/_cluster/state?pretty</span><br></pre></td></tr></table></figure>

<h1 id="3-kibana部署"><a href="#3-kibana部署" class="headerlink" title="3 kibana部署"></a>3 kibana部署</h1><p>Elasticsearch 集群启动成功了，接下来我们可以来部署 Kibana 服务，新建一个名为 kibana.yaml 的文件，对应的文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kibana.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 5601</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: kibana</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: docker.elastic.co/kibana/kibana-oss:6.4.3</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        env:</span><br><span class="line">          - name: ELASTICSEARCH_URL</span><br><span class="line">            value: http://elasticsearch:9200</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">EOF </span><br></pre></td></tr></table></figure>

<p>上面我们定义了两个资源对象，一个 Service 和 Deployment，为了测试方便，我们将 Service 设置为了 NodePort 类型，Kibana Pod 中配置都比较简单，唯一需要注意的是我们使用 ELASTICSEARCH_URL 这个环境变量来设置Elasticsearch 集群的端点和端口，直接使用 Kubernetes DNS 即可，此端点对应服务名称为 elasticsearch，由于是一个 headless service，所以该域将解析为3个 Elasticsearch Pod 的 IP 地址列表。</p>
<p>配置完成后，直接使用 kubectl 工具创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kibana.yaml</span><br><span class="line"></span><br><span class="line">service/kibana created</span><br><span class="line">deployment.apps/kibana created</span><br></pre></td></tr></table></figure>

<p>创建完成后，可以查看 Kibana Pod 的运行状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --namespace=logging</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">es-cluster-0              1/1       Running   0          20h</span><br><span class="line">es-cluster-1              1/1       Running   0          20h</span><br><span class="line">es-cluster-2              1/1       Running   0          20h</span><br><span class="line">kibana-7558d4dc4d-5mqdz   1/1       Running   0          20h</span><br><span class="line">$ kubectl get svc --namespace=logging</span><br><span class="line">NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">elasticsearch   ClusterIP   None             &lt;none&gt;        9200/TCP,9300/TCP   20h</span><br><span class="line">kibana          NodePort    10.105.208.253   &lt;none&gt;        5601:31816/TCP      20h</span><br></pre></td></tr></table></figure>

<p>如果 Pod 已经是 Running 状态了，证明应用已经部署成功了，然后可以通过 NodePort 来访问 Kibana 这个服务，在浏览器中打开<code>http://&lt;任意节点IP&gt;:31816</code>即可，如果看到如下欢迎界面证明 Kibana 已经成功部署到了 Kubernetes集群之中。</p>
<h1 id="4-部署-Fluentd"><a href="#4-部署-Fluentd" class="headerlink" title="4 部署 Fluentd"></a>4 部署 Fluentd</h1><p>要收集 Kubernetes 集群的日志，直接用 DasemonSet 控制器来部署 Fluentd 应用，这样，它就可以从 Kubernetes 节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd 容器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluentd-configmap.yaml &lt;&lt; EOF </span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-config</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">data:</span><br><span class="line">  system.conf: |-</span><br><span class="line">    &lt;system&gt;</span><br><span class="line">      root_dir /tmp/fluentd-buffers/</span><br><span class="line">    &lt;/system&gt;</span><br><span class="line">  containers.input.conf: |-</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id fluentd-containers.log</span><br><span class="line">      @type tail</span><br><span class="line">      path /var/log/containers/*.log</span><br><span class="line">      pos_file /var/log/es-containers.log.pos</span><br><span class="line">      time_format %Y-%m-%dT%H:%M:%S.%NZ</span><br><span class="line">      localtime</span><br><span class="line">      tag raw.kubernetes.*</span><br><span class="line">      format json</span><br><span class="line">      read_from_head true</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line">    # Detect exceptions in the log output and forward them as one log entry.</span><br><span class="line">    &lt;match raw.kubernetes.**&gt;</span><br><span class="line">      @id raw.kubernetes</span><br><span class="line">      @type detect_exceptions</span><br><span class="line">      remove_tag_prefix raw</span><br><span class="line">      message log</span><br><span class="line">      stream stream</span><br><span class="line">      multiline_flush_interval 5</span><br><span class="line">      max_bytes 500000</span><br><span class="line">      max_lines 1000</span><br><span class="line">    &lt;/match&gt;</span><br><span class="line">  system.input.conf: |-</span><br><span class="line">    # Logs from systemd-journal for interesting services.</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id journald-docker</span><br><span class="line">      @type systemd</span><br><span class="line">      filters [&#123; &quot;_SYSTEMD_UNIT&quot;: &quot;docker.service&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag docker</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id journald-kubelet</span><br><span class="line">      @type systemd</span><br><span class="line">      filters [&#123; &quot;_SYSTEMD_UNIT&quot;: &quot;kubelet.service&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag kubelet</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line">  forward.input.conf: |-</span><br><span class="line">    # Takes the messages sent over TCP</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @type forward</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line">  output.conf: |-</span><br><span class="line">    # Enriches records with Kubernetes metadata</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @type kubernetes_metadata</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line">    &lt;match **&gt;</span><br><span class="line">      @id elasticsearch</span><br><span class="line">      @type elasticsearch</span><br><span class="line">      @log_level info</span><br><span class="line">      include_tag_key true</span><br><span class="line">      host elasticsearch</span><br><span class="line">      port 9200</span><br><span class="line">      logstash_format true</span><br><span class="line">      request_timeout    30s</span><br><span class="line">      &lt;buffer&gt;</span><br><span class="line">        @type file</span><br><span class="line">        path /var/log/fluentd-buffers/kubernetes.system.buffer</span><br><span class="line">        flush_mode interval</span><br><span class="line">        retry_type exponential_backoff</span><br><span class="line">        flush_thread_count 2</span><br><span class="line">        flush_interval 5s</span><br><span class="line">        retry_forever</span><br><span class="line">        retry_max_interval 30</span><br><span class="line">        chunk_limit_size 2M</span><br><span class="line">        queue_limit_length 8</span><br><span class="line">        overflow_action block</span><br><span class="line">      &lt;/buffer&gt;</span><br><span class="line">    &lt;/match&gt;</span><br><span class="line">EOF </span><br></pre></td></tr></table></figure>

<p>上面配置文件中我们配置了 docker 容器日志目录以及 docker、kubelet 应用的日志的收集，收集到数据经过处理后发送到 elasticsearch:9200 服务。</p>
<p>然后新建一个 fluentd-daemonset.yaml 的文件，文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - &quot;namespaces&quot;</span><br><span class="line">  - &quot;pods&quot;</span><br><span class="line">  verbs:</span><br><span class="line">  - &quot;get&quot;</span><br><span class="line">  - &quot;watch&quot;</span><br><span class="line">  - &quot;list&quot;</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: logging</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    version: v2.0.4</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">      version: v2.0.4</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">        version: v2.0.4</span><br><span class="line">      # This annotation ensures that fluentd does not get evicted if the node</span><br><span class="line">      # supports critical pod annotation based priority scheme.</span><br><span class="line">      # Note that this does not guarantee admission on the nodes (#40573).</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: &#x27;&#x27;</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: cnych/fluentd-elasticsearch:v2.0.4</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/log</span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /data/docker/containers</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">      nodeSelector:</span><br><span class="line">        beta.kubernetes.io/fluentd-ds-ready: &quot;true&quot;</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io/master</span><br><span class="line">        operator: Exists</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/log</span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-config</span><br></pre></td></tr></table></figure>

<p>我们将上面创建的 fluentd-config 这个 ConfigMap 对象通过 volumes 挂载到了 Fluentd 容器中.</p>
<p>创建完成后，查看对应的 Pods 列表，检查是否部署成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n logging</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">es-cluster-0              1/1       Running   0          1d</span><br><span class="line">es-cluster-1              1/1       Running   0          1d</span><br><span class="line">es-cluster-2              1/1       Running   0          1d</span><br><span class="line">fluentd-es-2z9jg          1/1       Running   1          35s</span><br><span class="line">fluentd-es-6dfdd          1/1       Running   0          35s</span><br><span class="line">fluentd-es-bfkg7          1/1       Running   0          35s</span><br><span class="line">kibana-7558d4dc4d-5mqdz   1/1       Running   0          1d</span><br></pre></td></tr></table></figure>

<p>Fluentd 启动成功后，我们可以前往 Kibana 的 Dashboard 页面中，点击左侧的<code>Discover</code>，可以看到如下配置页面：</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/16/2021-11-16-kubepray-%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/16/2021-11-16-kubepray-%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">kubepray 搭建集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-16 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-16T00:00:00+08:00">2021-11-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1 环境准备"></a>1 环境准备</h1><p>1）所以的主机都需要关闭selinux，执行的命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0``sed -i --follow-symlinks ``&#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;` `/etc/sysconfig/selinux</span><br></pre></td></tr></table></figure>

<p>2）防火墙（可选）和网络设置，所有的主机都执行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp; systemctl disable firewalld``modprobe br_netfilter``echo ``&#x27;1&#x27;` `&gt; /proc/sys/net/bridge/bridge-nf-call-iptables``sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>

<p>3）#设置内核参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/security/limits.conf``* soft nofile 32768``* hard nofile 65535``* soft nproc 32768``* hadr nproc 65535</span><br></pre></td></tr></table></figure>

<p>4）设置k8s内核参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/sysctl.d/k8s.conf``net.bridge.bridge-nf-call-ip6tables = 1``net.bridge.bridge-nf-call-iptables = 1``net.ipv4.ip_nonlocal_bind = 1``net.ipv4.ip_forward = 1``vm.swappiness=0</span><br></pre></td></tr></table></figure>

<p>5）重新加载生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl --system``sudo sysctl -p</span><br></pre></td></tr></table></figure>

<p>\6) 安装 python 及 epel (<strong>在Ansible主机上安装并配置好与各node的免秘钥登录)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release python36 python36-pip git</span><br><span class="line">pip3 install --upgrade pip</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id rancher@192.168.2.51</span><br><span class="line">ssh-copy-id rancher@192.168.2.52</span><br><span class="line">ssh-copy-id rancher@192.168.2.53</span><br></pre></td></tr></table></figure>



<h1 id="2-部署k8s集群"><a href="#2-部署k8s集群" class="headerlink" title="2 部署k8s集群"></a>2 部署k8s集群</h1><p>1）#克隆项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:``//github.com/kubernetes-sigs/kubespray/archive/v2.12.4.tar.gz </span><br><span class="line">tar -zxf v2.12.4.tar.gz </span><br></pre></td></tr></table></figure>

<p>2）# Install dependencies from <code>requirements.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/bin/pip3.6 install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>3）# Copy <code>inventory/sample</code> as <code>inventory/mycluster</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rfp inventory/sample inventory/mycluster</span><br></pre></td></tr></table></figure>

<p>4）# Update Ansible inventory file with inventory builder</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">declare -a IPS=(10.10.1.3 10.10.1.4 10.10.1.5)`CONFIG_FILE=inventory/mycluster/hosts.yaml /usr/bin/python3.6 contrib/inventory_builder/inventory.py $&#123;IPS[@]&#125;</span><br></pre></td></tr></table></figure>

<p>5）# Review and change parameters under <code>inventory/mycluster/group_vars</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat inventory/mycluster/group_vars/all/all.yml` `cat inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</span><br></pre></td></tr></table></figure>

<p>6）# Deploy Kubespray with Ansible Playbook - run the playbook as root</p>
<p># The option <code>--become</code> is required, as for example writing SSL keys in /etc/,</p>
<p># installing packages and interacting with various systemd daemons.</p>
<p># Without –become the playbook will fail to run!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root cluster.yml</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/15/2021-11-15-vim%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/15/2021-11-15-vim%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">vim进阶使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-15T00:00:00+08:00">2021-11-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用了一段时间vim感觉其确实是很强的编辑器，前提是熟悉vim的使用。如果只会切换模式、输入，可能vim感觉并不是很好用，所以说vim入门难。从我的使用经验来看，vim的灵活性上限很高，想要融汇贯通，随心输入，必须先熟悉基本的操作，然后在每次使用vim的时候，任何操作，即使是简单的操作也要求自己使用最方便的方法，不知道可以去查，然后记录并多多练习，开始一段时间按会很痛苦，但是会进步很快。为了系统地掌握vim的命令，加深记忆并方便查找，这里总结vim用法。</p>
<h3 id="1-光标移动"><a href="#1-光标移动" class="headerlink" title="1 光标移动"></a>1 光标移动</h3><h4 id="1-1-最小的移动单元"><a href="#1-1-最小的移动单元" class="headerlink" title="1.1 最小的移动单元"></a>1.1 最小的移动单元</h4><ul>
<li>h 左 </li>
<li>j 下</li>
<li>k 上</li>
<li>l 右</li>
</ul>
<p>不是很好记，但用的多了就熟悉了，总的来说hjkl四个键可移动光标，左边的h就是向左，右边l向右。j像一个向下钩子，为向下。剩下的k向上。</p>
<h4 id="1-2-以单词为单位的光标移动"><a href="#1-2-以单词为单位的光标移动" class="headerlink" title="1.2 以单词为单位的光标移动"></a>1.2 以单词为单位的光标移动</h4><p>w， W向右移动到下一个单词开头。</p>
<p>e,    E向右移动到单词结尾 。</p>
<p>b,   B向左移动到单词开头。</p>
<h4 id="1-3-更大的移动方法"><a href="#1-3-更大的移动方法" class="headerlink" title="1.3 更大的移动方法"></a>1.3 更大的移动方法</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/14/2021-11-14-k8s%E9%83%A8%E7%BD%B2%E5%B0%8F%E6%B8%B8%E6%88%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/14/2021-11-14-k8s%E9%83%A8%E7%BD%B2%E5%B0%8F%E6%B8%B8%E6%88%8F/" class="post-title-link" itemprop="url">k8s部署小游戏</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-14 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-14T00:00:00+08:00">2021-11-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="k8s部署小游戏"><a href="#k8s部署小游戏" class="headerlink" title="k8s部署小游戏"></a>k8s部署小游戏</h3><p>k8s部署小游戏非常简单，比js前端部署方便多了。下面试一试玩一玩<br><code>1 查看镜像</code><br>docker hub里已经有其他人上传的游戏镜像了，我们可以直接拿来用，这就是镜像仓库的优势，可以直接使用别人造好的轮子。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node02 ~]# docker search 2048 </span><br><span class="line">NAME                    DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">quchaonet/2048          项目:[2048游戏]-一个经典的网页小游戏-镜像定…                     6                                       </span><br><span class="line">blackicebird/2048       2048 with logging                               4                                       </span><br><span class="line">amigoscode/2048                                                         1                                       </span><br><span class="line">ponsfrilus/2048nginx    A nginx containter wich run 2048                1                                       [OK]</span><br></pre></td></tr></table></figure>
<p><code>2 部署pod</code><br>使用k8s编排容器，部署一个deploy, 还能高可用 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; game-deploy.yaml &lt;&lt; EOF </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: game-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: game</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: game</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: game</span><br><span class="line">        image: blackicebird/2048</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"># 刚才查到的star多的镜像写上去  </span><br><span class="line">kubectl create -f game-deploy.yaml</span><br></pre></td></tr></table></figure>
<p><code>部署路由，外部访问</code><br>起一个loadbalancer服务，让客户端可以访问到pod, 注意标签对应deploy的标签， targetPort端口是pod的端口.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; game-loadbalancer.yaml &lt;&lt; EOF </span><br><span class="line">apiVersion: v1 </span><br><span class="line">kind: Service</span><br><span class="line">metadata: </span><br><span class="line">  name: game-loadbalancer</span><br><span class="line">spec: </span><br><span class="line">  type: LoadBalancer</span><br><span class="line">  ports: </span><br><span class="line">  - port: 80 </span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector: </span><br><span class="line">    app: game</span><br><span class="line">EOF</span><br><span class="line"># 启动</span><br><span class="line">kubectl create -f game-loadbalancer.yaml</span><br></pre></td></tr></table></figure>
<p><code>查看</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node02 ~]# kubectl get po </span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">game-deployment-84bf68885d-bwctb   1/1     Running   0          21m</span><br><span class="line">game-deployment-84bf68885d-j9qq9   1/1     Running   0          21m</span><br><span class="line">[root@k8s-node02 ~]# kubectl get svc </span><br><span class="line">NAME                TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span><br><span class="line">game-loadbalancer   LoadBalancer   192.168.0.117   175.27.183.90   80:31382/TCP   18m</span><br><span class="line">kubernetes          ClusterIP      192.168.0.1     &lt;none&gt;          443/TCP        9d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>访问</code></p>
<p>打开游览器, EXTERNAL-IP:<port></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/2048-.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/12/2021-11-12-%E4%BB%80%E4%B9%88%E6%98%AFserverless/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/12/2021-11-12-%E4%BB%80%E4%B9%88%E6%98%AFserverless/" class="post-title-link" itemprop="url">什么是serverless</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-12 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-12T00:00:00+08:00">2021-11-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-什么是severless"><a href="#1-什么是severless" class="headerlink" title="1 什么是severless ?"></a>1 什么是severless ?</h1><p>Serverless（无服务器架构）是指服务端逻辑由开发者实现，运行在无状态的计算容器中，由事件触发，完全被第三方管理，其业务层面的状态则存储在数据库或其他介质中。 </p>
<p><img src="https://cdn.jsdelivr.net/gh/Yuanwanli1995/markdown_pic@main/blogpic/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%8F%91%E5%B1%95.png"></p>
<p>纵观云原生技术的发展过程， 体现出的一条脉络就是对底层实现、基础设施关心的越来越少，而把重心放在业务逻辑上。</p>
<p>那么serverless到底是什么呢？ 下引用[serverless handbook](<a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/serverless-handbook/concepts-what-is-serverless.md">什么是 Serverless - Serverless 的定义 - 《无服务架构实践手册（Serverless Handbook）》 - 书栈网 · BookStack</a>)给出通俗易懂和具体的定义。</p>
<ul>
<li> 简单版：Serverless（无服务器架构）指的是服务端逻辑由开发者实现，运行在无状态的计算容器中，由事件触发，完全被第三方管理，而业务层面的状态则记录在数据库或存储资源中。</li>
<li> <strong>进阶定义</strong>:  Serverless是由事件（event）驱动（例如 HTTP、pub/sub）的全托管计算服务。用户无需管理服务器等基础设施，只需编写代码和选择触发器（trigger)，比如 RPC 请求、定时器等并上传，其余的工作（如实例选择、扩缩容、部署、容灾、监控、日志、安全补丁等）全部由 serverless 系统托管。用户只需要为代码实际运行消耗的资源付费——代码未运行则不产生费用。</li>
</ul>
<blockquote>
<p> 就像无线互联网实际有的地方也需要用到有线连接一样，无服务器架构仍然在某处有服务器。开发者无需关注服务器，只需关注代码。erverless 相对于 serverful，对业务用户强调 noserver（serverless 并不是说没有服务器，只是业务人员无需关注服务器了，代码仍然是运行在真实存在的服务器上）的运维理念，业务人员只需要聚焦业务逻辑代码。</p>
</blockquote>
<h1 id="2-有服务到无服务构架有哪些变化？"><a href="#2-有服务到无服务构架有哪些变化？" class="headerlink" title="2 有服务到无服务构架有哪些变化？"></a>2 有服务到无服务构架有哪些变化？</h1><ol>
<li><strong>弱化了存储和计算之间的联系。</strong>服务的储存和计算被分开部署和收费，存储不再是服务本身的一部分，而是演变成了独立的云服务，这使得计算变得无状态化，更容易调度和扩缩容，同时也降低了数据丢失的风险。</li>
<li><strong>代码的执行不再需要手动分配资源。</strong>不需要为服务的运行指定需要的资源（比如使用几台机器、多大的带宽、多大的磁盘等），只需要提供一份代码，剩下的交由 serverless 平台去处理就行了。当前阶段的实现平台分配资源时还需要用户方提供一些策略，例如单个实例的规格和最大并发数，单实例的最大 CPU 使用率。理想的情况是通过某些学习算法来进行完全自动的自适应分配。</li>
<li><strong>按使用量计费。</strong>Serverless按照服务的使用量（调用次数、时长等）计费，而不是像传统的 serverful 服务那样，按照使用的资源（ECS 实例、VM 的规格等）计费。</li>
</ol>
<p>云改变了我们对操作系统的认知，原来一个系统的计算资源、存储和网络是可以分离配置的，而且还可以弹性扩展，但是长久以来，我们在开发应用时始终没有摆脱的服务器的束缚（或者说认知），应用必须运行在不论是实体还是虚拟的服务器上，必须经过部署、配置、初始化才可以运行，还需要对服务器和应用进行监控和管理，还需要保证数据的安全性，这些云能够帮我们简化吗？<strong>让我们只要关注自己代码的逻辑就好了，其它的东西让云帮我实现就好了。</strong></p>
<h1 id="3-serverless发展历史"><a href="#3-serverless发展历史" class="headerlink" title="3 serverless发展历史"></a>3 serverless发展历史</h1><p>serverless是云化的延伸，为了更好的理解, 回顾一下云计算的发展过程</p>
<ul>
<li>LaaS, 2006 年 AWS 推出 EC2（Elastic Compute Cloud），作为第一代 IaaS（Infrastructure as a Service），用户可以通过 AWS 快速的申请到计算资源，并在上面部署自己的互联网服务。IaaS 从本质上讲是服务器租赁并提供基础设施外包服务。<strong>就比如我们用的水和电一样</strong>，我们不会自己去引入自来水和发电，而是直接从自来水公司和电网公司购入，并根据实际使用付费。这使得极大降低了基础设施的成本，而且具有很好扩展性。 </li>
<li>PaaS（Platform as a Service）是构建在 IaaS 之上的一种平台服务，提供操作系统安装、监控和服务发现等功能，用户只需要部署自己的应用即可。</li>
<li>历史上第一个 Serverless 平台可以追溯到 2006 年，名为 Zimki，这个平台提供服务端 JavaScript 应用，虽然他们没有使用Serverless 这个名词，但是他们是第一个“按照实际调用付费”的平台。第一个使用 Serverless 名词的是 <a target="_blank" rel="noopener" href="https://iron.io/">iron.io</a>。</li>
<li>Serverless 实际发展已经有 10 年之久，而随着以 Kubernetes 为基础的的云原生应用平台的兴起，serverless 再度成为人民追逐的焦点。</li>
</ul>
<h1 id="4-severless-分类"><a href="#4-severless-分类" class="headerlink" title="4 severless 分类"></a>4 severless 分类</h1><p>serverless通常分为两个领域，BaaS（Backend as a Service）和 FaaS（Function as a Service)。 </p>
<ul>
<li><p>BaaS（Backend as a Service）后端即服务，一般是一个个的 API 调用后端或别人已经实现好的程序逻辑，比如身份验证服务 Auth0，这些 BaaS 通常会用来管理数据，还有很多公有云上提供的我们常用的开源软件的商用服务，比如亚马逊的 RDS 可以替代我们自己部署的 MySQL，还有各种其它数据库和存储服务。</p>
</li>
<li><p>FaaS（Functions as a Service）函数即服务，FaaS 是无服务器计算的一种形式，当前使用最广泛的是 AWS 的 Lambada。</p>
</li>
</ul>
<p>FaaS 本质上是一种事件驱动的由消息触发的服务，FaaS 供应商一般会集成各种同步和异步的事件源，通过订阅这些事件源，可以突发或者定期的触发函数运行。传统的服务器端软件不同是经应用程序部署到拥有操作系统的虚拟机或者容器中，一般需要长时间驻留在操作系统中运行，而 FaaS 是直接将程序部署上到平台上即可，当有事件到来时触发执行，执行完了就可以卸载掉。</p>
<h1 id="5-severles优缺点"><a href="#5-severles优缺点" class="headerlink" title="5 severles优缺点"></a>5 severles优缺点</h1><h1 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h1><ul>
<li><p> 降低运营成本， Serverless 是非常简单的外包解决方案。它可以让您委托服务提供商管理服务器、数据库和应用程序甚至逻辑，否则您就不得不自己来维护。由于这个服务使用者的数量会非常庞大，于是就会产生规模经济效应。在降低成本上包含了两个方面，即基础设施的成本和人员（运营/开发）的成本。</p>
</li>
<li><p>降低开发成本， aaS 和 PaaS 存在的前提是，服务器和操作系统管理可以商品化。Serverless 作为另一种服务的结果是整个应用程序组件被商品化。</p>
</li>
<li><p>扩展能力，Serverless 架构一个显而易见的优点即“横向扩展是完全自动的、有弹性的、且由服务提供者所管理”。从基本的基础设施方面受益最大的好处是，用户只需支付所需要的计算能力。</p>
</li>
<li><p>更简单的管理，Serverless 架构明显比其他架构更简单。更少的组件，就意味着您的管理开销会更少。</p>
</li>
<li><p>绿色的计算， 按照《福布斯》杂志的统计，在商业和企业数据中心的典型服务器仅提供 5%～15% 的平均最大处理能力的输出。这无疑是一种资源的巨大浪费。随着Serverless架构的出现，让服务提供商提供我们的计算能力最大限度满足实时需求。这将使我们更有效地利用计算资源。</p>
<p>在上面我们提到了使用 IaaS给 我们带来了五点好处，FaaS 当然也包括了这些好处，但是它给我们带来的最大的好处就是<strong>多快好省</strong>。减少从概念原型到实施的等待时间，比自己维护服务更省钱。</p>
</li>
<li><p>降低人力成本，不需要再自己维护服务器，操心服务器的各种性能指标和资源利用率，而是关心应用程序本身的状态和逻辑。而且 serverless 应用本身的部署也十分容易，我们只要上传基本的代码但愿，例如 Javascript 或 Python 的源代码的 zip 文件，以及基于JVM的语言的纯 JAR 文件。不需使用 Puppet、Chef、Ansible 或 Docker 来进行配置管理，降低了运维成本。同时，对于运维来说，也不再需要监控那些更底层的如磁盘使用量、CPU 使用率等底层和长期的指标信息，而是监控应用程序本身的度量，这将更加直观和有效。</p>
</li>
<li><p>降低风险，对于组件越多越复杂的系统，出故障的风险就越大。我们使用 BaaS 或 FaaS 将它们外包出去，让专业人员来处理这些故障，有时候比我们自己来修复更可靠，利用专业人员的知识来降低停机的风险，缩短故障修复的时间，让我们的系统稳定性更高。</p>
</li>
<li><p>减少资源开销，我们在申请主机资源一般会评估一个峰值最大开销来申请资源，往往导致过度的配置，这意味着即使在主机闲置的状态下也要始终支付峰值容量的开销。对于某些应用来说这是不得已的做法，比如数据库这种很难扩展的应用，而对于普通应用这就显得不太合理了，虽然我们都觉得即使浪费了资源也比当峰值到来时应用程序因为资源不足而挂掉好。解决这个问题的一个办法就是，不计划到底需要使用多少资源，而是根据实际需要来请求资源，当然前提必须是整个资源池是充足的（公有云显然更适合）。根据使用时间来付费，根据每次申请的计算资源来付费，让计费的粒度更小，将更有利于降低资源的开销。这是对应用程序本身的优化，例如让每次请求耗时更短，让每次消耗的资源更少将能够显著节省成本。</p>
</li>
<li><p>增加缩放的灵活性， 以 AWS Lamba 为例，当平台接收到第一个触发函数的事件时，它将启动一个容器来运行你的代码。如果此时收到了新的事件，而第一个容器仍在处理上一个事件，平台将启动第二个代码实例来处理第二个事件。AWS lambad 的这种自动的零管理水平缩放，将持续到有足够的代码实例来处理所有的工作负载。但是，AWS 仍然只会向您收取代码的执行时间，无论它需要启动多少个容器实例要满足你的负载请求。例如，假设所有事件的总执行时间是相同的，在一个容器中按顺序调用Lambda 100 次与在 100 个不同容器中同时调用 100 次 Lambda 的成本是 一样的。当然 AWS Lambada 也不会无限制的扩展实例个数，如果有人对你发起了 DDos 攻击怎么办，那么不就会产生高昂的成本吗？AWS 是有默认限制的，默认执行 Lambada 函数最大并发数是 1000。</p>
</li>
<li><p>缩短创新周期，小团队的开发人员正可以在几天之内从头开始开发应用程序并部署到生产。使用短而简单的函数和事件来粘合强大的驱动数据存储和服务的 API。完成的应用程序具有高度可用性和可扩展性，利用率高，成本低，部署速度快。以 Docker 为代表的容器技术仅仅是缩短了应用程序的迭代周期，而 serverless 技术是直接缩短了创新周期，从概念到最小可行性部署的时间，让初级开发人员也能在很短的时间内完成以前通常要经验丰富的工程师才能完成的项目。</p>
</li>
</ul>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><ul>
<li> 状态管理， 要实现自由的缩放，无状态是必须的，而对于有状态的服务，使用serverless这就是丧失了灵活性，有状态服务需要与存储交互就不可避免的增加了延迟和复杂性。</li>
<li>延迟，应用程序中不同组件的访问延迟是一个大问题，我们可以通过使用专有的网络协议、RPC 调用、数据格式来优化，或者是将实例放在同一个机架内或同一个主机实例上来优化以减少延迟。而 serverless 应用程序是高度分布式、低耦合的，这就意味着延迟将始终是一个问题，单纯使用 serverless 的应用程序是不太现实的。</li>
<li>本地测试，Serverless 应用的本地测试困难是一个很棘手的问题。虽然可以在测试环境下使用各种数据库和消息队列来模拟生产环境，但是对于无服务应用的集成或者端到端测试尤其困难，很难在本地模拟应用程序的各种连接，并与性能和缩放的特性结合起来测试，并且 serverless 应用本身也是分布式的，简单的将无数的 FaaS 和 BaaS 组件粘合起来也是有挑战性的。</li>
</ul>
<h1 id="5-serverless使用场景"><a href="#5-serverless使用场景" class="headerlink" title="5 serverless使用场景"></a>5 serverless使用场景</h1><p>了解Severless的应用优劣之后，我们看一下severless比较适合的场景。 </p>
<ul>
<li>异步的并发，组件可独立部署和扩展</li>
<li>应对突发或服务使用量不可预测（主要是为了节约成本，因为 Serverless 应用在不运行时不收费）</li>
<li>短暂、无状态的应用，对冷启动时间不敏感</li>
<li>需要快速开发迭代的业务（因为无需提前申请资源，因此可以加快业务上线速度）</li>
</ul>
<p>Serverless 的使用场景示例如：</p>
<ul>
<li>ETL</li>
<li>机器学习及 AI 模型处理</li>
<li>图片处理</li>
<li>IoT 传感器数据分析</li>
<li>流处理</li>
<li>聊天机器人</li>
</ul>
<p>示例： </p>
<p>我们以一个游戏应用为例，来说明什么是 serverless 应用。</p>
<p>一款移动端游戏至少包含如下几个特性：</p>
<ul>
<li>移动端友好的用户体验</li>
<li>用户管理和权限认证</li>
<li>关卡、升级等游戏逻辑，游戏排行，玩家的等级、任务等信息</li>
</ul>
<p>传统的应用程序架构可能是这样的：</p>
<p><img src="https://static.sitestack.cn/projects/serverless-handbook/aa9eaf9b461ca39ea6b4bf01fc5f129b.jpeg" alt="传统应用程序架构"></p>
<ul>
<li>一个 app 前端，iOS 或者安卓</li>
<li>用 Java 写的后端，使用 JBoss 或者 Tomcat 做 server 运行</li>
<li>使用关系型数据库存储用户数据，如 MySQL</li>
</ul>
<p>这样的架构可以让前端十分轻便，不需要做什么应用逻辑，只是负责渲染用户界面，将请求通过 HTTP 发送给后端，而所有的数据操作都是有由后端的 Java 程序来完成的。</p>
<p>这样的架构开发起来比较容易，但是维护起来确十分复杂，前端开发、后端的开发都需要十分专业的人员、环境的配置，还要有人专门维护数据库、应用的更新和升级。</p>
<p><img src="https://static.sitestack.cn/projects/serverless-handbook/37377bea471dae7039d9335f7b232a8e.jpeg" alt="Serverless 架构"></p>
<p>而在 serverless 架构中，我们不再需要在服务器端代码中存储任何会话状态，而是直接将它们存储在 NoSQL 中，这样将使应用程序无状态，有助于弹性扩展。前端可以直接利用 BaaS 而减少后端的编码需求，这样架构的本质上是减少了应用程序开发的人力成本，降低了自己维护基础设施的风险，而且利用云的能力更便于扩展和快速迭代。</p>
<h1 id="6-serverless核心技术"><a href="#6-serverless核心技术" class="headerlink" title="6 serverless核心技术"></a>6 serverless核心技术</h1><p>Serverless 是由事件驱动的全托管计算服务，它的核心技术包括：</p>
<ul>
<li>函数的规范定义</li>
<li>函数部署流水线</li>
<li>Workflow 设置</li>
<li>0-m-n 扩缩容</li>
<li>快速冷启动</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>云原生经过这么多年的发展，已经逐渐变成到用户仅需关注业务和所需的资源。比如，通过K8S这类编排工具，用户只要关注自己的计算和需要的资源（CPU、内存等）就行了，不需要操心到机器这一层。serverless的发展这条路走的越来越远，因为这极大的提高了资源的使用效率，降低了成本。这就是生产力的体现。 Serverless架构让人们不再操心运行所需的资源，只需关注自己的业务逻辑，并且为实际消耗的资源付费。任何新概念新技术的落地，本质上都是要和具体业务去结合，去真正解决具体问题。虽然Serverless很多地方不成熟，亟待完善。不过Serverless自身的特性，对于开发者来说，吸引力是巨大的。</p>
<blockquote>
<p>参考文献： severless handbook </p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/11/2021-11-12-openfaas-v0.2%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/11/2021-11-12-openfaas-v0.2%E6%96%87%E6%A1%A3/" class="post-title-link" itemprop="url">openfaas v0.2文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-11 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-11T00:00:00+08:00">2021-11-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="openfass-让无服务变得简单"><a href="#openfass-让无服务变得简单" class="headerlink" title="openfass  让无服务变得简单"></a>openfass  让无服务变得简单</h3><p>OpenFaaS®使开发人员可以轻松地将事件驱动函数和微服务部署到Kubernetes，而无需重复的模板代码。将您的代码或现有二进制文件打包到Docker镜像中，以获得具有自动伸缩和度量的高度可伸缩端点。</p>
<h3 id="亮点"><a href="#亮点" class="headerlink" title="亮点"></a>亮点</h3><ul>
<li>开源函数框架-在任何云上运行它，无需担心锁定</li>
<li>编写任何语言的函数，并将它们打包到Docker/ oci格式的容器中</li>
<li>易于使用的内置UI，强大的CLI和一键式安装</li>
<li>处理流量峰值，并在空闲时进行伸缩</li>
<li>活跃的社区-贡献和归属</li>
</ul>
<h3 id="在线学习"><a href="#在线学习" class="headerlink" title="在线学习"></a>在线学习</h3><p>pass</p>
<h2 id="社群"><a href="#社群" class="headerlink" title="社群"></a>社群</h2><p>pass</p>
<h1 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h1><h2 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h2><p>OpenFaaS可以部署到Kubernetes、OpenShift、Docker Swarm等多种容器管理工具上，也可以部署到使用faasd的单个主机上。</p>
<p>Kubernetes还是faasd ?</p>
<p>我们建议在工作中使用OpenFaaS时使用Kubernetes或OpenShift，因为它可以很好地扩展，如果您需要，OpenFaaS Ltd可以提供商业支持。一些公司已经在生产中使用了Faasd，但您应该了解其中的权衡。用户以后可以在这两种部署选项之间切换。</p>
<h2 id="PLONK-Stack"><a href="#PLONK-Stack" class="headerlink" title="PLONK Stack"></a>PLONK Stack</h2><p>PLONK是一个用于构建应用程序的云本地堆栈，它代表:</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/d41d8cd98f00b204.md">Prometheus</a>-度量和时间序列</p>
</li>
<li><p>Linux/Linkerd* - OS或service mesh (Linkerd是可选的)</p>
</li>
<li><p>OpenFaaS——计算的管理和自动扩展——PaaS/FaaS, Kubernetes之上的一个开发人员友好的抽象。每个函数或微服务都构建为不可变的Docker容器或oci格式的镜像。</p>
</li>
<li><p>异步消息总线/队列</p>
</li>
<li><p>Kubernetes -声明式的、可扩展的、伸缩的、自修复的集群</p>
</li>
</ul>
<p>Kubernetes上的OpenFaaS包了NATS和Prometheus。您可以在OpenFaaS架构文档中阅读有关堆栈的内容。</p>
<h2 id="Kubernetes-推荐用于生产和工作"><a href="#Kubernetes-推荐用于生产和工作" class="headerlink" title="Kubernetes(推荐用于生产和工作)"></a>Kubernetes(推荐用于生产和工作)</h2><p>关于安全的前言</p>
<p>默认情况下，使用OpenFaaS启用身份验证，但是如果您在公共Internet上使用OpenFaaS，您还需要为您的集群获取TLS证书。免费证书可从LetsEncrypt.org获得。</p>
<p>在Kubernetes集群中安装OpenFaaS有三种推荐方法:</p>
<ul>
<li>使用我们的CLI安装程序arkade -(推荐)</li>
<li>使用Helm chart, Flux或ArgoCD (GitOps工作流)</li>
<li>或者使用静态生成的YAML文件(不推荐)</li>
</ul>
<p>了解关于每个选项以及如何将OpenFaaS部署到Kubernetes的更多信息:<a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/34026a917156630f.md">Deploy to Kubernetes</a></p>
<h2 id="faasd-每个人的无服务"><a href="#faasd-每个人的无服务" class="headerlink" title="faasd - 每个人的无服务"></a>faasd - 每个人的无服务</h2><p>faasd是OpenFaaS，没有Kubernetes的复杂性和成本。它在要求非常低的单个主机上运行良好，可以在几分钟内部署。在内部，它使用容器和容器网络接口(CNI)以及来自主项目的相同核心OpenFaaS组件。</p>
<p>什么时候应该在Kubernetes上使用faasd over OpenFaaS ?</p>
<ul>
<li>你有一个成本敏感的项目-运行faasd在5-10美元的VPS或在你的Raspberry Pi上</li>
<li>当您只需要一些功能或微服务，而不需要集群的成本时</li>
<li>当你没有时间学习或管理Kubernetes的时候</li>
<li>在物联网和边缘用例中部署嵌入式应用</li>
<li>将应用程序压缩包装以供客户或客户使用</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/openfaas/faasd/">Deploy faasd</a></p>
<h2 id="OpenShift"><a href="#OpenShift" class="headerlink" title="OpenShift"></a>OpenShift</h2><p>OpenShift是由RedHat生产的Kubernetes的一个变体。</p>
<p>您可以使用我们的CLI安装程序<a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/d41d8cd98f00b204.md">arkade</a> 或标准helm chart部署到OpenShift。</p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/f81fd004e195cc7a.md">Deploy to OpenShift</a></p>
<h2 id="Docker-Swarm-弃用"><a href="#Docker-Swarm-弃用" class="headerlink" title="Docker Swarm (弃用)"></a>Docker Swarm (弃用)</h2><p>取消免费社区支持，Docker Swarm的免费社区支持已经停止。如果您在业务中运行Docker Swarm和OpenFaaS，并且需要持续的支持，那么请尽快联系支持人员。</p>
<p>为什么做出这个决定?Docker Swarm被广泛认为是“生命终结”产品。像Kubernetes这样的项目拥有更广泛的生态系统，并不断从各自的社区获得投资。</p>
<p>如果你被Docker Swarm所吸引是因为你认为它比Kubernetes更容易管理，我们建议你看看托管的Kubernetes服务，或 <a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/d41d8cd98f00b204.md">k3s.io</a>.</p>
<p>如果你几乎不需要任何操作，那么faasd(上面)应该是你的首选。</p>
<h1 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>您可以使用curl实用程序脚本、brew或从发布页面下载二进制文件来安装CLI。安装完成后，您将获得faas-cli命令和faas别名。</p>
<h3 id="Linux-or-macOS"><a href="#Linux-or-macOS" class="headerlink" title="Linux or macOS"></a>Linux or macOS</h3><p>使用curl脚本:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sSL https://cli.openfaas.com | sudo -E sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p>标志-E允许将任何http_proxy环境变量传递给安装bash脚本。</p>
</blockquote>
<p>使用curl将二进制文件下载到当前目录，然后打印安装说明:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sSL https://cli.openfaas.com | sh</span><br></pre></td></tr></table></figure>

<p>通过 brew</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install faas-cli</span><br></pre></td></tr></table></figure>

<p>注意, brew版本可能不会运行最新的小版本，但会定期更新。</p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>在powershell中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$version = (Invoke-WebRequest &quot;https://api.github.com/repos/openfaas/faas-cli/releases/latest&quot; | ConvertFrom-Json)[0].tag_name</span><br><span class="line">(New-Object System.Net.WebClient).DownloadFile(&quot;https://github.com/openfaas/faas-cli/releases/download/$version/faas-cli.exe&quot;, &quot;faas-cli.exe&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="覆盖环境变量"><a href="#覆盖环境变量" class="headerlink" title="覆盖环境变量"></a>覆盖环境变量</h3><p>如果set和没有设置其他命令行标志，将默认使用几个覆盖。</p>
<ul>
<li><code>OPENFAAS_TEMPLATE_URL</code> -设置获取模板的默认URL</li>
<li><code>OPENFAAS_PREFIX</code> - 当使用 <code>faas-cli new</code> - 这可以替代 <code>--prefix</code></li>
<li><code>OPENFAAS_URL</code> -来覆盖默认网关URL</li>
</ul>
<h3 id="使用sudo运行-faas-cli"><a href="#使用sudo运行-faas-cli" class="headerlink" title="使用sudo运行 faas-cli"></a>使用sudo运行 <code>faas-cli</code></h3><p>如果您使用sudo运行faas-cli，我们建议使用sudo -E来传递您可能配置的任何环境变量，如http_proxy、https_proxy或no_proxy。</p>
<h3 id="Docker-镜像"><a href="#Docker-镜像" class="headerlink" title="Docker 镜像"></a>Docker 镜像</h3><p>faas-cli还可以作为Docker镜像使用，这使得它可以方便地用于CI作业，如使用Jenkins管道或cron中的任务。</p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/openfaas/faas-cli/tags/">https://hub.docker.com/r/openfaas/faas-cli/tags/</a></p>
<p>它没有“latest”标签，请在Docker Hub的标签页中找到您想要使用的CLI版本。这些对应于GitHub的发布。</p>
<blockquote>
<p>注意:Docker映像不能用于直接执行构建，但你可以使用它来生成一个构建上下文，可以与容器构建器(如Docker, buildkit或Kaniko)在构建管道的另一部分一起使用。</p>
</blockquote>
<p>Docker映像的用例:</p>
<ul>
<li>不运行docker build - faas-cli——shrinkwrap来生成构建上下文</li>
<li>将现有映像部署到远程服务器faas-cli Deploy</li>
<li>使用faas-cli secret管理秘密</li>
<li>通过使用faas-cli调用cron调用函数</li>
<li>使用faas-cli信息检查远程网关的运行状况</li>
</ul>
<h3 id="从源代码安装"><a href="#从源代码安装" class="headerlink" title="从源代码安装"></a>从源代码安装</h3><p>该<a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/742c32d44c647dc9.md#contribute">指南</a>提供了从源代码构建和配置Golang开发环境的说明。</p>
<ul>
<li>GitHub上的star /fork: <a target="_blank" rel="noopener" href="https://github.com/openfaas/faas-cli">faas-cli</a></li>
</ul>
<h3 id="教程-学习如何使用CLI"><a href="#教程-学习如何使用CLI" class="headerlink" title="教程: 学习如何使用CLI"></a>教程: 学习如何使用CLI</h3><p><a target="_blank" rel="noopener" href="https://blog.alexellis.io/quickstart-openfaas-cli/">Morning coffee with the OpenFaaS CLI</a></p>
<h2 id="创建新的函数"><a href="#创建新的函数" class="headerlink" title="创建新的函数"></a>创建新的函数</h2><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>一旦你安装了<code>faas-cli</code>，你可以开始通过<code>faas-cli up</code>命令或使用单独的命令来创建和部署函数:</p>
<ul>
<li><code>faas-cli build</code>  构建映像到本地Docker库中</li>
<li><code>faas-cli push</code>  将该映像推到远程容器注册表</li>
<li><code>faas-cli deploy</code> 将函数部署到集群中</li>
</ul>
<p><code>faas-cli up</code>命令在一个命令中自动执行上述所有操作。</p>
<p>对于Raspberry Pi和ARM，你必须使用publish命令而不是build和push，或者up。</p>
<p>请看这里的注释:<a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/094921046add2521.md">Building multi-arch images for ARM and Raspberry Pi</a></p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>OpenFaaS CLI有一个内置的模板引擎，可以用给定的编程语言创建新的函数。它的工作方式是从当前工作文件夹中的<code>./template</code>位置读取模板列表。</p>
<p>在创建一个新函数之前，请确保您从GitHub通过 <a target="_blank" rel="noopener" href="https://github.com/openfaas/templates">templates repository</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ faas-cli template pull</span><br></pre></td></tr></table></figure>

<p>本页面展示了如何在最流行的语言中生成函数，并解释了如何管理它们的依赖关系。</p>
<h3 id="Classic-vs-of-watchdog模板"><a href="#Classic-vs-of-watchdog模板" class="headerlink" title="Classic vs. of-watchdog模板"></a>Classic vs. of-watchdog模板</h3><p>经典模板保存在 <a target="_blank" rel="noopener" href="https://github.com/openfaas/templates">openfaas/templates</a>存储库中，并且基于使用STDIO与函数通信的<em>Classic Watchdog</em>。watchdog使用HTTP与函数进行通信，它的大多数模板都可以在GitHub上的<a target="_blank" rel="noopener" href="https://github.com/openfaas-incubator/">openfaas-incubator</a> 组织和商店中获得。</p>
<p>如何选择： </p>
<ul>
<li>如果你正在开始或遵循教程或指南，请使用<em>Classic Watchdog</em></li>
<li>如果您需要更高的性能或需要完全控制HTTP响应，请使用of-watchdog</li>
</ul>
<p>参考：  <a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/openfaas-0.20-en/e9ae346d3d971482.md">watchdog design</a></p>
<h3 id="存储过程注册模板"><a href="#存储过程注册模板" class="headerlink" title="存储过程注册模板"></a>存储过程注册模板</h3><p>您可以从官方商店浏览模板，或者创建自己的商店并在那里添加自己的模板。要查看哪些模板是可用的类型<code>faas-cli template store list</code>，你应该在终端中看到以下内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ faas-cli template store list</span><br><span class="line">NAME                    SOURCE             DESCRIPTION</span><br><span class="line">csharp                  openfaas           Official C# template</span><br><span class="line">dockerfile              openfaas           Official Dockerfile template</span><br><span class="line">...</span><br><span class="line">node10-express          openfaas-incubator NodeJS 10 Express template</span><br><span class="line">ruby-http               openfaas-incubator Ruby 2.4 HTTP template</span><br><span class="line">golang-middleware       openfaas-incubator Golang Middleware template</span><br><span class="line">csharp-httprequest      distantcam         C# HTTP template</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>选择一个模板并使用命令在本地检索它:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ faas-cli template store pull node10-express</span><br></pre></td></tr></table></figure>

<p>下载后，您选择的模板和存储在同一存储库中的其他模板将可用:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ faas-cli new --list</span><br><span class="line">Languages available as templates:</span><br><span class="line">- node10-express</span><br></pre></td></tr></table></figure>

<p>您可以通过为这两个命令指定<code>——url</code>标志来拉出并列出自定义模板存储，从而添加自己的存储。</p>
<p>经典模板保存在 <a target="_blank" rel="noopener" href="https://github.com/openfaas/templates">openfaas/templates</a> 存储库中。</p>
<h3 id="获取模板"><a href="#获取模板" class="headerlink" title="获取模板"></a>获取模板</h3><p>下面列出了几个可用的Golang模板。</p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Style</th>
<th align="left">Watchdog</th>
<th align="left">Dependencies</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>go</code></td>
<td align="left">Function</td>
<td align="left">classic</td>
<td align="left"><code>dep</code></td>
</tr>
<tr>
<td align="left"><code>golang-middleware</code></td>
<td align="left">Microservice</td>
<td align="left">of-watchdog</td>
<td align="left"><code>dep</code> or Go modules</td>
</tr>
<tr>
<td align="left"><code>golang-http</code></td>
<td align="left">Function</td>
<td align="left">of-watchdog</td>
<td align="left"><code>dep</code> or Go modules</td>
</tr>
</tbody></table>
<p>所有的模板都可以通过<code>faas-cli template store list/pull</code></p>
<h3 id="Go-golang-http-（of-watchdog-template）"><a href="#Go-golang-http-（of-watchdog-template）" class="headerlink" title="Go golang-http （of-watchdog template）"></a>Go <code>golang-http</code> （of-watchdog template）</h3><p><a target="_blank" rel="noopener" href="https://github.com/openfaas-incubator/golang-http-template">Read the README for golang-http</a>此模板具有与AWS Lambda类似的API。</p>
<p>Golang模块通过 <code>--build-arg</code> 使用 <code> GO111MODULE=1</code> 或者<code>GO111MODULE=auto</code></p>
<h4 id="Go-golang-middleware-of-watchdog-template"><a href="#Go-golang-middleware-of-watchdog-template" class="headerlink" title="Go golang-middleware - (of-watchdog template)"></a>Go <code>golang-middleware</code> - (of-watchdog template)</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/11/10/2021-11-10-%E9%9D%9E%E6%AD%A3%E5%B8%B8%E5%85%B3%E9%97%ADvi%E7%BC%96%E8%BE%91%E5%99%A8%E6%97%B6%E4%BC%9A%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA.swp%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/10/2021-11-10-%E9%9D%9E%E6%AD%A3%E5%B8%B8%E5%85%B3%E9%97%ADvi%E7%BC%96%E8%BE%91%E5%99%A8%E6%97%B6%E4%BC%9A%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA.swp%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">非正常关闭vi编辑器时会生成一个.swp文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-10 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-10T00:00:00+08:00">2021-11-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-02-21 14:54:31" itemprop="dateModified" datetime="2022-02-21T14:54:31+08:00">2022-02-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="非正常关闭vi编辑器时会生成一个-swp文件"><a href="#非正常关闭vi编辑器时会生成一个-swp文件" class="headerlink" title="非正常关闭vi编辑器时会生成一个.swp文件"></a>非正常关闭vi编辑器时会生成一个.swp文件</h3><p>使用vim，有时看到swp这个文件,这个文件是怎么产生的呢， 当你打开一个文件，vi就会生成这么一个.(filename)swp文件, 以备不测， 如果你正常退出，那么这个这个swp文件将会自动删除 。</p>
<p>不测分为：</p>
<ol>
<li>当你用多个程序编辑同一个文件时, 此时为了避免同一个文件产生两个不同的版本（vim中的原话），还是选择readonly为好。</li>
<li>非常规退出时， 可以用vim -r filename恢复，然后再把swp文件删除, 但要确保swp文件没有用了。 </li>
</ol>
<p>你可以使用来恢复文件</p>
<blockquote>
<p>vi -r {your file name}</p>
</blockquote>
<p>也可以删除swp文件，不然每一次编辑时总是有这个提示。</p>
<blockquote>
<p>rm .{your file name}.swp</p>
</blockquote>
<p>也可以再提示的时候选择<code>R</code>恢复， 恢复后swp文件还是存在，需要删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">“.es-server.yaml.swp” already exists!</span><br><span class="line">[O]pen Read-Only, (E)dit anyway, (R)ecover, (Q)uit:</span><br></pre></td></tr></table></figure>

<p>选择<code>Edit anyway</code>，不能解决问题，下次打开文件的时候还是会提示。 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuanwanli</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  





</body>
</html>
