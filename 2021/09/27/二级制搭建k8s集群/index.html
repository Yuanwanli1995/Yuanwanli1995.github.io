<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yuanwanli1995.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="1 准备工作1.1 服务器或虚拟机12345678910111213操作系统：    CentOS7内核： 三台或更多节点及其地址master：192.168.2.20  kube-apiserver，kube-controller-manager，kube-scheduler，etcdnode1：192.168.2.21  kubelet，kube-proxy，docker，flannel，et">
<meta property="og:type" content="article">
<meta property="og:title" content="二级制方法搭建k8s集群">
<meta property="og:url" content="http://yuanwanli1995.github.io/2021/09/27/%E4%BA%8C%E7%BA%A7%E5%88%B6%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="brisk">
<meta property="og:description" content="1 准备工作1.1 服务器或虚拟机12345678910111213操作系统：    CentOS7内核： 三台或更多节点及其地址master：192.168.2.20  kube-apiserver，kube-controller-manager，kube-scheduler，etcdnode1：192.168.2.21  kubelet，kube-proxy，docker，flannel，et">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-27T07:20:00.000Z">
<meta property="article:modified_time" content="2021-09-28T15:08:44.498Z">
<meta property="article:author" content="yuanwanli">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yuanwanli1995.github.io/2021/09/27/%E4%BA%8C%E7%BA%A7%E5%88%B6%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://yuanwanli1995.github.io/2021/09/27/%E4%BA%8C%E7%BA%A7%E5%88%B6%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/","path":"2021/09/27/二级制搭建k8s集群/","title":"二级制方法搭建k8s集群"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>二级制方法搭建k8s集群 | brisk</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">brisk</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.</span> <span class="nav-text">1 准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%88%96%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 服务器或虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 修改主机名  ( 所有节点操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%BC%BA-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 关闭防火强 ( 所有节点操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%85%B3%E9%97%ADselinux-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 关闭selinux ( 所有节点操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E5%85%B3%E9%97%ADswap-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.5.</span> <span class="nav-text">1.5 关闭swap ( 所有节点操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-%E5%90%8C%E6%AD%A5%E6%97%B6%E9%97%B4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.6.</span> <span class="nav-text">1.6 同步时间 ( 所有节点操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-%E5%B0%86%E6%A1%A5%E6%8E%A5%E7%9A%84IPv4%E6%B5%81%E9%87%8F%E4%BC%A0%E9%80%92%E5%88%B0iptables%E7%9A%84%E9%93%BE-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">1.7.</span> <span class="nav-text">1.7 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-8-%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%B8%8EIP%E5%AF%B9%E5%BA%94%E7%9A%84%E5%85%B3%E7%B3%BB-master%E6%93%8D%E4%BD%9C"><span class="nav-number">1.8.</span> <span class="nav-text">1.8 添加主机名与IP对应的关系 ( master操作 )</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-cfssl%E8%AF%81%E4%B9%A6-master%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">2  cfssl证书  (master操作)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 下载文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 创建配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 生成证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%83%A8%E7%BD%B2etcd"><span class="nav-number">3.</span> <span class="nav-text">3 部署etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E4%B8%8B%E8%BD%BD%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85-master%E6%93%8D%E4%BD%9C"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 下载二进制包 ( master操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%A7%A3%E5%8E%8B%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85-master%E6%93%8D%E4%BD%9C"><span class="nav-number">3.2.</span> <span class="nav-text">3.2  解压二进制包 ( master操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E9%85%8D%E7%BD%AEetcd-conf-master%E6%93%8D%E4%BD%9C"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 配置etcd.conf  ( master操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E9%85%8D%E7%BD%AEetcd-service-master%E6%93%8D%E4%BD%9C"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 配置etcd.service  ( master操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6-master%E6%93%8D%E4%BD%9C"><span class="nav-number">3.5.</span> <span class="nav-text">3.5  拷贝证书  ( master操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E5%B0%86%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%88%B0node%E8%8A%82%E7%82%B9-master%E6%93%8D%E4%BD%9C"><span class="nav-number">3.6.</span> <span class="nav-text">3.6  将文件复制到node节点 ( master操作 )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-%E4%BF%AE%E6%94%B9node%E8%8A%82%E7%82%B9etcd-conf-%E4%B8%AD%E7%9A%84%E5%90%8D%E7%A7%B0%E5%92%8CIP"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 修改node节点etcd.conf 中的名称和IP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E5%90%AF%E5%90%AF%E5%8A%A8%EF%BC%9A"><span class="nav-number">3.8.</span> <span class="nav-text">3.8 启动并设置开启启动：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-%E6%A3%80%E6%9F%A5etcd%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%EF%BC%9A"><span class="nav-number">3.9.</span> <span class="nav-text">3.9 检查etcd集群状态：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%9C%A8work-node%E8%8A%82%E7%82%B9%E4%B8%8A%E5%AE%89%E8%A3%85docker"><span class="nav-number">4.</span> <span class="nav-text">4 在work node节点上安装docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-node1-node2%E5%AE%89%E8%A3%85docker"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 node1 node2安装docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-systemd-%E7%AE%A1%E7%90%86-docker"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 systemd 管理 docker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-kube-apiserver-%EF%BC%88master%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">5.</span> <span class="nav-text">5 kube-apiserver （master操作）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E7%94%9F%E6%88%90-kube-apiserver-%E9%9C%80%E8%A6%81%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 生成 kube-apiserver 需要的配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 生成证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E9%83%A8%E7%BD%B2-kube-apiserver"><span class="nav-number">5.3.</span> <span class="nav-text">5.2 部署 kube apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B"><span class="nav-number">5.4.</span> <span class="nav-text">解压</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E9%85%8D%E7%BD%AEkube-apiserver-conf"><span class="nav-number">5.5.</span> <span class="nav-text">5.3 配置kube-apiserver.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E9%85%8D%E7%BD%AEtoken-csv"><span class="nav-number">5.6.</span> <span class="nav-text">5.4 配置token.csv</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-%E9%85%8D%E7%BD%AEkube-apiserver-service"><span class="nav-number">5.7.</span> <span class="nav-text">5.5 配置kube-apiserver.service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%90%AF%E5%8A%A8%E4%B8%8E%E5%90%AF%E5%8A%A8"><span class="nav-number">5.8.</span> <span class="nav-text">5.6 设置自启动与启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-%E6%8E%88%E6%9D%83-kubelet-bootstrap-%E7%94%A8%E6%88%B7%E5%85%81%E8%AE%B8%E8%AF%B7%E6%B1%82%E8%AF%81%E4%B9%A6"><span class="nav-number">5.9.</span> <span class="nav-text">5.7 授权 kubelet-bootstrap 用户允许请求证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E9%83%A8%E7%BD%B2-kube-controller-manager%EF%BC%88master%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">6 部署 kube-controller-manager（master操作）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E9%85%8D%E7%BD%AEkube-controller-manager-conf"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 配置kube-controller-manager.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-systemd-%E7%AE%A1%E7%90%86-controller-manager"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 systemd 管理 controller-manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E8%AE%BE%E7%BD%AEkube-controller-manager%E7%9A%84%E8%87%AA%E5%90%AF%E5%8A%A8%E5%B9%B6%E5%90%AF%E5%8A%A8"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 设置kube-controller-manager的自启动并启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E9%83%A8%E7%BD%B2-kube-scheduler%EF%BC%88master%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">7 部署 kube-scheduler（master操作）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E9%85%8D%E7%BD%AEkube-scheduler-conf"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 配置kube-scheduler.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E9%85%8D%E7%BD%AE-kube-scheduler-service"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 配置 kube-scheduler.service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-kube-scheduler%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="nav-number">7.3.</span> <span class="nav-text">7.3 kube-scheduler自启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-number">7.4.</span> <span class="nav-text">7.4 查看集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E9%83%A8%E7%BD%B2work-node-%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="nav-number">8.</span> <span class="nav-text">8 部署work node 的组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E6%8B%B7%E8%B4%9D%E6%96%87%E4%BB%B6"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 拷贝文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E9%85%8D%E7%BD%AEkubelet-conf"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 配置kubelet.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-%E9%85%8D%E7%BD%AEkubelet-config-yml"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 配置kubelet-config.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-%E7%94%9F%E6%88%90bootstrap-kubeconfig%E6%96%87%E4%BB%B6"><span class="nav-number">8.4.</span> <span class="nav-text">8.4 生成bootstrap.kubeconfig文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-%E7%94%9F%E6%88%90-kubelet-bootstrap-kubeconfig-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">8.5.</span> <span class="nav-text">8.5 生成 kubelet bootstrap kubeconfig 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-6-systemd%E7%AE%A1%E7%90%86kubelet-service"><span class="nav-number">8.6.</span> <span class="nav-text">8.6 systemd管理kubelet.service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-7-kubelet-%E5%90%AF%E5%8A%A8"><span class="nav-number">8.7.</span> <span class="nav-text">8.7 kubelet 启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-8-%E6%89%B9%E5%87%86%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4-%EF%BC%88master%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">8.8.</span> <span class="nav-text">8.8 批准加入集群 （master操作）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E9%83%A8%E7%BD%B2kube-proxy"><span class="nav-number">9.</span> <span class="nav-text">9 部署kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-kube-proxy-conf-node%E6%93%8D%E4%BD%9C"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 kube-proxy.conf (node操作)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-kube-proxy-config-yml-node%E6%93%8D%E4%BD%9C"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 kube-proxy-config.yml (node操作)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6-master%E6%93%8D%E4%BD%9C"><span class="nav-number">9.3.</span> <span class="nav-text">9.3 生成证书 (master操作)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-%E7%94%9F%E6%88%90kubeconfig-node%E6%93%8D%E4%BD%9C"><span class="nav-number">9.4.</span> <span class="nav-text">9.4 生成kubeconfig  (node操作)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-5-%E9%85%8D%E7%BD%AEkube-proxy-service-node%E6%93%8D%E4%BD%9C"><span class="nav-number">9.5.</span> <span class="nav-text">9.5 配置kube-proxy.service (node操作)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-6-kube-proxy%E5%90%AF%E5%8A%A8-node%E6%93%8D%E4%BD%9C"><span class="nav-number">9.6.</span> <span class="nav-text">9.6 kube-proxy启动 (node操作)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6"><span class="nav-number">10.</span> <span class="nav-text">10 部署网络组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83-apiserver-%E8%AE%BF%E9%97%AE-kubelet"><span class="nav-number">10.1.</span> <span class="nav-text">授权 apiserver 访问 kubelet</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%E6%96%B0%E5%A2%9E%E5%8A%A0-Worker-Node"><span class="nav-number">11.</span> <span class="nav-text">11 新增加 Worker-Node</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-%E6%8B%B7%E8%B4%9D%E5%B7%B2%E9%83%A8%E7%BD%B2%E5%A5%BD%E7%9A%84Node%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E5%88%B0%E6%96%B0%E8%8A%82%E7%82%B9"><span class="nav-number">11.1.</span> <span class="nav-text">11.1 拷贝已部署好的Node相关文件到新节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-%E5%88%A0%E9%99%A4-kubelet-%E8%AF%81%E4%B9%A6%E5%92%8C-kubeconfig-%E6%96%87%E4%BB%B6"><span class="nav-number">11.2.</span> <span class="nav-text">11.2 删除 kubelet 证书和 kubeconfig 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="nav-number">11.3.</span> <span class="nav-text">11.3 修改主机名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="nav-number">11.4.</span> <span class="nav-text">11.4 启动并设置开机启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-%E5%9C%A8Master%E4%B8%8A%E6%89%B9%E5%87%86%E6%96%B0%E7%9A%84Node-kubelet%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="nav-number">11.5.</span> <span class="nav-text">11.5 在Master上批准新的Node kubelet证书申请</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-6%EF%BC%9A%E6%9F%A5%E7%9C%8BNode%E7%8A%B6%E6%80%81"><span class="nav-number">11.6.</span> <span class="nav-text">11.6：查看Node状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-%E6%B5%8B%E8%AF%95kubernetes%E9%9B%86%E7%BE%A4"><span class="nav-number">12.</span> <span class="nav-text">12 测试kubernetes集群</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yuanwanli</p>
  <div class="site-description" itemprop="description">等不是办法，干才有出路</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yuanwanli1995.github.io/2021/09/27/%E4%BA%8C%E7%BA%A7%E5%88%B6%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yuanwanli">
      <meta itemprop="description" content="等不是办法，干才有出路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="brisk">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          二级制方法搭建k8s集群
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-27 15:20:00" itemprop="dateCreated datePublished" datetime="2021-09-27T15:20:00+08:00">2021-09-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-28 23:08:44" itemprop="dateModified" datetime="2021-09-28T23:08:44+08:00">2021-09-28</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">编程笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1 准备工作"></a>1 准备工作</h2><h3 id="1-1-服务器或虚拟机"><a href="#1-1-服务器或虚拟机" class="headerlink" title="1.1 服务器或虚拟机"></a>1.1 服务器或虚拟机</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">操作系统：</span><br><span class="line">    CentOS7</span><br><span class="line">内核： </span><br><span class="line"></span><br><span class="line">三台或更多节点及其地址</span><br><span class="line">master：</span><br><span class="line">192.168.2.20  kube-apiserver，kube-controller-manager，kube-scheduler，etcd</span><br><span class="line"></span><br><span class="line">node1：</span><br><span class="line">192.168.2.21  kubelet，kube-proxy，docker，flannel，etcd</span><br><span class="line"></span><br><span class="line">node2：</span><br><span class="line">192.168.2.21  kubelet，kube-proxy，docker，flannel，etcd</span><br></pre></td></tr></table></figure>

<h3 id="1-2-修改主机名-所有节点操作"><a href="#1-2-修改主机名-所有节点操作" class="headerlink" title="1.2 修改主机名  ( 所有节点操作 )"></a>1.2 修改主机名  ( 所有节点操作 )</h3><p>master:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname master</span><br></pre></td></tr></table></figure>

<p>node1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node1</span><br></pre></td></tr></table></figure>

<p>node2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果命令失败， 直接修改 /etc/hostname, 重启后生效  </p>
<p>hostname # 可查看是否修改成功</p>
</blockquote>
<h3 id="1-3-关闭防火强-所有节点操作"><a href="#1-3-关闭防火强-所有节点操作" class="headerlink" title="1.3 关闭防火强 ( 所有节点操作 )"></a>1.3 关闭防火强 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有节点相同操作可使用同时发送到所有会话</p>
</blockquote>
<h3 id="1-4-关闭selinux-所有节点操作"><a href="#1-4-关闭selinux-所有节点操作" class="headerlink" title="1.4 关闭selinux ( 所有节点操作 )"></a>1.4 关闭selinux ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0 # 临时关闭</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config # 永久关闭</span><br></pre></td></tr></table></figure>

<h3 id="1-5-关闭swap-所有节点操作"><a href="#1-5-关闭swap-所有节点操作" class="headerlink" title="1.5 关闭swap ( 所有节点操作 )"></a>1.5 关闭swap ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a # 临时关闭；关闭swap主要是为了性能考虑</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>

<blockquote>
<p>free # 可以通过这个命令查看swap是否关闭了 </p>
</blockquote>
<h3 id="1-6-同步时间-所有节点操作"><a href="#1-6-同步时间-所有节点操作" class="headerlink" title="1.6 同步时间 ( 所有节点操作 )"></a>1.6 同步时间 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h3 id="1-7-将桥接的IPv4流量传递到iptables的链-所有节点操作"><a href="#1-7-将桥接的IPv4流量传递到iptables的链-所有节点操作" class="headerlink" title="1.7 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )"></a>1.7 将桥接的IPv4流量传递到iptables的链 ( 所有节点操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 加载配置文件</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="1-8-添加主机名与IP对应的关系-master操作"><a href="#1-8-添加主机名与IP对应的关系-master操作" class="headerlink" title="1.8 添加主机名与IP对应的关系 ( master操作 )"></a>1.8 添加主机名与IP对应的关系 ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF </span><br><span class="line">192.168.2.20 master</span><br><span class="line">192.168.2.21 node1</span><br><span class="line">192.168.2.22 node2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="2-cfssl证书-master操作"><a href="#2-cfssl证书-master操作" class="headerlink" title="2  cfssl证书  (master操作)"></a>2  cfssl证书  (master操作)</h2><h3 id="2-1-下载文件"><a href="#2-1-下载文件" class="headerlink" title="2.1 下载文件"></a>2.1 下载文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 安装wget </span><br><span class="line">yum -y install wget </span><br><span class="line"># 下载cfssl工具：</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 </span><br><span class="line"># 添加执行权限</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64 </span><br><span class="line"># 移动配置文件</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>若wget失败验证失败， 加 –no-check-certificate参数可解决</p>
</blockquote>
<h3 id="2-2-创建配置文件"><a href="#2-2-创建配置文件" class="headerlink" title="2.2 创建配置文件"></a>2.2 创建配置文件</h3><p>创建以下三个文件：</p>
<ol>
<li>ca-config.json  </li>
<li> ca-csr.json </li>
<li>server-csr.json</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ssl #创建一个目录来存放配置文件</span><br><span class="line">cd ssl </span><br></pre></td></tr></table></figure>

<p>ca-config.json  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;www&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>ca-csr.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd CA&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>server-csr.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;192.168.2.20&quot;,      </span><br><span class="line">    &quot;192.168.2.21&quot;,</span><br><span class="line">    &quot;192.168.2.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>etcd集群的ip地址<br>“hosts”:<br>   “192.168.2.20”,<br>   “192.168.2.21”,<br>   “192.168.2.22”</p>
</blockquote>
<h3 id="2-3-生成证书"><a href="#2-3-生成证书" class="headerlink" title="2.3 生成证书"></a>2.3 生成证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#生成证书：</span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">2021/09/25 23:56:21 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line"></span><br><span class="line">ls *pem</span><br><span class="line">ca-key.pem  ca.pem  server-key.pem  server.pem</span><br><span class="line">#四个.pem文件证书</span><br></pre></td></tr></table></figure>

<h2 id="3-部署etcd"><a href="#3-部署etcd" class="headerlink" title="3 部署etcd"></a>3 部署etcd</h2><h3 id="3-1-下载二进制包-master操作"><a href="#3-1-下载二进制包-master操作" class="headerlink" title="3.1 下载二进制包 ( master操作 )"></a>3.1 下载二进制包 ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#二进制包下载地址：</span><br><span class="line">https://github.com/etcd-io/etcd/releases/download/v3.2.12/etcd-v3.2.12-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="3-2-解压二进制包-master操作"><a href="#3-2-解压二进制包-master操作" class="headerlink" title="3.2  解压二进制包 ( master操作 )"></a>3.2  解压二进制包 ( master操作 )</h3><p>以下部署步骤在三个etcd节点操作一样，唯一不同的是etcd配置文件中的<strong>服务器IP要写当前本机</strong>的， 所以我们在master节点上配置，然后将配置文件复制到node节点上在修改名称和IP，这样方便一点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 解压二进制包：</span><br><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p   </span><br><span class="line">tar zxvf etcd-v3.2.12-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.2.12-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><p>/opt/etcd/bin 里面存放的是可执行文件 etcd 、 etcdctl</p>
</li>
<li><p>/opt/etcd/cfg 里面存放的是配置文件 etcd.conf </p>
</li>
<li><p>/opt/etcd/ssl  里面存放的是证书ca-key.pem 、 ca.pem 、server-key.pem 、server.pem</p>
</li>
</ul>
</blockquote>
<h3 id="3-3-配置etcd-conf-master操作"><a href="#3-3-配置etcd-conf-master操作" class="headerlink" title="3.3 配置etcd.conf  ( master操作 )"></a>3.3 配置etcd.conf  ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#创建etcd.conf配置文件：</span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd &lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd01&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.2.20:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.2.20:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.2.20:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.2.20:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.2.20:2380,etcd02=https://192.168.2.21:2380,etcd03=https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>ETCD_NAME 节点名称    （master 是etcd01 node1是etcd02 node2是etcd03）</li>
</ul>
<ul>
<li>ETCD_DATA_DIR 数据目录 （不用修改）</li>
<li>ETCD_LISTEN_PEER_URLS 集群通信监听地址   （修改为本机ip）</li>
<li>ETCD_LISTEN_CLIENT_URLS 客户端访问监听地址   （修改为本机ip）</li>
<li>ETCD_INITIAL_ADVERTISE_PEER_URLS 集群通告地址  （修改为本机ip）</li>
<li>ETCD_ADVERTISE_CLIENT_URLS 客户端通告地址    （修改为本机ip）</li>
<li>ETCD_INITIAL_CLUSTER 集群节点地址    （跟上面节点名称要一一对应）</li>
<li>ETCD_INITIAL_CLUSTER_TOKEN 集群Token</li>
<li>ETCD_INITIAL_CLUSTER_STATE （加入集群的当前状态，new是新集群，existing表示加入已有集群，因为我们是新创建的所以设置为new，否则用existing）</li>
</ul>
</blockquote>
<h3 id="3-4-配置etcd-service-master操作"><a href="#3-4-配置etcd-service-master操作" class="headerlink" title="3.4 配置etcd.service  ( master操作 )"></a>3.4 配置etcd.service  ( master操作 )</h3><p>三个节点相同</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># systemd管理etcd：（方便使用systemctl启动，而不是用一长串的绝对路径启动）</span><br><span class="line">rm -f /usr/lib/systemd/system/etcd.service</span><br><span class="line">vi /usr/lib/systemd/system/etcd.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="line">--name=$&#123;ETCD_NAME&#125; \</span><br><span class="line">--data-dir=$&#123;ETCD_DATA_DIR&#125; \</span><br><span class="line">--listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">--listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">--initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">--initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125; \</span><br><span class="line">--initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">--initial-cluster-state=new \</span><br><span class="line">--cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--peer-cert-file=/opt/etcd/ssl/server.pem \</span><br><span class="line">--peer-key-file=/opt/etcd/ssl/server-key.pem \</span><br><span class="line">--trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--enable-v2</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<blockquote>
<p>\ 为换行连接符，不可省略</p>
</blockquote>
<h3 id="3-5-拷贝证书-master操作"><a href="#3-5-拷贝证书-master操作" class="headerlink" title="3.5  拷贝证书  ( master操作 )"></a>3.5  拷贝证书  ( master操作 )</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 把刚才生成的证书拷贝到配置文件中的位置：（对应上面systemd管理中的路径）</span><br><span class="line">cp ~/ssl/ca*pem ~/ssl/server*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure>
<h3 id="3-6-将文件复制到node节点-master操作"><a href="#3-6-将文件复制到node节点-master操作" class="headerlink" title="3.6  将文件复制到node节点 ( master操作 )"></a>3.6  将文件复制到node节点 ( master操作 )</h3><p>主要有两个部分文件需要复制</p>
<ul>
<li> /opt/etcd/ 下面的文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 因为证书我们是在master上配置的，所以我们需要拷贝给所有node </span><br><span class="line">scp -r /opt/etcd/ root@192.168.2.21:/opt/ # 发送到node1</span><br><span class="line">scp -r /opt/etcd/ root@192.168.2.22:/opt/ # 发送到node2 </span><br></pre></td></tr></table></figure>
<ul>
<li> /usr/lib/systemd/system/etcd.service 文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.2.21:/usr/lib/systemd/system/</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service root@192.168.2.22:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>传送完成检查node节点上文件是否存在</p>
</blockquote>
<h3 id="3-7-修改node节点etcd-conf-中的名称和IP"><a href="#3-7-修改node节点etcd-conf-中的名称和IP" class="headerlink" title="3.7 修改node节点etcd.conf 中的名称和IP"></a>3.7 修改node节点etcd.conf 中的名称和IP</h3><ul>
<li> node1 操作</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/cfg/etcd&lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd02&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.2.21:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.2.21:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.2.21:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.2.21:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.2.20:2380,etcd02=https://192.168.2.21:2380,etcd03=https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改ETCD_NAME 和IP</p>
</blockquote>
<ul>
<li> node2 操作</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/etcd/cfg/etcd&lt;&lt; EOF</span><br><span class="line">#[Member]</span><br><span class="line">ETCD_NAME=&quot;etcd03&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.2.22:2379&quot;</span><br><span class="line">#[Clustering]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.2.22:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd01=https://192.168.2.20:2380,etcd02=https://192.168.2.21:2380,etcd03=https://192.168.2.22:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<h3 id="3-8-启动并设置开启启动："><a href="#3-8-启动并设置开启启动：" class="headerlink" title="3.8 启动并设置开启启动："></a>3.8 启动并设置开启启动：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl enable etcd</span><br></pre></td></tr></table></figure>

<h3 id="3-9-检查etcd集群状态："><a href="#3-9-检查etcd集群状态：" class="headerlink" title="3.9 检查etcd集群状态："></a>3.9 检查etcd集群状态：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 移动命令路径</span><br><span class="line">cp /opt/etcd/bin/etcdctl /bin </span><br><span class="line"># 配置etcdctl 3 环境变量</span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; endpoint status --write-out=table</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|         ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| https://192.168.2.20:2379 | 3ae8ea54109f8cad |  3.4.14 |   20 kB |      true |      false |        61 |         16 |                 16 |        |</span><br><span class="line">| https://192.168.2.21:2379 | cb408b517db6d952 |  3.4.14 |   20 kB |     false |      false |        61 |         16 |                 16 |        |</span><br><span class="line">| https://192.168.2.22:2379 | eca9a4bbb09d42e4 |  3.4.14 |   20 kB |     false |      false |        61 |         16 |                 16 |        |</span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; endpoint health</span><br><span class="line"># 用 etcd2 重新配置后查看集群状态</span><br><span class="line">ETCDCTL_API=2 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; cluster-health</span><br><span class="line"># 重新配置子网 删除原来的配置</span><br><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot;   del /coreos.com/network/config</span><br><span class="line"># 重新配置</span><br><span class="line">ETCDCTL_API=2 /opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=&quot;https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379&quot; set /coreos.com/network/config &#x27;&#123; &quot;Network&quot;: &quot;172.17.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-在work-node节点上安装docker"><a href="#4-在work-node节点上安装docker" class="headerlink" title="4 在work node节点上安装docker"></a>4 在work node节点上安装docker</h2><h3 id="4-1-node1-node2安装docker"><a href="#4-1-node1-node2安装docker" class="headerlink" title="4.1 node1 node2安装docker"></a>4.1 node1 node2安装docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 安装依赖库</span><br><span class="line">yum install -y yum-utils</span><br><span class="line"># 安装docker仓库</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 国外的仓库很慢，可以使用国内的镜像快一点</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"># 安装docker</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<h3 id="4-2-systemd-管理-docker"><a href="#4-2-systemd-管理-docker" class="headerlink" title="4.2 systemd 管理 docker"></a>4.2 systemd 管理 docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 启动</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>





<h2 id="5-kube-apiserver-（master操作）"><a href="#5-kube-apiserver-（master操作）" class="headerlink" title="5 kube-apiserver （master操作）"></a>5 kube-apiserver （master操作）</h2><h3 id="5-1-生成-kube-apiserver-需要的配置文件"><a href="#5-1-生成-kube-apiserver-需要的配置文件" class="headerlink" title="5.1 生成 kube-apiserver 需要的配置文件"></a>5.1 生成 kube-apiserver 需要的配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd TLS/k8s </span><br><span class="line">#保存 ca-config.json  ca-csr.json server-csr.json</span><br></pre></td></tr></table></figure>

<ul>
<li> 配置 ca-config.json</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">         &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">         &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 cca-csr.json</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 server-csr.json</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;10.0.0.1&quot;,</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;192.168.2.20&quot;,</span><br><span class="line">      &quot;192.168.2.21&quot;,</span><br><span class="line">      &quot;192.168.2.22&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-2-生成证书"><a href="#5-2-生成证书" class="headerlink" title="5.2 生成证书"></a>5.2 生成证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">ls *pem</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line">ls server*pem</span><br><span class="line"># 拷贝证书</span><br><span class="line">cp ~/k8s/ca*pem ~/k8s/server*pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure>



<h3 id="5-2-部署-kube-apiserver"><a href="#5-2-部署-kube-apiserver" class="headerlink" title="5.2 部署 kube apiserver"></a>5.2 部署 kube apiserver</h3><p>下载kubernetes-server-linux-amd64.tar.gz，包含了所需的所有组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG- 1.20.1.md#v1183</span><br></pre></td></tr></table></figure>

<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br><span class="line">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cd kubernetes/server/bin</span><br><span class="line"># 拷贝</span><br><span class="line">cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin</span><br><span class="line">cp kubectl /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="5-3-配置kube-apiserver-conf"><a href="#5-3-配置kube-apiserver-conf" class="headerlink" title="5.3 配置kube-apiserver.conf"></a>5.3 配置kube-apiserver.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--etcd-servers=https://192.168.2.20:2379,https://192.168.2.21:2379,https://192.168.2.22:2379 \\</span><br><span class="line">--bind-address=192.168.2.20 \\</span><br><span class="line">--secure-port=6443 \\</span><br><span class="line">--advertise-address=192.168.2.20 \\</span><br><span class="line">--allow-privileged=true \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\</span><br><span class="line">--authorization-mode=RBAC,Node \\</span><br><span class="line">--enable-bootstrap-token-auth=true \\</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span><br><span class="line">--service-node-port-range=30000-32767 \\</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--audit-log-maxage=30 \\</span><br><span class="line">--audit-log-maxbackup=3 \\</span><br><span class="line">--audit-log-maxsize=100 \\</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<blockquote>
<p>上面两个\ \ 第一个是转义符，第二个是换行符，使用转义符是为了使用 EOF 保留换 行符。</p>
<ul>
<li>logtostderr：启用日志</li>
<li>v：日志等级</li>
<li>log-dir：日志目录</li>
<li>etcd-servers：etcd 集群地址</li>
<li>bind-address：监听地址</li>
<li>secure-port：https 安全端口</li>
<li>advertise-address：集群通告地址</li>
<li>allow-privileged：启用授权</li>
<li>service-cluster-ip-range：Service 虚拟 IP 地址段</li>
<li>enable-admission-plugins：准入控制模块</li>
<li>authorization-mode：认证授权，启用 RBAC 授权和节点自管理</li>
<li>enable-bootstrap-token-auth：启用 TLS bootstrap 机制</li>
<li>token-auth-file：bootstrap token 文件</li>
<li>service-node-port-range：Service nodeport 类型默认分配端口范围</li>
<li>kubelet-client-xxx：apiserver 访问 kubelet 客户端证书</li>
<li>tls-xxx-file：apiserver https 证书</li>
<li>etcd-xxxfile：连接 Etcd 集群证书</li>
<li>audit-log-xxx：审计日志</li>
</ul>
</blockquote>
<h3 id="5-4-配置token-csv"><a href="#5-4-配置token-csv" class="headerlink" title="5.4 配置token.csv"></a>5.4 配置token.csv</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF</span><br><span class="line">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;</span><br><span class="line">a266c491e557753ef5d43e467c600d10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/profile&lt;&lt; EOF</span><br><span class="line">export KUBERNETES_MASTER=&quot;127.0.0.1:8080&quot;</span><br><span class="line">EOF</span><br><span class="line">保存退出</span><br><span class="line">source /etc/profile</span><br><span class="line">刷新环境变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-5-配置kube-apiserver-service"><a href="#5-5-配置kube-apiserver-service" class="headerlink" title="5.5 配置kube-apiserver.service"></a>5.5 配置kube-apiserver.service</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-6-设置自启动与启动"><a href="#5-6-设置自启动与启动" class="headerlink" title="5.6 设置自启动与启动"></a>5.6 设置自启动与启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl status kube-apiserver </span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">kube-apiserver.service - Kubernetes API Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 01:25:36 EDT; 48s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 10945 (kube-apiserver)</span><br><span class="line">   CGroup: /system.slice/kube-apiserver.service</span><br><span class="line">           └─10945 /opt/kubernetes/bin/kube-apiserver --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --etcd-servers=https://192.168.2.20:2379.</span><br></pre></td></tr></table></figure>

<h3 id="5-7-授权-kubelet-bootstrap-用户允许请求证书"><a href="#5-7-授权-kubelet-bootstrap-用户允许请求证书" class="headerlink" title="5.7 授权 kubelet-bootstrap 用户允许请求证书"></a>5.7 授权 kubelet-bootstrap 用户允许请求证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<h2 id="6-部署-kube-controller-manager（master操作）"><a href="#6-部署-kube-controller-manager（master操作）" class="headerlink" title="6 部署 kube-controller-manager（master操作）"></a>6 部署 kube-controller-manager（master操作）</h2><h3 id="6-1-配置kube-controller-manager-conf"><a href="#6-1-配置kube-controller-manager-conf" class="headerlink" title="6.1 配置kube-controller-manager.conf"></a>6.1 配置kube-controller-manager.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--leader-elect=true \\</span><br><span class="line">--master=127.0.0.1:8080 \\</span><br><span class="line">--bind-address=127.0.0.1 \\</span><br><span class="line">--allocate-node-cidrs=true \\</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \\</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \\</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">--experimental-cluster-signing-duration=87600h0m0s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-2-systemd-管理-controller-manager"><a href="#6-2-systemd-管理-controller-manager" class="headerlink" title="6.2 systemd 管理 controller-manager"></a>6.2 systemd 管理 controller-manager</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-3-设置kube-controller-manager的自启动并启动"><a href="#6-3-设置kube-controller-manager的自启动并启动" class="headerlink" title="6.3 设置kube-controller-manager的自启动并启动"></a>6.3 设置kube-controller-manager的自启动并启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 01:33:06 EDT; 137ms ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 11011 (kube-controller)</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─11011 /opt/kubernetes/bin/kube-controller-manager --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --leader-elect=true --master=12...</span><br><span class="line"></span><br><span class="line">Sep 27 01:33:06 master systemd[1]: Started Kubernetes Controller Manager.</span><br></pre></td></tr></table></figure>



<h2 id="7-部署-kube-scheduler（master操作）"><a href="#7-部署-kube-scheduler（master操作）" class="headerlink" title="7 部署 kube-scheduler（master操作）"></a>7 部署 kube-scheduler（master操作）</h2><h3 id="7-1-配置kube-scheduler-conf"><a href="#7-1-配置kube-scheduler-conf" class="headerlink" title="7.1 配置kube-scheduler.conf"></a>7.1 配置kube-scheduler.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--leader-elect \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--bind-address=127.0.0.1&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="7-2-配置-kube-scheduler-service"><a href="#7-2-配置-kube-scheduler-service" class="headerlink" title="7.2 配置 kube-scheduler.service"></a>7.2 配置 kube-scheduler.service</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="7-3-kube-scheduler自启动"><a href="#7-3-kube-scheduler自启动" class="headerlink" title="7.3 kube-scheduler自启动"></a>7.3 kube-scheduler自启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kube-scheduler.service - Kubernetes Scheduler</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 01:36:04 EDT; 123ms ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 11065 (kube-scheduler)</span><br><span class="line">   CGroup: /system.slice/kube-scheduler.service</span><br><span class="line">           └─11065 /opt/kubernetes/bin/kube-scheduler --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --leader-elect --master=127.0.0.1:8080 -...</span><br><span class="line">Sep 27 01:36:04 master systemd[1]: Started Kubernetes Scheduler.</span><br></pre></td></tr></table></figure>

<h3 id="7-4-查看集群状态"><a href="#7-4-查看集群状态" class="headerlink" title="7.4 查看集群状态"></a>7.4 查看集群状态</h3><p>master节点的组件已经部署完成，查看状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="8-部署work-node-的组件"><a href="#8-部署work-node-的组件" class="headerlink" title="8 部署work node 的组件"></a>8 部署work node 的组件</h2><p>这里我们在master上也部署node的组件，打上污点不使用，不影响</p>
<h3 id="8-1-拷贝文件"><a href="#8-1-拷贝文件" class="headerlink" title="8.1 拷贝文件"></a>8.1 拷贝文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125;</span><br><span class="line"># 从master拷贝需要的文件</span><br><span class="line">scp -r root@192.168.2.20:/root/kubernetes/server/bin/kubelet  /opt/kubernetes/bin</span><br><span class="line">scp -r root@192.168.2.20:/root/kubernetes/server/bin/kube-proxy  /opt/kubernetes/bin</span><br><span class="line">scp -r root@192.168.2.20:/root/kubernetes/server/bin/kubectl  /usr/bin/</span><br><span class="line">scp -r root@192.168.2.20:/opt/kubernetes/ssl  /opt/kubernetes</span><br></pre></td></tr></table></figure>

<h3 id="8-2-配置kubelet-conf"><a href="#8-2-配置kubelet-conf" class="headerlink" title="8.2 配置kubelet.conf"></a>8.2 配置kubelet.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=&quot;--logtostderr=tr \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--hostname-override=node1 \\</span><br><span class="line">--network-plugin=cni \\</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl \\</span><br><span class="line">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>hostname-override：显示名称，集群中唯一</li>
<li> network-plugin：启用CNI</li>
<li>kubeconfig：空路径，会自动生成，后面用于连接apiserver</li>
<li>bootstrap-kubeconfig：首次启动向apiserver申请证书</li>
<li>config：配置参数文件</li>
<li>cert-dir：kubelet证书生成目录</li>
<li>pod-infra-container-image：管理Pod网络容器的镜像</li>
</ul>
</blockquote>
<h3 id="8-3-配置kubelet-config-yml"><a href="#8-3-配置kubelet-config-yml" class="headerlink" title="8.3 配置kubelet-config.yml"></a>8.3 配置kubelet-config.yml</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 192.168.2.21</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.0.0.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-4-生成bootstrap-kubeconfig文件"><a href="#8-4-生成bootstrap-kubeconfig文件" class="headerlink" title="8.4 生成bootstrap.kubeconfig文件"></a>8.4 生成bootstrap.kubeconfig文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KUBE_APISERVER=&quot;https://192.168.2.20:6443&quot; # apiserver IP:PORT ?</span><br><span class="line">TOKEN=&quot;c47ffb939f5ca36231d9e3121a252940&quot; # 与token.csv里保持一致</span><br></pre></td></tr></table></figure>

<h3 id="8-5-生成-kubelet-bootstrap-kubeconfig-配置文件"><a href="#8-5-生成-kubelet-bootstrap-kubeconfig-配置文件" class="headerlink" title="8.5 生成 kubelet bootstrap kubeconfig 配置文件"></a>8.5 生成 kubelet bootstrap kubeconfig 配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">kubectl config set-credentials &quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --token=$&#123;TOKEN&#125; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=&quot;kubelet-bootstrap&quot; \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"># 拷贝</span><br><span class="line">mv bootstrap.kubeconfig /opt/kubernetes/cfg</span><br></pre></td></tr></table></figure>

<h3 id="8-6-systemd管理kubelet-service"><a href="#8-6-systemd管理kubelet-service" class="headerlink" title="8.6 systemd管理kubelet.service"></a>8.6 systemd管理kubelet.service</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-7-kubelet-启动"><a href="#8-7-kubelet-启动" class="headerlink" title="8.7 kubelet 启动"></a>8.7 kubelet 启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enabel kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl status kubelet</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kubelet.service - Kubernetes Kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 02:26:01 EDT; 1min 18s ago</span><br><span class="line"> Main PID: 26821 (kubelet)</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─26821 /opt/kubernetes/bin/kubelet --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --hostname-override=m1 --network-plugin=cni ..</span><br><span class="line">Sep 27 02:26:01 node1 systemd[1]: Started Kubernetes Kubelet.</span><br></pre></td></tr></table></figure>

<h3 id="8-8-批准加入集群-（master操作）"><a href="#8-8-批准加入集群-（master操作）" class="headerlink" title="8.8 批准加入集群 （master操作）"></a>8.8 批准加入集群 （master操作）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查看kubelet证书请求 </span><br><span class="line">[root@master bin]# kubectl get csr</span><br><span class="line">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-JZLQ2x99c69eRpOjkzoxoDYi3NGF0t5PXEu8AQhkr8M   3m5s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line"># 批准请求</span><br><span class="line">[root@master bin]# kubectl certificate approve node-csr-JZLQ2x99c69eRpOjkzoxoDYi3NGF0t5PXEu8AQhkr8M</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-JZLQ2x99c69eRpOjkzoxoDYi3NGF0t5PXEu8AQhkr8M approved</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   NotReady    &lt;none&gt;   24m   v1.18.2</span><br></pre></td></tr></table></figure>



<h2 id="9-部署kube-proxy"><a href="#9-部署kube-proxy" class="headerlink" title="9 部署kube-proxy"></a>9 部署kube-proxy</h2><h3 id="9-1-kube-proxy-conf-node操作"><a href="#9-1-kube-proxy-conf-node操作" class="headerlink" title="9.1 kube-proxy.conf (node操作)"></a>9.1 kube-proxy.conf (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\</span><br><span class="line">--v=2 \\</span><br><span class="line">--log-dir=/opt/kubernetes/logs \\</span><br><span class="line">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="9-2-kube-proxy-config-yml-node操作"><a href="#9-2-kube-proxy-config-yml-node操作" class="headerlink" title="9.2 kube-proxy-config.yml (node操作)"></a>9.2 kube-proxy-config.yml (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: m1</span><br><span class="line">clusterCIDR: 10.0.0.0/24</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="9-3-生成证书-master操作"><a href="#9-3-生成证书-master操作" class="headerlink" title="9.3 生成证书 (master操作)"></a>9.3 生成证书 (master操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 因为cfssl安装在master上， 在master上生成证书发到nodo上</span><br><span class="line">cd /root/k8s</span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"></span><br><span class="line"># 拷贝到node </span><br><span class="line">scp -r /root/k8s root@192.168.2.21:/opt/ # node1</span><br><span class="line">scp -r /root/k8s root@192.168.2.22:/opt/ # node2 </span><br></pre></td></tr></table></figure>

<h3 id="9-4-生成kubeconfig-node操作"><a href="#9-4-生成kubeconfig-node操作" class="headerlink" title="9.4 生成kubeconfig  (node操作)"></a>9.4 生成kubeconfig  (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/k8s</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">cp kube-proxy.kubeconfig /opt/kubernetes/cfg/</span><br></pre></td></tr></table></figure>

<h3 id="9-5-配置kube-proxy-service-node操作"><a href="#9-5-配置kube-proxy-service-node操作" class="headerlink" title="9.5 配置kube-proxy.service (node操作)"></a>9.5 配置kube-proxy.service (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-6-kube-proxy启动-node操作"><a href="#9-6-kube-proxy启动-node操作" class="headerlink" title="9.6 kube-proxy启动 (node操作)"></a>9.6 kube-proxy启动 (node操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl enable kube-proxy</span><br><span class="line">systemctl status kube-proxy</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-proxy.service to /usr/lib/systemd/system/kube-proxy.service.</span><br><span class="line">[root@node1 k8s]# </span><br><span class="line">[root@node1 k8s]# systemctl status kube-proxy</span><br><span class="line">● kube-proxy.service - Kubernetes Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2021-09-27 03:19:53 EDT; 137ms ago</span><br><span class="line"> Main PID: 31089 (kube-proxy)</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           └─31089 /opt/kubernetes/bin/kube-proxy --logtostderr=false --v=2 --log-dir=/opt/kubernetes/logs --config=/opt/kubernetes/cfg/kube-proxy-c...</span><br><span class="line">Sep 27 03:19:53 node1 systemd[1]: Started Kubernetes Proxy.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="10-部署网络组件"><a href="#10-部署网络组件" class="headerlink" title="10 部署网络组件"></a>10 部署网络组件</h2><p>Calico是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#安装calico</span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line">#列出“kube-system”命名空间下的所有pod</span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   28m   v1.18.2</span><br><span class="line">k8s-node1     Ready    &lt;none&gt;   13m   v1.18.2</span><br><span class="line">k8s-node2     Ready    &lt;none&gt;   14m   v1.18.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="授权-apiserver-访问-kubelet"><a href="#授权-apiserver-访问-kubelet" class="headerlink" title="授权 apiserver 访问 kubelet"></a>授权 apiserver 访问 kubelet</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">      - pods/log</span><br><span class="line">    verbs:</span><br><span class="line">      - &quot;*&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kubernetes</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>

<h2 id="11-新增加-Worker-Node"><a href="#11-新增加-Worker-Node" class="headerlink" title="11 新增加 Worker-Node"></a>11 新增加 Worker-Node</h2><h3 id="11-1-拷贝已部署好的Node相关文件到新节点"><a href="#11-1-拷贝已部署好的Node相关文件到新节点" class="headerlink" title="11.1 拷贝已部署好的Node相关文件到新节点"></a>11.1 拷贝已部署好的Node相关文件到新节点</h3><p>在Master节点中，将Worker Node涉及文件拷贝到另外2个节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#拷贝工作目录</span><br><span class="line">scp -r /opt/kubernetes root@192.168.200.201:/opt/</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#拷贝配置文件</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.200.201:/usr/lib/systemd/system</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#拷贝证书文件</span><br><span class="line">scp /opt/kubernetes/ssl/ca.pem root@192.168.200.201:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#对node2机器同样执行一遍</span><br><span class="line">scp -r /opt/kubernetes root@192.168.200.202:/opt/</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.200.202:/usr/lib/systemd/system</span><br><span class="line">scp /opt/kubernetes/ssl/ca.pem root@192.168.200.202:/opt/kubernetes/ssl</span><br></pre></td></tr></table></figure>

<h3 id="11-2-删除-kubelet-证书和-kubeconfig-文件"><a href="#11-2-删除-kubelet-证书和-kubeconfig-文件" class="headerlink" title="11.2 删除 kubelet 证书和 kubeconfig 文件"></a>11.2 删除 kubelet 证书和 kubeconfig 文件</h3><p>由于这几个文件是证书申请审批后自动生成的，每个Node不同，因此必须删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在node1、node2两个节点上分别执行如下命令</span><br><span class="line">rm -f /opt/kubernetes/cfg/kubelet.kubeconfig </span><br><span class="line">rm -f /opt/kubernetes/ssl/kubelet*</span><br></pre></td></tr></table></figure>

<h3 id="11-3-修改主机名"><a href="#11-3-修改主机名" class="headerlink" title="11.3 修改主机名"></a>11.3 修改主机名</h3><p>在两台机器上分别打开2个配置文件，并修改主机名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 修改node1 kubelet配置文件</span><br><span class="line">vi /opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">--hostname-override=k8s-node1</span><br><span class="line"># 或者sed -i直接替换</span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node1/g&quot; /opt/kubernetes/cfg/kubelet.conf  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#修改kube-proxy配置文件</span><br><span class="line">vi /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">hostnameOverride: k8s-node1</span><br><span class="line"># 或者sed -i直接替换</span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node1/g&quot; /opt/kubernetes/cfg/kube-proxy-config.yml</span><br></pre></td></tr></table></figure>

<p>node2操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node2/g&quot; /opt/kubernetes/cfg/kubelet.conf  </span><br><span class="line"># sed -i &quot;s/k8s-master1/k8s-node2/g&quot; /opt/kubernetes/cfg/kube-proxy-config.yml</span><br></pre></td></tr></table></figure>



<h3 id="11-4-启动并设置开机启动"><a href="#11-4-启动并设置开机启动" class="headerlink" title="11.4 启动并设置开机启动"></a>11.4 启动并设置开机启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet kube-proxy</span><br><span class="line">systemctl enable kubelet kube-proxy</span><br><span class="line">systemctl status kubelet kube-proxy</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">● kube-proxy.service - Kubernetes Proxy</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2021-09-28 06:14:10 EDT; 40min ago</span><br><span class="line"> Main PID: 3279 (kube-proxy)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   Memory: 12.3M</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           └─3279 /opt/kubernetes/bin/kube-proxy --logtostderr=false --v=2 --log-...</span><br><span class="line"></span><br><span class="line">Sep 28 06:14:10 k8s-master1 systemd[1]: Started Kubernetes Proxy.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="11-5-在Master上批准新的Node-kubelet证书申请"><a href="#11-5-在Master上批准新的Node-kubelet证书申请" class="headerlink" title="11.5 在Master上批准新的Node kubelet证书申请"></a>11.5 在Master上批准新的Node kubelet证书申请</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 先查看证书请求：</span><br><span class="line">kubectl get csr </span><br><span class="line">在两台node机器上分别执行完前4步操作之后（node节点中启动kubelet后就会有请求信息），查</span><br><span class="line"></span><br><span class="line">#授权ndoe1</span><br><span class="line">kubectl certificate approve node-csr-MYWfZXy8o2n8Gb6dZ-fVKw1qVFkmgEkSFdg7m1VL56w</span><br><span class="line">#授权node2</span><br><span class="line">kubectl certificate approve node-csr-XAp5v8JU6qlAkDwzXPiN0DkJ9xlqsq4KbMekUFqBwKM</span><br></pre></td></tr></table></figure>
<h3 id="11-6：查看Node状态"><a href="#11-6：查看Node状态" class="headerlink" title="11.6：查看Node状态"></a>11.6：查看Node状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   45m   v1.18.2</span><br><span class="line">k8s-node1     Ready    &lt;none&gt;   30m   v1.18.2</span><br><span class="line">k8s-node2     Ready    &lt;none&gt;   31m   v1.18.2</span><br></pre></td></tr></table></figure>

<h2 id="12-测试kubernetes集群"><a href="#12-测试kubernetes集群" class="headerlink" title="12 测试kubernetes集群"></a>12 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>
<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/27/2021-09-27-k8s%E9%85%8D%E7%BD%AEflannel%E7%BD%91%E7%BB%9C/" rel="prev" title="配置flannel">
                  <i class="fa fa-chevron-left"></i> 配置flannel
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/09/30/2021-09-30-%E3%80%8A%E7%BE%8E%E4%B8%BD%E6%96%B0%E4%B8%96%E7%95%8C%E3%80%8B/" rel="next" title="《美丽新世界》">
                  《美丽新世界》 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuanwanli</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
